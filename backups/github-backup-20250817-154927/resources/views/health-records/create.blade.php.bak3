@extends('layouts.app')

@section('title', 'Nouveau Dossier M√©dical - Med Predictor')

@push('scripts')
<!-- Vue.js for Postural Assessment Component -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
@endpush

<style>
/* Dental Chart Styles */
.dental-chart-container {
    position: relative;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.chart-header {
    margin-bottom: 20px;
}

.chart-wrapper {
    display: flex;
    justify-content: center;
    margin: 20px 0;
    overflow-x: auto;
}

.dental-svg-container {
    position: relative;
    min-width: 800px;
}

.dental-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    white-space: nowrap;
    z-index: 1000;
    display: none;
}

.tooltip-content {
    line-height: 1.4;
}

/* SVG Styles */
.tooth {
    cursor: pointer;
    transition: all 0.2s ease;
}

.tooth:hover {
    opacity: 0.8;
}

.tooth-surface {
    cursor: pointer;
    transition: fill 0.2s ease;
}

.status-healthy {
    fill: #ffffff;
    stroke: #cccccc;
}

.status-caries {
    fill: #ff4d4d;
    stroke: #cc0000;
}

.status-restoration {
    fill: #4d94ff;
    stroke: #0066cc;
}

.status-crown {
    stroke: #4d94ff;
    stroke-width: 3px;
    fill-opacity: 0.1;
}

.status-missing {
    fill: #808080;
    opacity: 0.5;
}
</style>

@section('content')
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">üè• Nouvelle Visite M√©dicale</h1>
            <p class="text-gray-600 mt-2">Enregistrer une nouvelle visite m√©dicale - les donn√©es seront ajout√©es au dossier existant du joueur</p>
        </div>

        <form action="{{ route('health-records.store') }}" method="POST" class="space-y-8">
            @csrf
            
            @if($visit)
                <input type="hidden" name="visit_id" value="{{ $visit->id }}">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">üè• Visite Associ√©e</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-blue-800">Athl√®te:</span>
                            <span class="text-blue-700">{{ $visit->athlete->name ?? 'N/A' }}</span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-800">Date de visite:</span>
                            <span class="text-blue-700">{{ $visit->visit_date->format('d/m/Y H:i') }}</span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-800">Type:</span>
                            <span class="text-blue-700">{{ ucfirst(str_replace('_', ' ', $visit->visit_type)) }}</span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-800">M√©decin:</span>
                            <span class="text-blue-700">{{ $visit->doctor->name ?? 'Non assign√©' }}</span>
                        </div>
                        @if($visit->administrative_data && isset($visit->administrative_data['complaint_data']))
                        <div class="md:col-span-2">
                            <span class="font-medium text-blue-800">Motif de consultation:</span>
                            <span class="text-blue-700">{{ $visit->administrative_data['complaint_data']['complaint'] ?? 'Non sp√©cifi√©' }}</span>
                        </div>
                        @endif
                    </div>
                </div>
            @endif
            
            <!-- AI-Assisted Section -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <h2 class="text-xl font-semibold text-blue-900">Assistant IA M√©dical</h2>
                </div>
                <p class="text-blue-700 mb-4">D√©crivez les sympt√¥mes et observations cliniques pour une analyse automatique</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="clinical_notes" class="block text-sm font-medium text-gray-700 mb-2">
                            Notes Cliniques
                        </label>
                        <textarea 
                            id="clinical_notes" 
                            name="clinical_notes" 
                            rows="4" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Exemple: Patient se plaint de douleurs thoraciques depuis 2 jours, tension art√©rielle 140/90, fr√©quence cardiaque 85 bpm. Pas d'essoufflement ni de vertiges..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button 
                            type="button" 
                            id="ai-analyze-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                        >
                            üîç Analyser avec l'IA
                        </button>
                        <button 
                            type="button" 
                            id="clear-notes-btn"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
                        >
                            Effacer
                        </button>
                    </div>
                    
                    <div id="ai-results" class="hidden bg-white border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Analyse IA</h3>
                        <div id="ai-content" class="text-sm text-gray-700"></div>
                    </div>
                </div>
            </div>

            <!-- Patient Information -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Informations du Patient</h2>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- Player Selection -->
                    <div>
                        <label for="player_id" class="block text-sm font-medium text-gray-700 mb-2">
                            Joueur *
                        </label>
                        <select 
                            id="player_id" 
                            name="player_id" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="">S√©lectionner un joueur</option>
                            @foreach($players as $player)
                                <option value="{{ $player->id }}" {{ old('player_id') == $player->id ? 'selected' : '' }}>
                                    {{ $player->name }} ({{ $player->club->name ?? 'N/A' }})
                                </option>
                            @endforeach
                        </select>
                    </div>

                    <!-- EMR Visit Information -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="visit_date" class="block text-sm font-medium text-gray-700 mb-2">
                                Date de Visite *
                            </label>
                            <input 
                                type="date" 
                                id="visit_date" 
                                name="visit_date" 
                                value="{{ old('visit_date', date('Y-m-d')) }}"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="doctor_name" class="block text-sm font-medium text-gray-700 mb-2">
                                M√©decin *
                            </label>
                            <input 
                                type="text" 
                                id="doctor_name" 
                                name="doctor_name" 
                                value="{{ old('doctor_name') }}"
                                required
                                placeholder="Nom du m√©decin"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="visit_type" class="block text-sm font-medium text-gray-700 mb-2">
                                Type de Visite *
                            </label>
                            <select 
                                id="visit_type" 
                                name="visit_type" 
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">S√©lectionner le type</option>
                                <option value="consultation" {{ old('visit_type') == 'consultation' ? 'selected' : '' }}>Consultation</option>
                                <option value="emergency" {{ old('visit_type') == 'emergency' ? 'selected' : '' }}>Urgence</option>
                                <option value="follow_up" {{ old('visit_type') == 'follow_up' ? 'selected' : '' }}>Suivi</option>
                                <option value="pre_season" {{ old('visit_type') == 'pre_season' ? 'selected' : '' }}>Pr√©-saison</option>
                                <option value="post_match" {{ old('visit_type') == 'post_match' ? 'selected' : '' }}>Post-match</option>
                                <option value="rehabilitation" {{ old('visit_type') == 'rehabilitation' ? 'selected' : '' }}>R√©√©ducation</option>
                            </select>
                        </div>
                    </div>

                    <!-- Chief Complaint -->
                    <div>
                        <label for="chief_complaint" class="block text-sm font-medium text-gray-700 mb-2">
                            Motif de Consultation
                        </label>
                        <textarea 
                            id="chief_complaint" 
                            name="chief_complaint" 
                            rows="3"
                            placeholder="D√©crivez le motif principal de la consultation..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >{{ old('chief_complaint') }}</textarea>
                    </div>

                    <!-- Vital Signs -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="blood_pressure_systolic" class="block text-sm font-medium text-gray-700 mb-2">
                                Tension Systolique (mmHg)
                            </label>
                            <input 
                                type="number" 
                                id="blood_pressure_systolic" 
                                name="blood_pressure_systolic" 
                                value="{{ old('blood_pressure_systolic') }}"
                                min="70" max="200"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="blood_pressure_diastolic" class="block text-sm font-medium text-gray-700 mb-2">
                                Tension Diastolique (mmHg)
                            </label>
                            <input 
                                type="number" 
                                id="blood_pressure_diastolic" 
                                name="blood_pressure_diastolic" 
                                value="{{ old('blood_pressure_diastolic') }}"
                                min="40" max="130"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="heart_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                Fr√©quence Cardiaque (bpm)
                            </label>
                            <input 
                                type="number" 
                                id="heart_rate" 
                                name="heart_rate" 
                                value="{{ old('heart_rate') }}"
                                min="40" max="200"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                    </div>

                    <!-- Physical Measurements -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div>
                            <label for="temperature" class="block text-sm font-medium text-gray-700 mb-2">
                                Temp√©rature (¬∞C)
                            </label>
                            <input 
                                type="number" 
                                id="temperature" 
                                name="temperature" 
                                value="{{ old('temperature') }}"
                                min="35" max="42" step="0.1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700 mb-2">
                                Poids (kg)
                            </label>
                            <input 
                                type="number" 
                                id="weight" 
                                name="weight" 
                                value="{{ old('weight') }}"
                                min="30" max="200" step="0.1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-700 mb-2">
                                Taille (cm)
                            </label>
                            <input 
                                type="number" 
                                id="height" 
                                name="height" 
                                value="{{ old('height') }}"
                                min="100" max="250"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="blood_type" class="block text-sm font-medium text-gray-700 mb-2">
                                Groupe Sanguin
                            </label>
                            <select 
                                id="blood_type" 
                                name="blood_type"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">S√©lectionner</option>
                                <option value="A+" {{ old('blood_type') == 'A+' ? 'selected' : '' }}>A+</option>
                                <option value="A-" {{ old('blood_type') == 'A-' ? 'selected' : '' }}>A-</option>
                                <option value="B+" {{ old('blood_type') == 'B+' ? 'selected' : '' }}>B+</option>
                                <option value="B-" {{ old('blood_type') == 'B-' ? 'selected' : '' }}>B-</option>
                                <option value="AB+" {{ old('blood_type') == 'AB+' ? 'selected' : '' }}>AB+</option>
                                <option value="AB-" {{ old('blood_type') == 'AB-' ? 'selected' : '' }}>AB-</option>
                                <option value="O+" {{ old('blood_type') == 'O+' ? 'selected' : '' }}>O+</option>
                                <option value="O-" {{ old('blood_type') == 'O-' ? 'selected' : '' }}>O-</option>
                            </select>
                        </div>
                    </div>

                    <!-- Medical Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="allergies" class="block text-sm font-medium text-gray-700 mb-2">
                                üö® Allergies (WHO/IUIS Nomenclature)
                            </label>
                            <select id="allergies" name="allergies[]" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" size="6">
                                <option value="">-- Aucune allergie connue --</option>
                                <optgroup label="üçΩÔ∏è Allerg√®nes Alimentaires (WHO/IUIS)">
                                    <option value="f1">f1 - Egg white (Ovalbumin)</option>
                                    <option value="f2">f2 - Milk (Casein)</option>
                                    <option value="f3">f3 - Fish (Cod)</option>
                                    <option value="f4">f4 - Wheat (Gluten)</option>
                                    <option value="f5">f5 - Peanut (Arachis hypogaea)</option>
                                    <option value="f6">f6 - Soybean (Glycine max)</option>
                                    <option value="f7">f7 - Apple (Malus domestica)</option>
                                    <option value="f8">f8 - Almond (Prunus dulcis)</option>
                                    <option value="f9">f9 - Walnut (Juglans regia)</option>
                                    <option value="f10">f10 - Hazelnut (Corylus avellana)</option>
                                </optgroup>
                                <optgroup label="üå¨Ô∏è Allerg√®nes Inhal√©s (WHO/IUIS)">
                                    <option value="d1">d1 - House dust mite (Dermatophagoides pteronyssinus)</option>
                                    <option value="d2">d2 - House dust mite (Dermatophagoides farinae)</option>
                                    <option value="d3">d3 - Storage mite (Blomia tropicalis)</option>
                                </optgroup>
                                <optgroup label="ÔøΩÔøΩ Allerg√®nes Polliniques (WHO/IUIS)">
                                    <option value="g1">g1 - Bermuda grass (Cynodon dactylon)</option>
                                    <option value="g2">g2 - Timothy grass (Phleum pratense)</option>
                                    <option value="g3">g3 - Kentucky bluegrass (Poa pratensis)</option>
                                </optgroup>
                                <optgroup label="üêï Allerg√®nes Animaux (WHO/IUIS)">
                                    <option value="e1">e1 - Cat (Felis domesticus)</option>
                                    <option value="e2">e2 - Dog (Canis familiaris)</option>
                                    <option value="e3">e3 - Horse (Equus caballus)</option>
                                </optgroup>
                                <optgroup label="üêù Allerg√®nes d'Insectes (WHO/IUIS)">
                                    <option value="i1">i1 - Honey bee (Apis mellifera)</option>
                                    <option value="i2">i2 - Yellow jacket (Vespula germanica)</option>
                                    <option value="i3">i3 - White-faced hornet (Dolichovespula maculata)</option>
                                </optgroup>
                                <optgroup label="üíä Allerg√®nes M√©dicamenteux (WHO/IUIS)">
                                    <option value="m1">m1 - Penicillin G (Benzylpenicillin)</option>
                                    <option value="m2">m2 - Penicillin V (Phenoxymethylpenicillin)</option>
                                    <option value="m3">m3 - Ampicillin</option>
                                </optgroup>
                                <optgroup label="üß§ Allerg√®nes Latex (WHO/IUIS)">
                                    <option value="k1">k1 - Latex (Hevea brasiliensis)</option>
                                    <option value="k2">k2 - Latex (Hevea brasiliensis) - Hev b 1</option>
                                    <option value="k3">k3 - Latex (Hevea brasiliensis) - Hev b 2</option>
                                </optgroup>
                                <optgroup label="üçÑ Allerg√®nes de Moisissures (WHO/IUIS)">
                                    <option value="m1">m1 - Alternaria alternata</option>
                                    <option value="m2">m2 - Aspergillus fumigatus</option>
                                    <option value="m3">m3 - Aspergillus niger</option>
                                </optgroup>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs allergies</p>
                        </div>                        
                        <div>
                            <label for="medications" class="block text-sm font-medium text-gray-700 mb-2">
                                M√©dicaments Actuels
                            </label>
                            <textarea 
                                id="medications" 
                                name="medications" 
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="M√©dicaments en cours..."
                            >{{ old('medications') }}</textarea>
                        </div>
                    </div>

                    <!-- Medical History and Symptoms -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="medical_history" class="block text-sm font-medium text-gray-700 mb-2">
                                Ant√©c√©dents M√©dicaux
                            </label>
                            <textarea 
                                id="medical_history" 
                                name="medical_history" 
                                rows="4"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Ant√©c√©dents m√©dicaux importants..."
                            >{{ old('medical_history') }}</textarea>
                        </div>
                        
                        <div>
                            <label for="symptoms" class="block text-sm font-medium text-gray-700 mb-2">
                                Sympt√¥mes Actuels
                            </label>
                            <textarea 
                                id="symptoms" 
                                name="symptoms" 
                                rows="4"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Sympt√¥mes rapport√©s par le patient..."
                            >{{ old('symptoms') }}</textarea>
                        </div>
                    </div>

                    <!-- Comprehensive Medical Categories Section -->
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="text-lg font-semibold text-purple-900">üè• Cat√©gories M√©dicales Compl√®tes</h3>
                        </div>
                        <p class="text-purple-700 mb-4">Dossiers m√©dicaux conformes aux standards HL7, ICD-10, SNOMED CT, LOINC</p>
                        
                        <!-- Illness & Heart Diseases -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="icd_10_primary_diagnosis" class="block text-sm font-medium text-gray-700 mb-2">
                                    ü¶† Maladies G√©n√©rales (ICD-10: Z00-Z99, A00-B99, C00-D49, E00-E89, F00-F99, G00-G99)
                                </label>
                                <select 
                                    id="icd_10_primary_diagnosis" 
                                    name="icd_10_primary_diagnosis"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                >
                                    <option value="">S√©lectionner une maladie...</option>
                                    <optgroup label="Z00-Z99 - Facteurs influen√ßant l'√©tat de sant√©">
                                        <option value="Z00.0">Z00.0 - Examen m√©dical g√©n√©ral</option>
                                        <option value="Z00.1">Z00.1 - Examen de routine de l'enfant</option>
                                        <option value="Z00.2">Z00.2 - Examen de routine pendant la croissance</option>
                                        <option value="Z00.8">Z00.8 - Autres examens m√©dicaux g√©n√©raux</option>
                                    </optgroup>
                                    <optgroup label="A00-B99 - Maladies infectieuses">
                                        <option value="A00.0">A00.0 - Chol√©ra d√ª √† Vibrio cholerae 01, biovar cholerae</option>
                                        <option value="A01.0">A01.0 - Fi√®vre typho√Øde</option>
                                        <option value="A02.0">A02.0 - Salmonellose ent√©rique</option>
                                    </optgroup>
                                    <optgroup label="C00-D49 - Tumeurs">
                                        <option value="C00.0">C00.0 - Tumeur maligne de la l√®vre sup√©rieure</option>
                                        <option value="C01">C01 - Tumeur maligne de la base de la langue</option>
                                        <option value="C02.0">C02.0 - Tumeur maligne de la face dorsale de la langue</option>
                                    </optgroup>
                                    <optgroup label="E00-E89 - Maladies endocriniennes">
                                        <option value="E00.0">E00.0 - Syndrome cong√©nital d'iodod√©ficience</option>
                                        <option value="E01.0">E01.0 - Goitre diffus (end√©mique) d√ª √† une carence en iode</option>
                                        <option value="E02">E02 - Hypothyro√Ødie subclinique due √† une carence en iode</option>
                                    </optgroup>
                                    <optgroup label="F00-F99 - Troubles mentaux">
                                        <option value="F00.0">F00.0 - D√©mence de type Alzheimer √† d√©but pr√©coce</option>
                                        <option value="F01.0">F01.0 - D√©mence vasculaire √† d√©but aigu</option>
                                        <option value="F02.0">F02.0 - D√©mence dans la maladie de Pick</option>
                                    </optgroup>
                                    <optgroup label="G00-G99 - Maladies du syst√®me nerveux">
                                        <option value="G00.0">G00.0 - M√©ningite √† Haemophilus</option>
                                        <option value="G01">G01 - M√©ningite dans les maladies bact√©riennes class√©es ailleurs</option>
                                        <option value="G02.0">G02.0 - M√©ningite dans les maladies virales class√©es ailleurs</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div>
                                <label for="icd_10_cardiac" class="block text-sm font-medium text-gray-700 mb-2">
                                    ‚ù§Ô∏è Maladies Cardiaques (ICD-10: I00-I99, SNOMED CT: 22298006)
                                </label>
                                <select 
                                    id="icd_10_cardiac" 
                                    name="icd_10_cardiac"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                >
                                    <option value="">S√©lectionner une pathologie cardiaque...</option>
                                    <optgroup label="I00-I02 - Rhumatisme articulaire aigu">
                                        <option value="I00">I00 - Rhumatisme articulaire aigu sans mention d'atteinte cardiaque</option>
                                        <option value="I01.0">I01.0 - P√©ricardite rhumatismale aigu√´</option>
                                        <option value="I01.1">I01.1 - Endocardite rhumatismale aigu√´</option>
                                        <option value="I01.2">I01.2 - Myocardite rhumatismale aigu√´</option>
                                    </optgroup>
                                    <optgroup label="I05-I09 - Cardiopathies rhumatismales chroniques">
                                        <option value="I05.0">I05.0 - St√©nose mitrale</option>
                                        <option value="I05.1">I05.1 - Insuffisance mitrale rhumatismale</option>
                                        <option value="I05.2">I05.2 - St√©nose mitrale avec insuffisance</option>
                                        <option value="I06.0">I06.0 - St√©nose aortique rhumatismale</option>
                                        <option value="I06.1">I06.1 - Insuffisance aortique rhumatismale</option>
                                        <option value="I06.2">I06.2 - St√©nose aortique avec insuffisance</option>
                                    </optgroup>
                                    <optgroup label="I10-I15 - Maladies hypertensives">
                                        <option value="I10">I10 - Hypertension essentielle (primitive)</option>
                                        <option value="I11.0">I11.0 - Insuffisance cardiaque hypertensive avec d√©faillance ventriculaire gauche</option>
                                        <option value="I11.9">I11.9 - Insuffisance cardiaque hypertensive sans d√©faillance ventriculaire gauche</option>
                                    </optgroup>
                                    <optgroup label="I20-I25 - Cardiopathies isch√©miques">
                                        <option value="I20.0">I20.0 - Angine de poitrine instable</option>
                                        <option value="I20.1">I20.1 - Angine de poitrine avec spasme document√©</option>
                                        <option value="I20.8">I20.8 - Autres formes d'angine de poitrine</option>
                                        <option value="I20.9">I20.9 - Angine de poitrine, sans pr√©cision</option>
                                        <option value="I21.0">I21.0 - Infarctus transmural de la paroi ant√©rieure</option>
                                        <option value="I21.1">I21.1 - Infarctus transmural de la paroi inf√©rieure</option>
                                        <option value="I21.2">I21.2 - Infarctus transmural d'autres parois</option>
                                        <option value="I21.3">I21.3 - Infarctus transmural sans pr√©cision de localisation</option>
                                        <option value="I21.4">I21.4 - Infarctus sous-endocardique</option>
                                        <option value="I21.9">I21.9 - Infarctus aigu du myocarde, sans pr√©cision</option>
                                    </optgroup>
                                    <optgroup label="I30-I52 - Autres cardiopathies">
                                        <option value="I30.0">I30.0 - P√©ricardite aigu√´ idiopathique</option>
                                        <option value="I30.1">I30.1 - P√©ricardite infectieuse</option>
                                        <option value="I30.8">I30.8 - Autres formes de p√©ricardite aigu√´</option>
                                        <option value="I30.9">I30.9 - P√©ricardite aigu√´, sans pr√©cision</option>
                                        <option value="I31.0">I31.0 - P√©ricardite chronique adh√©sive</option>
                                        <option value="I31.1">I31.1 - P√©ricardite chronique constrictive</option>
                                        <option value="I31.2">I31.2 - H√©mop√©ricarde, non class√© ailleurs</option>
                                        <option value="I31.8">I31.8 - Autres maladies p√©ricardiques chroniques</option>
                                        <option value="I31.9">I31.9 - Maladie p√©ricardique chronique, sans pr√©cision</option>
                                        <option value="I32.0">I32.0 - P√©ricardite dans des maladies bact√©riennes class√©es ailleurs</option>
                                        <option value="I32.1">I32.1 - P√©ricardite dans d'autres maladies infectieuses et parasitaires class√©es ailleurs</option>
                                        <option value="I32.8">I32.8 - P√©ricardite dans d'autres maladies class√©es ailleurs</option>
                                    </optgroup>
                                    <optgroup label="I60-I69 - Maladies c√©r√©brovasculaires">
                                        <option value="I60.0">I60.0 - H√©morragie sous-arachno√Ødienne de l'art√®re carotide siphon et bifurcation</option>
                                        <option value="I60.1">I60.1 - H√©morragie sous-arachno√Ødienne de l'art√®re c√©r√©brale moyenne</option>
                                        <option value="I60.2">I60.2 - H√©morragie sous-arachno√Ødienne de l'art√®re communicante ant√©rieure</option>
                                        <option value="I60.3">I60.3 - H√©morragie sous-arachno√Ødienne de l'art√®re communicante post√©rieure</option>
                                        <option value="I60.4">I60.4 - H√©morragie sous-arachno√Ødienne de l'art√®re basilaire</option>
                                        <option value="I60.5">I60.5 - H√©morragie sous-arachno√Ødienne de l'art√®re vert√©brale</option>
                                        <option value="I60.6">I60.6 - H√©morragie sous-arachno√Ødienne d'autres art√®res intracr√¢niennes</option>
                                        <option value="I60.7">I60.7 - H√©morragie sous-arachno√Ødienne d'art√®re intracr√¢nienne, sans pr√©cision</option>
                                        <option value="I60.8">I60.8 - Autres h√©morragies sous-arachno√Ødiennes</option>
                                        <option value="I60.9">I60.9 - H√©morragie sous-arachno√Ødienne, sans pr√©cision</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- Doping Control & AUT -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="loinc_doping_panel" class="block text-sm font-medium text-gray-700 mb-2">
                                    üß™ Contr√¥le Anti-Dopage (LOINC: 11556-8, 11557-6)
                                </label>
                                <select 
                                    id="loinc_doping_panel" 
                                    name="loinc_doping_panel"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    onchange="updateDopingResultFields()"
                                >
                                    <option value="">S√©lectionner un test anti-dopage...</option>
                                    <optgroup label="LOINC 11556-8 - Panel de substances interdites">
                                        <option value="11556-8">11556-8 - Panel de substances interdites - Urine</option>
                                        <option value="11557-6">11557-6 - Panel de substances interdites - Sang</option>
                                        <option value="11558-4">11558-4 - Panel de substances interdites - Salive</option>
                                    </optgroup>
                                    <optgroup label="St√©ro√Ødes anabolisants (LOINC 11559-2)">
                                        <option value="LOINC_11559-2_TEST">Testost√©rone (Ratio T/E)</option>
                                        <option value="LOINC_11559-2_NAND">Nandrolone (19-NA)</option>
                                        <option value="LOINC_11559-2_STAN">Stanozolol</option>
                                        <option value="LOINC_11559-2_METH">M√©thandi√©none</option>
                                        <option value="LOINC_11559-2_DECA">D√©canate de nandrolone</option>
                                        <option value="LOINC_11559-2_BOLD">Bold√©none</option>
                                        <option value="LOINC_11559-2_TREN">Trenbolone</option>
                                        <option value="LOINC_11559-2_OXAN">Oxandrolone</option>
                                    </optgroup>
                                    <optgroup label="Hormones peptidiques (LOINC 11560-0)">
                                        <option value="LOINC_11560-0_GH">Hormone de croissance (GH)</option>
                                        <option value="LOINC_11560-0_IGF">IGF-1 (Insulin-like Growth Factor)</option>
                                        <option value="LOINC_11560-0_EPO">√ârythropo√Ø√©tine (EPO)</option>
                                        <option value="LOINC_11560-0_HCG">Gonadotrophine chorionique (hCG)</option>
                                        <option value="LOINC_11560-0_LH">Hormone lut√©inisante (LH)</option>
                                        <option value="LOINC_11560-0_FSH">Hormone folliculo-stimulante (FSH)</option>
                                        <option value="LOINC_11560-0_ACTH">ACTH (Hormone adr√©nocorticotrope)</option>
                                        <option value="LOINC_11560-0_TSH">TSH (Hormone thyr√©ostimulante)</option>
                                    </optgroup>
                                    <optgroup label="B√™ta-2 agonistes (LOINC 11561-8)">
                                        <option value="LOINC_11561-8_SALB">Salbutamol</option>
                                        <option value="LOINC_11561-8_TERB">Terbutaline</option>
                                        <option value="LOINC_11561-8_FORM">Formot√©rol</option>
                                        <option value="LOINC_11561-8_SALM">Salm√©t√©rol</option>
                                        <option value="LOINC_11561-8_CLEN">Clenbut√©rol</option>
                                        <option value="LOINC_11561-8_FENO">F√©not√©rol</option>
                                    </optgroup>
                                    <optgroup label="Diur√©tiques (LOINC 11562-6)">
                                        <option value="LOINC_11562-6_FURO">Furos√©mide</option>
                                        <option value="LOINC_11562-6_HCTZ">Hydrochlorothiazide</option>
                                        <option value="LOINC_11562-6_SPIR">Spironolactone</option>
                                        <option value="LOINC_11562-6_AMIL">Amiloride</option>
                                        <option value="LOINC_11562-6_TRIAM">Triamt√©r√®ne</option>
                                        <option value="LOINC_11562-6_CHLOR">Chlortalidone</option>
                                    </optgroup>
                                    <optgroup label="Stimulants (LOINC 11564-2)">
                                        <option value="LOINC_11564-2_AMPH">Amph√©tamines</option>
                                        <option value="LOINC_11564-2_METH">M√©thamph√©tamine</option>
                                        <option value="LOINC_11564-2_EPHE">√âph√©drine</option>
                                        <option value="LOINC_11564-2_PSEU">Pseudo√©ph√©drine</option>
                                        <option value="LOINC_11564-2_COCA">Coca√Øne</option>
                                        <option value="LOINC_11564-2_METHY">M√©thylph√©nidate</option>
                                        <option value="LOINC_11564-2_MODAF">Modafinil</option>
                                    </optgroup>
                                    <optgroup label="Cannabino√Ødes (LOINC 11566-7)">
                                        <option value="LOINC_11566-7_THC">THC (T√©trahydrocannabinol)</option>
                                        <option value="LOINC_11566-7_CBD">CBD (Cannabidiol)</option>
                                        <option value="LOINC_11566-7_CBN">CBN (Cannabinol)</option>
                                        <option value="LOINC_11566-7_METAB">M√©tabolites THC</option>
                                    </optgroup>
                                    <optgroup label="Glucocortico√Ødes (LOINC 11567-5)">
                                        <option value="LOINC_11567-5_PRED">Prednisone</option>
                                        <option value="LOINC_11567-5_DEXA">Dexam√©thasone</option>
                                        <option value="LOINC_11567-5_HYDRO">Hydrocortisone</option>
                                        <option value="LOINC_11567-5_METHY">M√©thylprednisolone</option>
                                        <option value="LOINC_11567-5_TRIAM">Triamcinolone</option>
                                        <option value="LOINC_11567-5_BETAM">B√©tam√©thasone</option>
                                    </optgroup>
                                    <optgroup label="M√©thodes de d√©tection">
                                        <option value="LOINC_11568-3">11568-3 - Chromatographie en phase gazeuse (GC)</option>
                                        <option value="LOINC_11569-1">11569-1 - Spectrom√©trie de masse (MS)</option>
                                        <option value="LOINC_11570-9">11570-9 - Immunoessai (IA)</option>
                                        <option value="LOINC_11571-7">11571-7 - Test ELISA</option>
                                        <option value="LOINC_11572-5">11572-5 - Chromatographie liquide (LC)</option>
                                        <option value="LOINC_11573-3">11573-3 - LC-MS/MS</option>
                                        <option value="LOINC_11574-1">11574-1 - GC-MS</option>
                                    </optgroup>
                                </select>
                                
                                <!-- R√©sultats des tests anti-dopage -->
                                <div id="doping-result-fields" class="mt-4 space-y-3" style="display: none;">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label for="doping_result_value" class="block text-sm font-medium text-gray-700 mb-1">
                                                Valeur mesur√©e
                                            </label>
                                            <input 
                                                type="text" 
                                                id="doping_result_value" 
                                                name="doping_result_value"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Valeur..."
                                            >
                                        </div>
                                        <div>
                                            <label for="doping_result_unit" class="block text-sm font-medium text-gray-700 mb-1">
                                                Unit√©
                                            </label>
                                            <input 
                                                type="text" 
                                                id="doping_result_unit" 
                                                name="doping_result_unit"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="ng/mL, pg/mL..."
                                                readonly
                                            >
                                        </div>
                                        <div>
                                            <label for="doping_result_status" class="block text-sm font-medium text-gray-700 mb-1">
                                                Statut
                                            </label>
                                            <select 
                                                id="doping_result_status" 
                                                name="doping_result_status"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            >
                                                <option value="">S√©lectionner...</option>
                                                <option value="NEGATIVE">N√©gatif</option>
                                                <option value="POSITIVE">Positif</option>
                                                <option value="SUSPICIOUS">Suspect</option>
                                                <option value="INCONCLUSIVE">Inconclusif</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label for="doping_normal_range" class="block text-sm font-medium text-gray-700 mb-1">
                                                Plage normale
                                            </label>
                                            <input 
                                                type="text" 
                                                id="doping_normal_range" 
                                                name="doping_normal_range"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Valeurs normales..."
                                                readonly
                                            >
                                        </div>
                                        <div>
                                            <label for="doping_threshold" class="block text-sm font-medium text-gray-700 mb-1">
                                                Seuil WADA
                                            </label>
                                            <input 
                                                type="text" 
                                                id="doping_threshold" 
                                                name="doping_threshold"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Seuil antidopage..."
                                                readonly
                                            >
                                        </div>
                                    </div>
                                    <div>
                                        <label for="doping_interpretation" class="block text-sm font-medium text-gray-700 mb-1">
                                            Interpr√©tation
                                        </label>
                                        <textarea 
                                            id="doping_interpretation" 
                                            name="doping_interpretation"
                                            rows="2"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Commentaires sur les r√©sultats..."
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="snomed_ct_aut" class="block text-sm font-medium text-gray-700 mb-2">
                                    üíä AUT - Autorisation d'Usage Th√©rapeutique (SNOMED CT: 416940007)
                                </label>
                                <select 
                                    id="snomed_ct_aut" 
                                    name="snomed_ct_aut"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    onchange="updateAUTFields()"
                                >
                                    <option value="">S√©lectionner un type d'AUT...</option>
                                    <optgroup label="SNOMED CT 416940007 - Autorisation d'Usage Th√©rapeutique">
                                        <option value="416940007">416940007 - AUT g√©n√©rale</option>
                                        <option value="416940008">416940008 - AUT pour stimulants</option>
                                        <option value="416940009">416940009 - AUT pour anabolisants</option>
                                        <option value="416940010">416940010 - AUT pour diur√©tiques</option>
                                        <option value="416940011">416940011 - AUT pour b√™ta-bloquants</option>
                                        <option value="416940012">416940012 - AUT pour hormones peptidiques</option>
                                    </optgroup>
                                    <optgroup label="Substances sp√©cifiques">
                                        <option value="AUT_ADHD">Trouble d√©ficit de l'attention (ADHD)</option>
                                        <option value="AUT_ASTHMA">Asthme et troubles respiratoires</option>
                                        <option value="AUT_DIABETES">Diab√®te et troubles m√©taboliques</option>
                                        <option value="AUT_CARDIO">Troubles cardiovasculaires</option>
                                        <option value="AUT_PSYCH">Troubles psychiatriques</option>
                                        <option value="AUT_ENDOCRINE">Troubles endocriniens</option>
                                        <option value="AUT_NEURO">Troubles neurologiques</option>
                                        <option value="AUT_DERMATO">Troubles dermatologiques</option>
                                        <option value="AUT_GASTRO">Troubles gastro-intestinaux</option>
                                        <option value="AUT_RHEUMATO">Troubles rhumatologiques</option>
                                    </optgroup>
                                    <optgroup label="Statuts d'AUT">
                                        <option value="AUT_PENDING">AUT en attente</option>
                                        <option value="AUT_APPROVED">AUT approuv√©e</option>
                                        <option value="AUT_REJECTED">AUT rejet√©e</option>
                                        <option value="AUT_EXPIRED">AUT expir√©e</option>
                                        <option value="AUT_REVOKED">AUT r√©voqu√©e</option>
                                    </optgroup>
                                </select>

                                <!-- AUT Details Section -->
                                <div id="aut-details-section" class="mt-4 space-y-4" style="display: none;">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h4 class="text-sm font-semibold text-blue-800 mb-3 flex items-center">
                                            <span class="mr-2">üìã</span>
                                            D√©tails de l'AUT
                                        </h4>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label for="aut_substance" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Substance m√©dicamenteuse
                                                </label>
                                                <input 
                                                    type="text" 
                                                    id="aut_substance" 
                                                    name="aut_substance"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                    placeholder="Nom de la substance..."
                                                >
                                            </div>
                                            <div>
                                                <label for="aut_dosage" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Posologie prescrite
                                                </label>
                                                <input 
                                                    type="text" 
                                                    id="aut_dosage" 
                                                    name="aut_dosage"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                    placeholder="Dosage et fr√©quence..."
                                                >
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label for="aut_diagnosis" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Diagnostic m√©dical
                                                </label>
                                                <textarea 
                                                    id="aut_diagnosis" 
                                                    name="aut_diagnosis"
                                                    rows="2"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                    placeholder="Diagnostic justifiant l'AUT..."
                                                ></textarea>
                                            </div>
                                            <div>
                                                <label for="aut_justification" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Justification m√©dicale
                                                </label>
                                                <textarea 
                                                    id="aut_justification" 
                                                    name="aut_justification"
                                                    rows="2"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                    placeholder="Justification de l'usage th√©rapeutique..."
                                                ></textarea>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label for="aut_start_date" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Date de d√©but
                                                </label>
                                                <input 
                                                    type="date" 
                                                    id="aut_start_date" 
                                                    name="aut_start_date"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                >
                                            </div>
                                            <div>
                                                <label for="aut_end_date" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Date de fin
                                                </label>
                                                <input 
                                                    type="date" 
                                                    id="aut_end_date" 
                                                    name="aut_end_date"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                >
                                            </div>
                                            <div>
                                                <label for="aut_status" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Statut de l'AUT
                                                </label>
                                                <select 
                                                    id="aut_status" 
                                                    name="aut_status"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                >
                                                    <option value="">S√©lectionner...</option>
                                                    <option value="pending">En attente</option>
                                                    <option value="approved">Approuv√©e</option>
                                                    <option value="rejected">Rejet√©e</option>
                                                    <option value="expired">Expir√©e</option>
                                                    <option value="revoked">R√©voqu√©e</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- AUT File Upload Section -->
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 class="text-sm font-semibold text-green-800 mb-3 flex items-center">
                                            <span class="mr-2">üìÑ</span>
                                            Documents AUT
                                        </h4>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="aut_application_form" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Formulaire de demande AUT
                                                </label>
                                                <div class="flex items-center space-x-2">
                                                    <input 
                                                        type="file" 
                                                        id="aut_application_form" 
                                                        name="aut_application_form"
                                                        accept=".pdf,.doc,.docx"
                                                        class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                                                    >
                                                    <button 
                                                        type="button"
                                                        onclick="downloadIAAFForm()"
                                                        class="px-3 py-2 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                    >
                                                        üìã IAAF
                                                    </button>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    Formulaire IAAF Therapeutic Use Exemptions
                                                </p>
                                            </div>
                                            <div>
                                                <label for="aut_response_document" class="block text-xs font-medium text-gray-600 mb-1">
                                                    R√©ponse officielle
                                                </label>
                                                <input 
                                                    type="file" 
                                                    id="aut_response_document" 
                                                    name="aut_response_document"
                                                    accept=".pdf,.doc,.docx"
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                                                >
                                                <p class="text-xs text-gray-500 mt-1">
                                                    Document de r√©ponse de l'autorit√©
                                                </p>
                                            </div>
                                        </div>

                                        <div class="mt-4">
                                            <label for="aut_notes" class="block text-xs font-medium text-gray-600 mb-1">
                                                Notes et observations
                                            </label>
                                            <textarea 
                                                id="aut_notes" 
                                                name="aut_notes"
                                                rows="3"
                                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500"
                                                placeholder="Notes suppl√©mentaires sur l'AUT..."
                                            ></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Blood Tests & Biological Profile -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="blood_test_panel" class="block text-sm font-medium text-gray-700 mb-2">
                                    ü©∏ Analyses Sanguines (LOINC: 58410-2, 58409-4, 58408-6)
                                </label>
                                <select 
                                    id="blood_test_panel" 
                                    name="blood_test_panel"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    onchange="updateBloodTestResultFields()"
                                >
                                    <option value="">S√©lectionner un test sanguin...</option>
                                    <optgroup label="LOINC 58410-2 - Panel m√©tabolique complet">
                                        <option value="58410-2">58410-2 - Panel m√©tabolique complet (CBC + Biochimie + Lipides + Enzymes h√©patiques)</option>
                                        <option value="58409-4">58409-4 - Panel m√©tabolique de base (Biochimie + √âlectrolytes)</option>
                                        <option value="58408-6">58408-6 - Panel m√©tabolique √©tendu (Complet + Marqueurs cardiaques + Hormones)</option>
                                    </optgroup>
                                    <optgroup label="H√©matologie">
                                        <option value="LOINC_58410-2_CBC">Num√©ration formule sanguine (CBC)</option>
                                        <option value="LOINC_58410-2_HGB">H√©moglobine (HGB)</option>
                                        <option value="LOINC_58410-2_HCT">H√©matocrite (HCT)</option>
                                        <option value="LOINC_58410-2_RBC">Globules rouges (RBC)</option>
                                        <option value="LOINC_58410-2_WBC">Globules blancs (WBC)</option>
                                        <option value="LOINC_58410-2_PLT">Plaquettes (PLT)</option>
                                        <option value="LOINC_58410-2_MCV">Volume corpusculaire moyen (MCV)</option>
                                        <option value="LOINC_58410-2_MCH">H√©moglobine corpusculaire moyenne (MCH)</option>
                                        <option value="LOINC_58410-2_MCHC">Concentration corpusculaire moyenne en h√©moglobine (MCHC)</option>
                                        <option value="LOINC_58410-2_RDW">Largeur de distribution des globules rouges (RDW)</option>
                                        <option value="LOINC_58410-2_MPV">Volume plaquettaire moyen (MPV)</option>
                                        <option value="LOINC_58410-2_NEUT">Neutrophiles</option>
                                        <option value="LOINC_58410-2_LYMPH">Lymphocytes</option>
                                        <option value="LOINC_58410-2_MONO">Monocytes</option>
                                        <option value="LOINC_58410-2_EOS">√âosinophiles</option>
                                        <option value="LOINC_58410-2_BASO">Basophiles</option>
                                    </optgroup>
                                    <optgroup label="Biochimie">
                                        <option value="LOINC_58409-4_GLU">Glucose</option>
                                        <option value="LOINC_58409-4_CREA">Cr√©atinine</option>
                                        <option value="LOINC_58409-4_BUN">Azote ur√©ique sanguin (BUN)</option>
                                        <option value="LOINC_58409-4_NA">Sodium (Na)</option>
                                        <option value="LOINC_58409-4_K">Potassium (K)</option>
                                        <option value="LOINC_58409-4_CL">Chlore (Cl)</option>
                                        <option value="LOINC_58409-4_CO2">CO2 total</option>
                                        <option value="LOINC_58409-4_CA">Calcium (Ca)</option>
                                        <option value="LOINC_58409-4_PHOS">Phosphore</option>
                                        <option value="LOINC_58409-4_MG">Magn√©sium (Mg)</option>
                                        <option value="LOINC_58409-4_UA">Acide urique</option>
                                        <option value="LOINC_58409-4_LDH">Lactate d√©shydrog√©nase (LDH)</option>
                                        <option value="LOINC_58409-4_CPK">Cr√©atine phosphokinase (CPK)</option>
                                    </optgroup>
                                    <optgroup label="Lipides">
                                        <option value="LOINC_58408-6_CHOL">Cholest√©rol total</option>
                                        <option value="LOINC_58408-6_HDL">HDL-cholest√©rol</option>
                                        <option value="LOINC_58408-6_LDL">LDL-cholest√©rol</option>
                                        <option value="LOINC_58408-6_TRIG">Triglyc√©rides</option>
                                        <option value="LOINC_58408-6_APOA">Apolipoprot√©ine A</option>
                                        <option value="LOINC_58408-6_APOB">Apolipoprot√©ine B</option>
                                        <option value="LOINC_58408-6_LP">Lipoprot√©ine (a)</option>
                                        <option value="LOINC_58408-6_NONHDL">Cholest√©rol non-HDL</option>
                                        <option value="LOINC_58408-6_RATIO">Ratio cholest√©rol total/HDL</option>
                                    </optgroup>
                                    <optgroup label="Enzymes h√©patiques">
                                        <option value="LOINC_58408-6_ALT">Alanine aminotransf√©rase (ALT)</option>
                                        <option value="LOINC_58408-6_AST">Aspartate aminotransf√©rase (AST)</option>
                                        <option value="LOINC_58408-6_ALP">Phosphatase alcaline (ALP)</option>
                                        <option value="LOINC_58408-6_GGT">Gamma-glutamyl transf√©rase (GGT)</option>
                                        <option value="LOINC_58408-6_TBIL">Bilirubine totale</option>
                                        <option value="LOINC_58408-6_DBIL">Bilirubine directe</option>
                                        <option value="LOINC_58408-6_IBIL">Bilirubine indirecte</option>
                                        <option value="LOINC_58408-6_ALB">Albumine</option>
                                        <option value="LOINC_58408-6_TP">Prot√©ines totales</option>
                                        <option value="LOINC_58408-6_GLOB">Globulines</option>
                                        <option value="LOINC_58408-6_AG">Ratio albumine/globuline</option>
                                    </optgroup>
                                    <optgroup label="Marqueurs cardiaques">
                                        <option value="LOINC_58408-6_TROP">Troponine</option>
                                        <option value="LOINC_58408-6_CK">Cr√©atine kinase (CK)</option>
                                        <option value="LOINC_58408-6_CKMB">Cr√©atine kinase MB (CK-MB)</option>
                                        <option value="LOINC_58408-6_BNP">Peptide natriur√©tique de type B (BNP)</option>
                                        <option value="LOINC_58408-6_NT">NT-proBNP</option>
                                        <option value="LOINC_58408-6_CRP">Prot√©ine C r√©active (CRP)</option>
                                        <option value="LOINC_58408-6_ESR">Vitesse de s√©dimentation (VS)</option>
                                        <option value="LOINC_58408-6_HSCRP">CRP ultrasensible (hs-CRP)</option>
                                        <option value="LOINC_58408-6_LPA">Lipoprot√©ine (a)</option>
                                        <option value="LOINC_58408-6_HOMOC">Homocyst√©ine</option>
                                    </optgroup>
                                    <optgroup label="Hormones">
                                        <option value="LOINC_58408-6_TSH">TSH (Hormone thyr√©ostimulante)</option>
                                        <option value="LOINC_58408-6_T4">T4 libre</option>
                                        <option value="LOINC_58408-6_T3">T3 libre</option>
                                        <option value="LOINC_58408-6_CORT">Cortisol</option>
                                        <option value="LOINC_58408-6_INSU">Insuline</option>
                                        <option value="LOINC_58408-6_HBA1C">H√©moglobine glyqu√©e (HbA1c)</option>
                                        <option value="LOINC_58408-6_VITD">Vitamine D</option>
                                        <option value="LOINC_58408-6_FOL">Acide folique</option>
                                        <option value="LOINC_58408-6_B12">Vitamine B12</option>
                                        <option value="LOINC_58408-6_TEST">Testost√©rone</option>
                                        <option value="LOINC_58408-6_EST">Estradiol</option>
                                        <option value="LOINC_58408-6_PROG">Progest√©rone</option>
                                        <option value="LOINC_58408-6_FSH">FSH</option>
                                        <option value="LOINC_58408-6_LH">LH</option>
                                        <option value="LOINC_58408-6_PROL">Prolactine</option>
                                        <option value="LOINC_58408-6_GH">Hormone de croissance (GH)</option>
                                        <option value="LOINC_58408-6_IGF">IGF-1</option>
                                    </optgroup>
                                    <optgroup label="Marqueurs inflammatoires">
                                        <option value="LOINC_58408-6_IL6">Interleukine-6 (IL-6)</option>
                                        <option value="LOINC_58408-6_TNF">Facteur de n√©crose tumorale alpha (TNF-Œ±)</option>
                                        <option value="LOINC_58408-6_FER">Ferritine</option>
                                        <option value="LOINC_58408-6_IRON">Fer s√©rique</option>
                                        <option value="LOINC_58408-6_TIBC">Capacit√© totale de fixation du fer (TIBC)</option>
                                        <option value="LOINC_58408-6_UIBC">Capacit√© de fixation du fer non satur√©e (UIBC)</option>
                                        <option value="LOINC_58408-6_SAT">Saturation en fer</option>
                                        <option value="LOINC_58408-6_TRANS">Transferrine</option>
                                        <option value="LOINC_58408-6_CERUL">C√©ruloplasmine</option>
                                        <option value="LOINC_58408-6_COPPER">Cuivre</option>
                                        <option value="LOINC_58408-6_ZINC">Zinc</option>
                                        <option value="LOINC_58408-6_SELEN">S√©l√©nium</option>
                                    </optgroup>
                                    <optgroup label="Marqueurs tumoraux">
                                        <option value="LOINC_58408-6_PSA">Antig√®ne prostatique sp√©cifique (PSA)</option>
                                        <option value="LOINC_58408-6_CEA">Antig√®ne carcino-embryonnaire (CEA)</option>
                                        <option value="LOINC_58408-6_AFP">Alpha-foetoprot√©ine (AFP)</option>
                                        <option value="LOINC_58408-6_CA125">CA 125</option>
                                        <option value="LOINC_58408-6_CA199">CA 19-9</option>
                                        <option value="LOINC_58408-6_CA153">CA 15-3</option>
                                        <option value="LOINC_58408-6_CA724">CA 72-4</option>
                                        <option value="LOINC_58408-6_SCC">Antig√®ne du carcinome √©pidermo√Øde (SCC)</option>
                                        <option value="LOINC_58408-6_NSE">Enolase sp√©cifique des neurones (NSE)</option>
                                        <option value="LOINC_58408-6_CYFRA">CYFRA 21-1</option>
                                    </optgroup>
                                    <optgroup label="Marqueurs d'auto-immunit√©">
                                        <option value="LOINC_58408-6_ANA">Anticorps antinucl√©aires (ANA)</option>
                                        <option value="LOINC_58408-6_RF">Facteur rhumato√Øde (RF)</option>
                                        <option value="LOINC_58408-6_CCP">Peptide citrullin√© cyclique (CCP)</option>
                                        <option value="LOINC_58408-6_DSDNA">Anticorps anti-ADN double brin</option>
                                        <option value="LOINC_58408-6_SM">Anticorps anti-Sm</option>
                                        <option value="LOINC_58408-6_RO">Anticorps anti-Ro/SSA</option>
                                        <option value="LOINC_58408-6_LA">Anticorps anti-La/SSB</option>
                                        <option value="LOINC_58408-6_ANCA">Anticorps anti-cytoplasme des neutrophiles (ANCA)</option>
                                        <option value="LOINC_58408-6_ASMA">Anticorps anti-muscle lisse (ASMA)</option>
                                        <option value="LOINC_58408-6_AMA">Anticorps anti-mitochondries (AMA)</option>
                                    </optgroup>
                                </select>
                                
                                <!-- R√©sultats des tests sanguins -->
                                <div id="blood-test-result-fields" class="mt-4 space-y-3" style="display: none;">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div>
                                            <label for="blood_test_result_value" class="block text-sm font-medium text-gray-700 mb-1">
                                                Valeur mesur√©e
                                            </label>
                                            <input 
                                                type="text" 
                                                id="blood_test_result_value" 
                                                name="blood_test_result_value"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Valeur..."
                                            >
                                        </div>
                                        <div>
                                            <label for="blood_test_result_unit" class="block text-sm font-medium text-gray-700 mb-1">
                                                Unit√©
                                            </label>
                                            <input 
                                                type="text" 
                                                id="blood_test_result_unit" 
                                                name="blood_test_result_unit"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="g/dL, mg/dL, Œºmol/L..."
                                                readonly
                                            >
                                        </div>
                                        <div>
                                            <label for="blood_test_result_status" class="block text-sm font-medium text-gray-700 mb-1">
                                                Statut
                                            </label>
                                            <select 
                                                id="blood_test_result_status" 
                                                name="blood_test_result_status"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            >
                                                <option value="">S√©lectionner...</option>
                                                <option value="NORMAL">Normal</option>
                                                <option value="LOW">Bas</option>
                                                <option value="HIGH">√âlev√©</option>
                                                <option value="CRITICAL_LOW">Critiquement bas</option>
                                                <option value="CRITICAL_HIGH">Critiquement √©lev√©</option>
                                                <option value="ABNORMAL">Anormal</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label for="blood_test_normal_range" class="block text-sm font-medium text-gray-700 mb-1">
                                                Plage normale
                                            </label>
                                            <input 
                                                type="text" 
                                                id="blood_test_normal_range" 
                                                name="blood_test_normal_range"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Valeurs normales..."
                                                readonly
                                            >
                                        </div>
                                        <div>
                                            <label for="blood_test_reference" class="block text-sm font-medium text-gray-700 mb-1">
                                                R√©f√©rence
                                            </label>
                                            <input 
                                                type="text" 
                                                id="blood_test_reference" 
                                                name="blood_test_reference"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="R√©f√©rence..."
                                                readonly
                                            >
                                        </div>
                                    </div>
                                    <div>
                                        <label for="blood_test_interpretation" class="block text-sm font-medium text-gray-700 mb-1">
                                            Interpr√©tation clinique
                                        </label>
                                        <textarea 
                                            id="blood_test_interpretation" 
                                            name="blood_test_interpretation"
                                            rows="2"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder="Interpr√©tation des r√©sultats..."
                                        ></textarea>
                                    </div>
                                </div>

                                <!-- Dynamic Panel Tests Cards -->
                                <div id="panel-tests-container" class="mt-6 space-y-4" style="display: none;">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                        <span class="mr-2">üìä</span>
                                        Tests du Panel S√©lectionn√©
                                    </h4>
                                    <div id="panel-tests-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Dynamic test cards will be inserted here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="snomed_ct_biological_profile" class="block text-sm font-medium text-gray-700 mb-2">
                                    üß¨ Profil Biologique (SNOMED CT: 363787002)
                                </label>
                                <select 
                                    id="snomed_ct_biological_profile" 
                                    name="snomed_ct_biological_profile"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                >
                                    <option value="">S√©lectionner un profil biologique...</option>
                                    <optgroup label="SNOMED CT 363787002 - Profil biologique">
                                        <option value="363787002">363787002 - Profil biologique complet</option>
                                        <option value="363787003">363787003 - Profil m√©tabolique</option>
                                        <option value="363787004">363787004 - Profil hormonal</option>
                                        <option value="363787005">363787005 - Profil inflammatoire</option>
                                        <option value="363787006">363787006 - Profil oxydatif</option>
                                    </optgroup>
                                    <optgroup label="Marqueurs m√©taboliques">
                                        <option value="SNOMED_363787007">363787007 - Marqueurs de stress oxydatif</option>
                                        <option value="SNOMED_363787008">363787008 - Marqueurs inflammatoires</option>
                                        <option value="SNOMED_363787009">363787009 - Marqueurs hormonaux</option>
                                        <option value="SNOMED_363787010">363787010 - Marqueurs de vieillissement</option>
                                        <option value="SNOMED_363787011">363787011 - Marqueurs de performance</option>
                                    </optgroup>
                                    <optgroup label="√Çge biologique">
                                        <option value="BIOLOGICAL_AGE_NORMAL">√Çge biologique normal</option>
                                        <option value="BIOLOGICAL_AGE_YOUNGER">√Çge biologique inf√©rieur</option>
                                        <option value="BIOLOGICAL_AGE_OLDER">√Çge biologique sup√©rieur</option>
                                        <option value="BIOLOGICAL_AGE_ACCELERATED">Vieillissement acc√©l√©r√©</option>
                                    </optgroup>
                                    <optgroup label="Profils sp√©cifiques">
                                        <option value="PROFILE_ATHLETE">Profil athl√®te</option>
                                        <option value="PROFILE_ELITE">Profil √©lite</option>
                                        <option value="PROFILE_RECOVERY">Profil r√©cup√©ration</option>
                                        <option value="PROFILE_MONITORING">Profil surveillance</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- Dental Health Section -->
                        <div class="mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                                    <span class="mr-2">ü¶∑</span>
                                    Sant√© Dentaire (ICD-10: K00-K14)
                                </h3>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div>
                                        <label for="icd_10_dental" class="block text-sm font-medium text-gray-700 mb-2">
                                            Diagnostic Dentaire
                                        </label>
                                        <select 
                                            id="icd_10_dental" 
                                            name="icd_10_dental"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                            <option value="">S√©lectionner un diagnostic dentaire...</option>
                                            <optgroup label="ICD-10 K00-K14 - Maladies de la cavit√© buccale">
                                                <option value="K00.0">K00.0 - Anodontie</option>
                                                <option value="K00.1">K00.1 - Dents surnum√©raires</option>
                                                <option value="K00.2">K00.2 - Anomalies de taille et de forme des dents</option>
                                                <option value="K00.3">K00.3 - Dents tachet√©es</option>
                                                <option value="K00.4">K00.4 - Troubles de la formation des dents</option>
                                                <option value="K00.5">K00.5 - Anomalies h√©r√©ditaires de la structure dentaire</option>
                                                <option value="K00.6">K00.6 - Troubles de l'√©ruption dentaire</option>
                                                <option value="K00.7">K00.7 - Syndrome de la dentition</option>
                                                <option value="K00.8">K00.8 - Autres anomalies du d√©veloppement dentaire</option>
                                                <option value="K00.9">K00.9 - Anomalie du d√©veloppement dentaire, sans pr√©cision</option>
                                            </optgroup>
                                            <optgroup label="Caries et maladies pulpaires">
                                                <option value="K02.0">K02.0 - Carie limit√©e √† l'√©mail</option>
                                                <option value="K02.1">K02.1 - Carie de la dentine</option>
                                                <option value="K02.2">K02.2 - Carie du c√©ment</option>
                                                <option value="K02.3">K02.3 - Carie arr√™t√©e</option>
                                                <option value="K02.4">K02.4 - Carie de l'odontoclasie</option>
                                                <option value="K02.5">K02.5 - Carie avec exposition pulpaire</option>
                                                <option value="K02.8">K02.8 - Autres caries dentaires</option>
                                                <option value="K02.9">K02.9 - Carie dentaire, sans pr√©cision</option>
                                            </optgroup>
                                            <optgroup label="Maladies pulpaires et p√©riapicales">
                                                <option value="K04.0">K04.0 - Pulpite</option>
                                                <option value="K04.1">K04.1 - N√©crose pulpaire</option>
                                                <option value="K04.2">K04.2 - D√©g√©n√©rescence pulpaire</option>
                                                <option value="K04.3">K04.3 - Formation anormale de tissu dur dans la pulpe</option>
                                                <option value="K04.4">K04.4 - Parodontite apicale aigu√´ d'origine pulpaire</option>
                                                <option value="K04.5">K04.5 - Parodontite apicale chronique</option>
                                                <option value="K04.6">K04.6 - Abc√®s p√©riapical avec fistule</option>
                                                <option value="K04.7">K04.7 - Abc√®s p√©riapical sans fistule</option>
                                                <option value="K04.8">K04.8 - Kyste radiculaire</option>
                                                <option value="K04.9">K04.9 - Autres maladies pulpaires et p√©riapicales</option>
                                            </optgroup>
                                            <optgroup label="Maladies gingivales et parodontales">
                                                <option value="K05.0">K05.0 - Gingivite aigu√´</option>
                                                <option value="K05.1">K05.1 - Gingivite chronique</option>
                                                <option value="K05.2">K05.2 - Parodontite aigu√´</option>
                                                <option value="K05.3">K05.3 - Parodontite chronique</option>
                                                <option value="K05.4">K05.4 - Parodontose</option>
                                                <option value="K05.5">K05.5 - Autres maladies parodontales</option>
                                                <option value="K05.6">K05.6 - Maladie parodontale, sans pr√©cision</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="dental_health_status" class="block text-sm font-medium text-gray-700 mb-2">
                                            Statut G√©n√©ral de la Sant√© Dentaire
                                        </label>
                                        <select 
                                            id="dental_health_status" 
                                            name="dental_health_status"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                            <option value="">S√©lectionner le statut...</option>
                                            <option value="excellent">Excellent</option>
                                            <option value="good">Bon</option>
                                            <option value="fair">Moyen</option>
                                            <option value="poor">Mauvais</option>
                                            <option value="critical">Critique</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <label for="dental_notes" class="block text-sm font-medium text-gray-700 mb-2">
                                        Notes Dentaires
                                    </label>
                                    <textarea 
                                        id="dental_notes" 
                                        name="dental_notes"
                                        rows="3"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Observations dentaires, traitements en cours, recommandations..."
                                    >{{ old('dental_notes') }}</textarea>
                                </div>
                            </div>

                            <!-- Interactive Dental Chart -->
                            <div class="mt-4 bg-white border border-gray-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                                    <span class="mr-2">üìä</span>
                                    Sch√©ma Dentaire Interactif
                                </h4>
                                
                                <div class="dental-chart-wrapper">
                                    <div class="dental-chart-container">
                                        <div class="chart-header">
                                            <div class="flex items-center space-x-4 text-sm mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-4 h-4 bg-white border border-gray-300 rounded"></div>
                                                    <span>Sant√©</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-4 h-4 bg-red-500 rounded"></div>
                                                    <span>Carie</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                                                    <span>Restauration</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <div class="w-4 h-4 bg-gray-500 opacity-50 rounded"></div>
                                                    <span>Manquante</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="chart-wrapper" id="chartContainer">
                                            <div 
                                                class="dental-svg-container" 
                                                id="dental-svg-container"
                                            >
                                                <!-- Dental Chart SVG will be injected here -->
                                            </div>
                                        </div>

                                        <!-- Dental Tooltip -->
                                        <div 
                                            id="dental-tooltip"
                                            class="dental-tooltip"
                                            style="display: none;"
                                        >
                                            <div class="tooltip-content">
                                                <div class="font-semibold" id="tooltip-tooth-number">Dent 1</div>
                                                <div class="text-sm" id="tooltip-status">Saine</div>
                                                <div class="text-xs text-gray-500" id="tooltip-condition">Aucune condition</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dental Status Summary -->
                                <div class="mt-4 bg-gray-50 rounded-lg p-4">
                                    <h5 class="text-sm font-semibold text-gray-700 mb-3">R√©sum√© Dentaire</h5>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div class="flex items-center justify-between">
                                            <span>Dents saines:</span>
                                            <span class="font-semibold text-green-600" id="healthy-teeth-count">32</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span>Caries:</span>
                                            <span class="font-semibold text-red-600" id="caries-count">0</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span>Restaurations:</span>
                                            <span class="font-semibold text-blue-600" id="restoration-count">0</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span>Manquantes:</span>
                                            <span class="font-semibold text-gray-600" id="missing-teeth-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Postural Assessment -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ü¶¥ √âvaluation Posturale Interactive (ICD-10: M40-M54)
                            </label>
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="mb-4">
                                    <p class="text-sm text-gray-600 mb-3">
                                        Utilisez l'outil interactif pour analyser la posture du patient :
                                    </p>
                                    <ul class="text-sm text-gray-600 space-y-1 mb-4">
                                        <li>‚Ä¢ <strong>üéØ Marqueur :</strong> Cliquez sur un point anatomique pour ajouter une note d'anomalie</li>
                                        <li>‚Ä¢ <strong>üìê Angle :</strong> Cliquez sur 3 points pour mesurer un angle</li>
                                        <li>‚Ä¢ <strong>üìè Fil √† Plomb :</strong> Affiche une ligne de r√©f√©rence verticale</li>
                                        <li>‚Ä¢ <strong>üóëÔ∏è Effacer :</strong> Supprime toutes les annotations</li>
                                        <li>‚Ä¢ <strong>üíæ Exporter :</strong> T√©l√©charge les donn√©es d'√©valuation en JSON</li>
                                    </ul>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                        <p class="text-sm text-yellow-800">
                                            <strong>üí° Astuce :</strong> Les donn√©es posturales sont automatiquement sauvegard√©es dans le formulaire et seront incluses dans le dossier m√©dical.
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Composant d'analyse posturale -->
                                <div id="postural-chart-container">
                                    <div class="postural-chart-container">
                                        <!-- Toolbar -->
                                        <div class="toolbar bg-white border-b border-gray-200 p-4">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-4">
                                                    <!-- View Selector -->
                                                    <div class="flex items-center space-x-2">
                                                        <label class="text-sm font-medium text-gray-700">Vue :</label>
                                                        <select id="postural-view-selector" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                                            <option value="anterior">Ant√©rieure</option>
                                                            <option value="posterior">Post√©rieure</option>
                                                            <option value="lateral">Lat√©rale</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <!-- Tool Selector -->
                                                    <div class="flex items-center space-x-2">
                                                        <label class="text-sm font-medium text-gray-700">Outil :</label>
                                                        <div class="flex space-x-1">
                                                            <button 
                                                                id="postural-marker-tool"
                                                                class="px-3 py-1 rounded text-sm bg-blue-500 text-white"
                                                                title="Marqueur"
                                                            >
                                                                üéØ
                                                            </button>
                                                            <button 
                                                                id="postural-angle-tool"
                                                                class="px-3 py-1 rounded text-sm bg-gray-200 text-gray-700"
                                                                title="Mesure d'angle"
                                                            >
                                                                üìê
                                                            </button>
                                                            <button 
                                                                id="postural-plumb-tool"
                                                                class="px-3 py-1 rounded text-sm bg-gray-200 text-gray-700"
                                                                title="Fil √† plomb"
                                                            >
                                                                üìè
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Color Palette -->
                                                    <div id="postural-color-palette" class="flex items-center space-x-2" style="display: none;">
                                                        <label class="text-sm font-medium text-gray-700">Couleur :</label>
                                                        <div class="flex space-x-1">
                                                            <button class="w-6 h-6 rounded border-2 border-gray-800 bg-red-500" data-color="#ff0000"></button>
                                                            <button class="w-6 h-6 rounded border-2 border-gray-300 bg-green-500" data-color="#00ff00"></button>
                                                            <button class="w-6 h-6 rounded border-2 border-gray-300 bg-blue-500" data-color="#0000ff"></button>
                                                            <button class="w-6 h-6 rounded border-2 border-gray-300 bg-yellow-500" data-color="#ffff00"></button>
                                                            <button class="w-6 h-6 rounded border-2 border-gray-300 bg-magenta-500" data-color="#ff00ff"></button>
                                                            <button class="w-6 h-6 rounded border-2 border-gray-300 bg-cyan-500" data-color="#00ffff"></button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Actions -->
                                                <div class="flex items-center space-x-2">
                                                    <button id="postural-clear-btn" class="px-3 py-1 bg-red-500 text-white rounded text-sm">
                                                        üóëÔ∏è Effacer
                                                    </button>
                                                    <button id="postural-export-btn" class="px-3 py-1 bg-green-500 text-white rounded text-sm">
                                                        üíæ Exporter
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Chart Container -->
                                        <div class="chart-area bg-gray-50 p-4">
                                            <div class="flex flex-col lg:flex-row">
                                                <!-- SVG Chart -->
                                                <div class="svg-container relative mx-auto lg:mx-0" style="width: 600px; height: 800px; max-width: 100%; max-height: 80vh;">
                                                    <div id="postural-svg-content" class="cursor-crosshair w-full h-full">
                                                        <!-- SVG content will be loaded here -->
                                                    </div>
                                                    
                                                    <!-- Annotations Layer -->
                                                    <svg id="postural-annotations" class="absolute top-0 left-0 w-full h-full pointer-events-none" style="width: 600px; height: 800px; max-width: 100%; max-height: 80vh;">
                                                        <!-- Markers and angles will be added here -->
                                                    </svg>
                                                </div>
                                                
                                                <!-- Sidebar -->
                                                <div class="lg:ml-6 mt-4 lg:mt-0 flex-1">
                                                    <div class="bg-white rounded-lg shadow p-4">
                                                        <h3 class="text-lg font-semibold mb-4">üìä Donn√©es d'√âvaluation</h3>
                                                        
                                                        <!-- Markers List -->
                                                        <div class="mb-4">
                                                            <h4 class="font-medium text-gray-700 mb-2">üéØ Marqueurs (<span id="postural-markers-count">0</span>)</h4>
                                                            <div id="postural-markers-list" class="space-y-2 max-h-32 overflow-y-auto">
                                                                <!-- Markers will be listed here -->
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Angles List -->
                                                        <div class="mb-4">
                                                            <h4 class="font-medium text-gray-700 mb-2">üìê Angles (<span id="postural-angles-count">0</span>)</h4>
                                                            <div id="postural-angles-list" class="space-y-2 max-h-32 overflow-y-auto">
                                                                <!-- Angles will be listed here -->
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Export Data -->
                                                        <div class="mt-4 p-3 bg-blue-50 rounded">
                                                            <h4 class="font-medium text-blue-800 mb-2">üíæ Donn√©es d'Export</h4>
                                                            <textarea 
                                                                id="postural-export-data"
                                                                rows="4" 
                                                                class="w-full text-xs border border-blue-200 rounded p-2"
                                                                readonly
                                                            ></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Donn√©es cach√©es pour le formulaire -->
                                <input type="hidden" name="postural_assessment_data" id="postural_assessment_data" value="{{ old('postural_assessment_data') }}">
                                
                                <!-- Postural Assessment Summary -->
                                <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="text-sm font-semibold text-blue-800 mb-3 flex items-center">
                                        <span class="mr-2">üìä</span>
                                        R√©sum√© de l'√âvaluation Posturale
                                    </h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div class="flex items-center justify-between">
                                            <span>Marqueurs:</span>
                                            <span class="font-semibold text-blue-600" id="postural-markers-count">0</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span>Angles:</span>
                                            <span class="font-semibold text-green-600" id="postural-angles-count">0</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span>Vue actuelle:</span>
                                            <span class="font-semibold text-purple-600" id="postural-current-view">Ant√©rieure</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span>Statut:</span>
                                            <span class="font-semibold text-orange-600" id="postural-status">En cours</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Injuries (FIFA F-MARC & SCAT) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="injury_records" class="block text-sm font-medium text-gray-700 mb-2">
                                    üèÉ Blessures G√©n√©rales (FIFA F-MARC, SNOMED CT: 21522001)
                                </label>
                                <select 
                                    id="injury_records" 
                                    name="injury_records" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                >
                                    <option value="">S√©lectionnez une blessure...</option>
                                    
                                    <!-- Head & Neck Injuries -->
                                    <optgroup label="üè• Blessures de la T√™te et du Cou">
                                        <option value="21522001|Fracture du cr√¢ne">21522001 - Fracture du cr√¢ne</option>
                                        <option value="21522002|Commotion c√©r√©brale">21522002 - Commotion c√©r√©brale</option>
                                        <option value="21522003|Luxation cervicale">21522003 - Luxation cervicale</option>
                                        <option value="21522004|Entorse cervicale">21522004 - Entorse cervicale</option>
                                        <option value="21522005|Fracture de la m√¢choire">21522005 - Fracture de la m√¢choire</option>
                                        <option value="21522006|Fracture du nez">21522006 - Fracture du nez</option>
                                        <option value="21522007|Lac√©ration du cuir chevelu">21522007 - Lac√©ration du cuir chevelu</option>
                                    </optgroup>
                                    
                                    <!-- Upper Limb Injuries -->
                                    <optgroup label="üí™ Blessures des Membres Sup√©rieurs">
                                        <option value="21522008|Fracture de l'√©paule">21522008 - Fracture de l'√©paule</option>
                                        <option value="21522009|Luxation de l'√©paule">21522009 - Luxation de l'√©paule</option>
                                        <option value="21522010|Entorse de l'√©paule">21522010 - Entorse de l'√©paule</option>
                                        <option value="21522011|Fracture du bras">21522011 - Fracture du bras</option>
                                        <option value="21522012|Fracture de l'avant-bras">21522012 - Fracture de l'avant-bras</option>
                                        <option value="21522013|Fracture du poignet">21522013 - Fracture du poignet</option>
                                        <option value="21522014|Entorse du poignet">21522014 - Entorse du poignet</option>
                                        <option value="21522015|Fracture de la main">21522015 - Fracture de la main</option>
                                        <option value="21522016|Fracture du doigt">21522016 - Fracture du doigt</option>
                                        <option value="21522017|Luxation du doigt">21522017 - Luxation du doigt</option>
                                    </optgroup>
                                    
                                    <!-- Trunk Injuries -->
                                    <optgroup label="ü¶¥ Blessures du Tronc">
                                        <option value="21522018|Fracture de la clavicule">21522018 - Fracture de la clavicule</option>
                                        <option value="21522019|Fracture de la c√¥te">21522019 - Fracture de la c√¥te</option>
                                        <option value="21522020|Fracture du sternum">21522020 - Fracture du sternum</option>
                                        <option value="21522021|Fracture vert√©brale">21522021 - Fracture vert√©brale</option>
                                        <option value="21522022|Hernie discale">21522022 - Hernie discale</option>
                                        <option value="21522023|Entorse lombaire">21522023 - Entorse lombaire</option>
                                        <option value="21522024|Contusion abdominale">21522024 - Contusion abdominale</option>
                                    </optgroup>
                                    
                                    <!-- Lower Limb Injuries -->
                                    <optgroup label="ü¶µ Blessures des Membres Inf√©rieurs">
                                        <option value="21522025|Fracture de la hanche">21522025 - Fracture de la hanche</option>
                                        <option value="21522026|Luxation de la hanche">21522026 - Luxation de la hanche</option>
                                        <option value="21522027|Fracture de la cuisse">21522027 - Fracture de la cuisse</option>
                                        <option value="21522028|Fracture du genou">21522028 - Fracture du genou</option>
                                        <option value="21522029|Luxation du genou">21522029 - Luxation du genou</option>
                                        <option value="21522030|Entorse du genou">21522030 - Entorse du genou</option>
                                        <option value="21522031|Rupture du ligament crois√©">21522031 - Rupture du ligament crois√©</option>
                                        <option value="21522032|Rupture du m√©nisque">21522032 - Rupture du m√©nisque</option>
                                        <option value="21522033|Fracture de la jambe">21522033 - Fracture de la jambe</option>
                                        <option value="21522034|Fracture de la cheville">21522034 - Fracture de la cheville</option>
                                        <option value="21522035|Entorse de la cheville">21522035 - Entorse de la cheville</option>
                                        <option value="21522036|Fracture du pied">21522036 - Fracture du pied</option>
                                        <option value="21522037|Fracture de l'orteil">21522037 - Fracture de l'orteil</option>
                                        <option value="21522038|Luxation de l'orteil">21522038 - Luxation de l'orteil</option>
                                    </optgroup>
                                    
                                    <!-- Muscle & Tendon Injuries -->
                                    <optgroup label="üí™ Blessures Musculaires et Tendineuses">
                                        <option value="21522039|D√©chirure musculaire">21522039 - D√©chirure musculaire</option>
                                        <option value="21522040|Rupture tendineuse">21522040 - Rupture tendineuse</option>
                                        <option value="21522041|Tendinite">21522041 - Tendinite</option>
                                        <option value="21522042|Contracture musculaire">21522042 - Contracture musculaire</option>
                                        <option value="21522043|√âlongation musculaire">21522043 - √âlongation musculaire</option>
                                        <option value="21522044|Syndrome de la bandelette ilio-tibiale">21522044 - Syndrome de la bandelette ilio-tibiale</option>
                                        <option value="21522045|Syndrome rotulien">21522045 - Syndrome rotulien</option>
                                    </optgroup>
                                    
                                    <!-- Skin & Soft Tissue Injuries -->
                                    <optgroup label="ü©π Blessures Cutan√©es et Tissulaires">
                                        <option value="21522046|Lac√©ration">21522046 - Lac√©ration</option>
                                        <option value="21522047|Abrasion">21522047 - Abrasion</option>
                                        <option value="21522048|Contusion">21522048 - Contusion</option>
                                        <option value="21522049|H√©matome">21522049 - H√©matome</option>
                                        <option value="21522050|Br√ªlure">21522050 - Br√ªlure</option>
                                        <option value="21522051|Plaie par perforation">21522051 - Plaie par perforation</option>
                                    </optgroup>
                                    
                                    <!-- Overuse & Chronic Injuries -->
                                    <optgroup label="üîÑ Blessures de Surcharge et Chroniques">
                                        <option value="21522052|Stress fracture">21522052 - Stress fracture</option>
                                        <option value="21522053|Tendinopathie chronique">21522053 - Tendinopathie chronique</option>
                                        <option value="21522054|Bursite">21522054 - Bursite</option>
                                        <option value="21522055|Fasciite plantaire">21522055 - Fasciite plantaire</option>
                                        <option value="21522056|Syndrome de compression nerveuse">21522056 - Syndrome de compression nerveuse</option>
                                        <option value="21522057|Ost√©ochondrite">21522057 - Ost√©ochondrite</option>
                                    </optgroup>
                                    
                                    <!-- Other Injuries -->
                                    <optgroup label="üîç Autres Blessures">
                                        <option value="21522058|Blessure non sp√©cifi√©e">21522058 - Blessure non sp√©cifi√©e</option>
                                        <option value="21522059|Blessure multiple">21522059 - Blessure multiple</option>
                                        <option value="21522060|Blessure par surcharge">21522060 - Blessure par surcharge</option>
                                        <option value="21522061|Blessure par traumatisme direct">21522061 - Blessure par traumatisme direct</option>
                                        <option value="21522062|Blessure par traumatisme indirect">21522062 - Blessure par traumatisme indirect</option>
                                    </optgroup>
                                </select>
                                
                                <!-- Additional injury details textarea -->
                                <div class="mt-3">
                                    <label for="injury_details" class="block text-sm font-medium text-gray-600 mb-1">
                                        D√©tails suppl√©mentaires de la blessure
                                    </label>
                                    <textarea 
                                        id="injury_details" 
                                        name="injury_details" 
                                        rows="2"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="M√©canisme de la blessure, gravit√©, traitement, temps de r√©cup√©ration..."
                                    >{{ old('injury_details') }}</textarea>
                                </div>
                            </div>
                            
                            <div>
                                <label for="scat_assessments" class="block text-sm font-medium text-gray-700 mb-2">
                                    üß† √âvaluations SCAT (Commotions C√©r√©brales)
                                </label>
                                <textarea 
                                    id="scat_assessments" 
                                    name="scat_assessments" 
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="√âvaluations SCAT, sympt√¥mes neurologiques, retour au jeu..."
                                >{{ old('scat_assessments') }}</textarea>
                            </div>
                        </div>

                        <!-- MAPA & Advanced Imaging -->
                        <div class="grid grid-cols-1 gap-6 mb-6">
                            <div>
                                <label for="mapa_results" class="block text-sm font-medium text-gray-700 mb-2">
                                    üìä MAPA - Mesure Ambulatoire de la P.A. (LOINC: 85354-9)
                                </label>
                                
                                <!-- MAPA Comprehensive Interface -->
                                <div class="bg-white border border-gray-300 rounded-lg p-4 space-y-6">
                                    
                                    <!-- 1. Informations G√©n√©rales sur l'Examen -->
                                    <div class="border-b border-gray-200 pb-4">
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">1. Informations G√©n√©rales sur l'Examen</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="mapa_date" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Date de la mesure
                                                </label>
                                                <input 
                                                    type="date" 
                                                    id="mapa_date" 
                                                    name="mapa_date" 
                                                    value="{{ old('mapa_date', date('Y-m-d')) }}"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                >
                                            </div>
                                            <div>
                                                <label for="mapa_reason" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Motif de l'examen
                                                </label>
                                                <select 
                                                    id="mapa_reason" 
                                                    name="mapa_reason" 
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                >
                                                    <option value="">S√©lectionnez un motif...</option>
                                                    <option value="bilan_pre_saison" {{ old('mapa_reason') == 'bilan_pre_saison' ? 'selected' : '' }}>Bilan pr√©-saison</option>
                                                    <option value="suivi_hta_effort" {{ old('mapa_reason') == 'suivi_hta_effort' ? 'selected' : '' }}>Suivi HTA d'effort</option>
                                                    <option value="symptomes_suspects" {{ old('mapa_reason') == 'symptomes_suspects' ? 'selected' : '' }}>Sympt√¥mes suspects</option>
                                                    <option value="controle_traitement" {{ old('mapa_reason') == 'controle_traitement' ? 'selected' : '' }}>Contr√¥le traitement</option>
                                                    <option value="evaluation_risque" {{ old('mapa_reason') == 'evaluation_risque' ? 'selected' : '' }}>√âvaluation risque cardiovasculaire</option>
                                                    <option value="autre" {{ old('mapa_reason') == 'autre' ? 'selected' : '' }}>Autre</option>
                                                </select>
                                            </div>
                                            <div class="md:col-span-2">
                                                <label for="mapa_device" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Informations sur l'appareil (optionnel)
                                                </label>
                                                <input 
                                                    type="text" 
                                                    id="mapa_device" 
                                                    name="mapa_device" 
                                                    value="{{ old('mapa_device') }}"
                                                    placeholder="Identifiant de l'appareil MAPA"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                >
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 2. Synth√®se et Conclusion M√©dicale -->
                                    <div class="border-b border-gray-200 pb-4">
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">2. Synth√®se et Conclusion M√©dicale</h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label for="mapa_conclusion" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Conclusion du M√©decin
                                                </label>
                                                <textarea 
                                                    id="mapa_conclusion" 
                                                    name="mapa_conclusion" 
                                                    rows="4"
                                                    placeholder="Interpr√©tation, conclusions et recommandations..."
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                >{{ old('mapa_conclusion') }}</textarea>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label for="mapa_dipping" class="block text-xs font-medium text-gray-600 mb-1">
                                                        Profil Tensionnel (Dipping Nocturne)
                                                    </label>
                                                    <select 
                                                        id="mapa_dipping" 
                                                        name="mapa_dipping" 
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                    >
                                                        <option value="">S√©lectionnez le profil...</option>
                                                        <option value="dipper_normal" {{ old('mapa_dipping') == 'dipper_normal' ? 'selected' : '' }}>Dipper normal (10-20%)</option>
                                                        <option value="non_dipper" {{ old('mapa_dipping') == 'non_dipper' ? 'selected' : '' }}>Non-dipper (<10%)</option>
                                                        <option value="dipper_extreme" {{ old('mapa_dipping') == 'dipper_extreme' ? 'selected' : '' }}>Dipper extr√™me (>20%)</option>
                                                        <option value="reverse_dipper" {{ old('mapa_dipping') == 'reverse_dipper' ? 'selected' : '' }}>Reverse dipper</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div>
                                                    <label for="mapa_pas_24h" class="block text-xs font-medium text-gray-600 mb-1">
                                                        P.A. Systolique Moyenne (mmHg)
                                                    </label>
                                                    <input 
                                                        type="number" 
                                                        id="mapa_pas_24h" 
                                                        name="mapa_pas_24h" 
                                                        value="{{ old('mapa_pas_24h') }}"
                                                        step="0.1"
                                                        placeholder="120"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                    >
                                                </div>
                                                <div>
                                                    <label for="mapa_pad_24h" class="block text-xs font-medium text-gray-600 mb-1">
                                                        P.A. Diastolique Moyenne (mmHg)
                                                    </label>
                                                    <input 
                                                        type="number" 
                                                        id="mapa_pad_24h" 
                                                        name="mapa_pad_24h" 
                                                        value="{{ old('mapa_pad_24h') }}"
                                                        step="0.1"
                                                        placeholder="80"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                    >
                                                </div>
                                                <div>
                                                    <label for="mapa_fc_24h" class="block text-xs font-medium text-gray-600 mb-1">
                                                        Fr√©quence Cardiaque Moyenne (bpm)
                                                    </label>
                                                    <input 
                                                        type="number" 
                                                        id="mapa_fc_24h" 
                                                        name="mapa_fc_24h" 
                                                        value="{{ old('mapa_fc_24h') }}"
                                                        step="0.1"
                                                        placeholder="70"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                                    >
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 3. Donn√©es D√©taill√©es par P√©riode -->
                                    <div class="border-b border-gray-200 pb-4">
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">3. Donn√©es D√©taill√©es par P√©riode</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <!-- P√©riode d'√âveil (Jour) -->
                                            <div class="bg-blue-50 p-4 rounded-lg">
                                                <h5 class="text-sm font-medium text-blue-800 mb-3">üåÖ P√©riode d'√âveil (Jour)</h5>
                                                <div class="space-y-3">
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <div>
                                                            <label for="mapa_day_start" class="block text-xs font-medium text-gray-600 mb-1">
                                                                Heure d√©but
                                                            </label>
                                                            <input 
                                                                type="time" 
                                                                id="mapa_day_start" 
                                                                name="mapa_day_start" 
                                                                value="{{ old('mapa_day_start', '06:00') }}"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                        <div>
                                                            <label for="mapa_day_end" class="block text-xs font-medium text-gray-600 mb-1">
                                                                Heure fin
                                                            </label>
                                                            <input 
                                                                type="time" 
                                                                id="mapa_day_end" 
                                                                name="mapa_day_end" 
                                                                value="{{ old('mapa_day_end', '22:00') }}"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-2">
                                                        <div>
                                                            <label for="mapa_pas_day" class="block text-xs font-medium text-gray-600 mb-1">
                                                                PAS (mmHg)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                id="mapa_pas_day" 
                                                                name="mapa_pas_day" 
                                                                value="{{ old('mapa_pas_day') }}"
                                                                step="0.1"
                                                                placeholder="125"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                        <div>
                                                            <label for="mapa_pad_day" class="block text-xs font-medium text-gray-600 mb-1">
                                                                PAD (mmHg)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                id="mapa_pad_day" 
                                                                name="mapa_pad_day" 
                                                                value="{{ old('mapa_pad_day') }}"
                                                                step="0.1"
                                                                placeholder="85"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                        <div>
                                                            <label for="mapa_fc_day" class="block text-xs font-medium text-gray-600 mb-1">
                                                                FC (bpm)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                id="mapa_fc_day" 
                                                                name="mapa_fc_day" 
                                                                value="{{ old('mapa_fc_day') }}"
                                                                step="0.1"
                                                                placeholder="75"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label for="mapa_load_day" class="block text-xs font-medium text-gray-600 mb-1">
                                                            Charge tensionnelle (%)
                                                        </label>
                                                        <input 
                                                            type="number" 
                                                            id="mapa_load_day" 
                                                            name="mapa_load_day" 
                                                            value="{{ old('mapa_load_day') }}"
                                                            step="0.1"
                                                            placeholder="15"
                                                            class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                        >
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- P√©riode de Sommeil (Nuit) -->
                                            <div class="bg-indigo-50 p-4 rounded-lg">
                                                <h5 class="text-sm font-medium text-indigo-800 mb-3">üåô P√©riode de Sommeil (Nuit)</h5>
                                                <div class="space-y-3">
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <div>
                                                            <label for="mapa_night_start" class="block text-xs font-medium text-gray-600 mb-1">
                                                                Heure d√©but
                                                            </label>
                                                            <input 
                                                                type="time" 
                                                                id="mapa_night_start" 
                                                                name="mapa_night_start" 
                                                                value="{{ old('mapa_night_start', '22:00') }}"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                        <div>
                                                            <label for="mapa_night_end" class="block text-xs font-medium text-gray-600 mb-1">
                                                                Heure fin
                                                            </label>
                                                            <input 
                                                                type="time" 
                                                                id="mapa_night_end" 
                                                                name="mapa_night_end" 
                                                                value="{{ old('mapa_night_end', '06:00') }}"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-2">
                                                        <div>
                                                            <label for="mapa_pas_night" class="block text-xs font-medium text-gray-600 mb-1">
                                                                PAS (mmHg)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                id="mapa_pas_night" 
                                                                name="mapa_pas_night" 
                                                                value="{{ old('mapa_pas_night') }}"
                                                                step="0.1"
                                                                placeholder="110"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                        <div>
                                                            <label for="mapa_pad_night" class="block text-xs font-medium text-gray-600 mb-1">
                                                                PAD (mmHg)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                id="mapa_pad_night" 
                                                                name="mapa_pad_night" 
                                                                value="{{ old('mapa_pad_night') }}"
                                                                step="0.1"
                                                                placeholder="70"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                        <div>
                                                            <label for="mapa_fc_night" class="block text-xs font-medium text-gray-600 mb-1">
                                                                FC (bpm)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                id="mapa_fc_night" 
                                                                name="mapa_fc_night" 
                                                                value="{{ old('mapa_fc_night') }}"
                                                                step="0.1"
                                                                placeholder="60"
                                                                class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                                            >
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label for="mapa_load_night" class="block text-xs font-medium text-gray-600 mb-1">
                                                            Charge tensionnelle (%)
                                                        </label>
                                                        <input 
                                                            type="number" 
                                                            id="mapa_load_night" 
                                                            name="mapa_load_night" 
                                                            value="{{ old('mapa_load_night') }}"
                                                            step="0.1"
                                                            placeholder="8"
                                                            class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 4. ECG d'Effort et Scintigraphie -->
                                    <!-- 4. Visualisation et Donn√©es Brutes -->
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">5. Visualisation et Donn√©es Brutes</h4>
                                        <div class="space-y-4">
                                            <!-- Graphique 24h (placeholder) -->
                                            <div class="bg-gray-50 p-4 rounded-lg">
                                                <h5 class="text-sm font-medium text-gray-700 mb-2">üìä Graphique sur 24 heures</h5>
                                                <div class="bg-white border border-gray-200 rounded-lg p-4 h-48 flex items-center justify-center">
                                                    <div class="text-center text-gray-500">
                                                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                        </svg>
                                                        <p class="text-sm">Graphique interactif 24h</p>
                                                        <p class="text-xs">PAS, PAD, FC avec p√©riodes jour/nuit</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Tableau des Mesures Individuelles -->
                                            <div class="bg-gray-50 p-4 rounded-lg">
                                                <h5 class="text-sm font-medium text-gray-700 mb-2">üìã Tableau des Mesures Individuelles</h5>
                                                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                                                    <div class="overflow-x-auto">
                                                        <table class="min-w-full divide-y divide-gray-200">
                                                            <thead class="bg-gray-50">
                                                                <tr>
                                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Heure</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PAS (mmHg)</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PAD (mmHg)</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FC (bpm)</th>
                                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P√©riode</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="bg-white divide-y divide-gray-200">
                                                                <tr class="text-xs">
                                                                    <td class="px-3 py-2 text-gray-900">06:00</td>
                                                                    <td class="px-3 py-2 text-gray-900">125</td>
                                                                    <td class="px-3 py-2 text-gray-900">85</td>
                                                                    <td class="px-3 py-2 text-gray-900">75</td>
                                                                    <td class="px-3 py-2"><span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Jour</span></td>
                                                                </tr>
                                                                <tr class="text-xs">
                                                                    <td class="px-3 py-2 text-gray-900">08:00</td>
                                                                    <td class="px-3 py-2 text-gray-900">130</td>
                                                                    <td class="px-3 py-2 text-gray-900">88</td>
                                                                    <td class="px-3 py-2 text-gray-900">78</td>
                                                                    <td class="px-3 py-2"><span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">Jour</span></td>
                                                                </tr>
                                                                <tr class="text-xs">
                                                                    <td class="px-3 py-2 text-gray-900">22:00</td>
                                                                    <td class="px-3 py-2 text-gray-900">110</td>
                                                                    <td class="px-3 py-2 text-gray-900">70</td>
                                                                    <td class="px-3 py-2 text-gray-900">60</td>
                                                                    <td class="px-3 py-2"><span class="px-2 py-1 text-xs font-medium bg-indigo-100 text-indigo-800 rounded-full">Nuit</span></td>
                                                                </tr>
                                                                <tr class="text-xs">
                                                                    <td class="px-3 py-2 text-gray-900">02:00</td>
                                                                    <td class="px-3 py-2 text-gray-900">105</td>
                                                                    <td class="px-3 py-2 text-gray-900">68</td>
                                                                    <td class="px-3 py-2 text-gray-900">58</td>
                                                                    <td class="px-3 py-2"><span class="px-2 py-1 text-xs font-medium bg-indigo-100 text-indigo-800 rounded-full">Nuit</span></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="bg-gray-50 px-4 py-2 text-xs text-gray-500">
                                                        <button type="button" class="text-purple-600 hover:text-purple-800 font-medium">
                                                            Voir toutes les mesures (48-72 mesures)
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                                        <button type="button" class="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                                            üíæ Enregistrer
                                        </button>
                                        <button type="button" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                            üñ®Ô∏è Imprimer le Rapport
                                        </button>
                                        <button type="button" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                            üìä Comparer avec l'examen pr√©c√©dent
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SCAT - Sport Concussion Assessment Tool -->
                        <div class="grid grid-cols-1 gap-6 mb-6">
                            <div>
                                <label for="scat_evaluation" class="block text-sm font-medium text-gray-700 mb-2">
                                    üß† SCAT - Sport Concussion Assessment Tool
                                </label>
                                
                                <!-- SCAT Comprehensive Interface -->
                                <div class="bg-white border border-gray-300 rounded-lg p-4 space-y-6">
                                    
                                    <!-- 1. Informations G√©n√©rales sur l'√âvaluation -->
                                    <div class="border-b border-gray-200 pb-4">
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">1. Informations G√©n√©rales sur l'√âvaluation</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label for="scat_date" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Date de l'√©valuation
                                                </label>
                                                <input 
                                                    type="date" 
                                                    id="scat_date" 
                                                    name="scat_date" 
                                                    value="{{ old('scat_date', date('Y-m-d')) }}"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                >
                                            </div>
                                            <div>
                                                <label for="scat_time" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Heure de l'√©valuation
                                                </label>
                                                <input 
                                                    type="time" 
                                                    id="scat_time" 
                                                    name="scat_time" 
                                                    value="{{ old('scat_time', date('H:i')) }}"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                >
                                            </div>
                                            <div>
                                                <label for="scat_context" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Contexte
                                                </label>
                                                <select 
                                                    id="scat_context" 
                                                    name="scat_context" 
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                >
                                                    <option value="">S√©lectionnez le contexte...</option>
                                                    <option value="terrain_match" {{ old('scat_context') == 'terrain_match' ? 'selected' : '' }}>Sur le terrain - Match</option>
                                                    <option value="clinique_suivi" {{ old('scat_context') == 'clinique_suivi' ? 'selected' : '' }}>En clinique - Suivi J+2</option>
                                                    <option value="bilan_pre_saison" {{ old('scat_context') == 'bilan_pre_saison' ? 'selected' : '' }}>Bilan pr√©-saison</option>
                                                    <option value="entrainement" {{ old('scat_context') == 'entrainement' ? 'selected' : '' }}>Entra√Ænement</option>
                                                    <option value="autre" {{ old('scat_context') == 'autre' ? 'selected' : '' }}>Autre</option>
                                                </select>
                                            </div>
                                            <div class="md:col-span-3">
                                                <label for="scat_evaluator" class="block text-xs font-medium text-gray-600 mb-1">
                                                    Nom de l'√©valuateur
                                                </label>
                                                <input 
                                                    type="text" 
                                                    id="scat_evaluator" 
                                                    name="scat_evaluator" 
                                                    value="{{ old('scat_evaluator') }}"
                                                    placeholder="Dr. [Nom] - M√©decin du sport"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                >
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 2. Signes d'Alerte et Sympt√¥mes -->
                                    <div class="border-b border-gray-200 pb-4">
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">2. Signes d'Alerte et Sympt√¥mes</h4>
                                        
                                        <!-- Drapeaux Rouges -->
                                        <div class="bg-red-50 p-4 rounded-lg mb-4">
                                            <h5 class="text-sm font-semibold text-red-800 mb-3">üö® Drapeaux Rouges (Red Flags)</h5>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_red_flags[]" value="douleur_cervicale" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                                    <span class="text-sm text-red-700">Douleur cervicale</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_red_flags[]" value="convulsions" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                                    <span class="text-sm text-red-700">Convulsions</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_red_flags[]" value="vomissements_repetes" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                                    <span class="text-sm text-red-700">Vomissements r√©p√©t√©s</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_red_flags[]" value="perte_conscience" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                                    <span class="text-sm text-red-700">Perte de conscience</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_red_flags[]" value="troubles_vision" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                                    <span class="text-sm text-red-700">Troubles de la vision</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_red_flags[]" value="faiblesse_membres" class="rounded border-gray-300 text-red-600 focus:ring-red-500">
                                                    <span class="text-sm text-red-700">Faiblesse des membres</span>
                                                </label>
                                            </div>
                                            <div id="red-flags-alert" class="hidden mt-3 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                                                <strong>‚ö†Ô∏è URGENCE M√âDICALE :</strong> Transfert m√©dical imm√©diat recommand√©
                                            </div>
                                        </div>

                                        <!-- Signes Observables -->
                                        <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                                            <h5 class="text-sm font-semibold text-yellow-800 mb-3">üëÅÔ∏è Signes Observables</h5>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_observable_signs[]" value="hebetude" class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                                                    <span class="text-sm text-yellow-700">Semble h√©b√©t√©</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_observable_signs[]" value="problemes_equilibre" class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                                                    <span class="text-sm text-yellow-700">Probl√®mes d'√©quilibre</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_observable_signs[]" value="confusion" class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                                                    <span class="text-sm text-yellow-700">Confusion</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_observable_signs[]" value="lenteur_mouvements" class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                                                    <span class="text-sm text-yellow-700">Lenteur des mouvements</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_observable_signs[]" value="troubles_parole" class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                                                    <span class="text-sm text-yellow-700">Troubles de la parole</span>
                                                </label>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_observable_signs[]" value="emotion_inappropriee" class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                                                    <span class="text-sm text-yellow-700">√âmotion inappropri√©e</span>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- √âvaluation des Sympt√¥mes -->
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <h5 class="text-sm font-semibold text-blue-800 mb-3">üìã √âvaluation des Sympt√¥mes (22 items)</h5>
                                            <div class="space-y-3">
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                                                    <div class="font-medium text-gray-700">Sympt√¥me</div>
                                                    <div class="font-medium text-gray-700 text-center">S√©v√©rit√© (0-6)</div>
                                                    <div class="font-medium text-gray-700 text-center">Score</div>
                                                </div>
                                                
                                                <!-- Sympt√¥mes individuels -->
                                                <div class="space-y-2">
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                                        <div class="text-sm">Maux de t√™te</div>
                                                        <div class="flex items-center space-x-2">
                                                            <input type="range" min="0" max="6" value="0" class="w-full" name="scat_headache" id="scat_headache">
                                                            <span class="text-xs w-8 text-center" id="scat_headache_value">0</span>
                                                        </div>
                                                        <div class="text-xs text-center" id="scat_headache_score">0</div>
                                                    </div>
                                                    
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                                        <div class="text-sm">Naus√©es</div>
                                                        <div class="flex items-center space-x-2">
                                                            <input type="range" min="0" max="6" value="0" class="w-full" name="scat_nausea" id="scat_nausea">
                                                            <span class="text-xs w-8 text-center" id="scat_nausea_value">0</span>
                                                        </div>
                                                        <div class="text-xs text-center" id="scat_nausea_score">0</div>
                                                    </div>
                                                    
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                                        <div class="text-sm">Vertiges</div>
                                                        <div class="flex items-center space-x-2">
                                                            <input type="range" min="0" max="6" value="0" class="w-full" name="scat_dizziness" id="scat_dizziness">
                                                            <span class="text-xs w-8 text-center" id="scat_dizziness_value">0</span>
                                                        </div>
                                                        <div class="text-xs text-center" id="scat_dizziness_score">0</div>
                                                    </div>
                                                    
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                                        <div class="text-sm">Fatigue</div>
                                                        <div class="flex items-center space-x-2">
                                                            <input type="range" min="0" max="6" value="0" class="w-full" name="scat_fatigue" id="scat_fatigue">
                                                            <span class="text-xs w-8 text-center" id="scat_fatigue_value">0</span>
                                                        </div>
                                                        <div class="text-xs text-center" id="scat_fatigue_score">0</div>
                                                    </div>
                                                    
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                                        <div class="text-sm">Sensibilit√© √† la lumi√®re</div>
                                                        <div class="flex items-center space-x-2">
                                                            <input type="range" min="0" max="6" value="0" class="w-full" name="scat_light_sensitivity" id="scat_light_sensitivity">
                                                            <span class="text-xs w-8 text-center" id="scat_light_sensitivity_value">0</span>
                                                        </div>
                                                        <div class="text-xs text-center" id="scat_light_sensitivity_score">0</div>
                                                    </div>
                                                    
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                                        <div class="text-sm">Sensibilit√© au bruit</div>
                                                        <div class="flex items-center space-x-2">
                                                            <input type="range" min="0" max="6" value="0" class="w-full" name="scat_noise_sensitivity" id="scat_noise_sensitivity">
                                                            <span class="text-xs w-8 text-center" id="scat_noise_sensitivity_value">0</span>
                                                        </div>
                                                        <div class="text-xs text-center" id="scat_noise_sensitivity_score">0</div>
                                                    </div>
                                                </div>
                                                
                                                <!-- R√©sum√© des scores -->
                                                <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                        <div>
                                                            <strong>Nombre total de sympt√¥mes :</strong>
                                                            <span id="total_symptoms" class="ml-2 font-bold text-blue-800">0</span>
                                                        </div>
                                                        <div>
                                                            <strong>Score total de s√©v√©rit√© :</strong>
                                                            <span id="total_severity" class="ml-2 font-bold text-blue-800">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 3. √âvaluation Cognitive et Neurologique -->
                                    <div class="border-b border-gray-200 pb-4">
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">3. √âvaluation Cognitive et Neurologique</h4>
                                        
                                        <!-- Bilan Cognitif (SAC) -->
                                        <div class="bg-green-50 p-4 rounded-lg mb-4">
                                            <h5 class="text-sm font-semibold text-green-800 mb-3">üß† Bilan Cognitif (SAC - Standardised Assessment of Concussion)</h5>
                                            <div class="space-y-4">
                                                <!-- Orientation -->
                                                <div>
                                                    <h6 class="text-sm font-medium text-green-700 mb-2">Orientation (Score /5)</h6>
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">Mois</label>
                                                            <input type="text" name="scat_orientation_month" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">Date</label>
                                                            <input type="text" name="scat_orientation_date" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">Ann√©e</label>
                                                            <input type="text" name="scat_orientation_year" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">Heure</label>
                                                            <input type="text" name="scat_orientation_time" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs text-gray-600 mb-1">Jour de la semaine</label>
                                                            <input type="text" name="scat_orientation_day" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 text-xs">
                                                        <strong>Score Orientation :</strong> <span id="orientation_score" class="font-bold text-green-700">0</span>/5
                                                    </div>
                                                </div>

                                                <!-- M√©moire Imm√©diate -->
                                                <div>
                                                    <h6 class="text-sm font-medium text-green-700 mb-2">M√©moire Imm√©diate (Score /15)</h6>
                                                    <div class="space-y-2">
                                                        <div class="text-xs text-gray-600">Mots √† retenir : <strong>√âL√âPHANT, PERSIL, TR√âSOR, CHAUDI√àRE, B√âTON</strong></div>
                                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                            <div>
                                                                <label class="block text-xs text-gray-600 mb-1">Essai 1</label>
                                                                <input type="text" name="scat_immediate_memory_trial1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs text-gray-600 mb-1">Essai 2</label>
                                                                <input type="text" name="scat_immediate_memory_trial2" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs text-gray-600 mb-1">Essai 3</label>
                                                                <input type="text" name="scat_immediate_memory_trial3" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                            </div>
                                                        </div>
                                                        <div class="mt-2 text-xs">
                                                            <strong>Score M√©moire Imm√©diate :</strong> <span id="immediate_memory_score" class="font-bold text-green-700">0</span>/15
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Concentration -->
                                                <div>
                                                    <h6 class="text-sm font-medium text-green-700 mb-2">Concentration (Score /5)</h6>
                                                    <div class="space-y-2">
                                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                            <div>
                                                                <label class="block text-xs text-gray-600 mb-1">S√©rie de chiffres (√† l'envers)</label>
                                                                <input type="text" name="scat_concentration_digits" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs text-gray-600 mb-1">Mois √† l'envers</label>
                                                                <input type="text" name="scat_concentration_months" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                            </div>
                                                        </div>
                                                        <div class="mt-2 text-xs">
                                                            <strong>Score Concentration :</strong> <span id="concentration_score" class="font-bold text-green-700">0</span>/5
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Rappel Diff√©r√© -->
                                                <div>
                                                    <h6 class="text-sm font-medium text-green-700 mb-2">Rappel Diff√©r√© (Score /5)</h6>
                                                    <div>
                                                        <input type="text" name="scat_delayed_recall" placeholder="Rappel des 5 mots..." class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                    </div>
                                                    <div class="mt-2 text-xs">
                                                        <strong>Score Rappel Diff√©r√© :</strong> <span id="delayed_recall_score" class="font-bold text-green-700">0</span>/5
                                                    </div>
                                                </div>

                                                <!-- Score SAC Total -->
                                                <div class="mt-4 p-3 bg-green-100 rounded-lg">
                                                    <div class="text-sm font-bold text-green-800">
                                                        <strong>Score SAC Total :</strong> <span id="sac_total_score" class="text-lg">0</span>/30
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Examen Neurologique et √âquilibre -->
                                        <div class="bg-purple-50 p-4 rounded-lg">
                                            <h5 class="text-sm font-semibold text-purple-800 mb-3">‚öñÔ∏è Examen Neurologique et √âquilibre</h5>
                                            
                                            <!-- Bilan de l'√âquilibre (mBESS) -->
                                            <div class="mb-4">
                                                <h6 class="text-sm font-medium text-purple-700 mb-2">Bilan de l'√âquilibre (mBESS)</h6>
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <h7 class="text-xs font-medium text-gray-600">Position 1 : Pieds joints</h7>
                                                        <div class="space-y-1 mt-1">
                                                            <div class="flex justify-between text-xs">
                                                                <span>Surface ferme</span>
                                                                <input type="number" min="0" max="10" name="scat_mbess_firm_feet" class="w-12 px-1 py-1 border border-gray-300 rounded text-xs">
                                                            </div>
                                                            <div class="flex justify-between text-xs">
                                                                <span>Surface molle</span>
                                                                <input type="number" min="0" max="10" name="scat_mbess_foam_feet" class="w-12 px-1 py-1 border border-gray-300 rounded text-xs">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h7 class="text-xs font-medium text-gray-600">Position 2 : Tandem</h7>
                                                        <div class="space-y-1 mt-1">
                                                            <div class="flex justify-between text-xs">
                                                                <span>Surface ferme</span>
                                                                <input type="number" min="0" max="10" name="scat_mbess_firm_tandem" class="w-12 px-1 py-1 border border-gray-300 rounded text-xs">
                                                            </div>
                                                            <div class="flex justify-between text-xs">
                                                                <span>Surface molle</span>
                                                                <input type="number" min="0" max="10" name="scat_mbess_foam_tandem" class="w-12 px-1 py-1 border border-gray-300 rounded text-xs">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <h7 class="text-xs font-medium text-gray-600">Position 3 : Appui unipodal</h7>
                                                        <div class="space-y-1 mt-1">
                                                            <div class="flex justify-between text-xs">
                                                                <span>Surface ferme</span>
                                                                <input type="number" min="0" max="10" name="scat_mbess_firm_single" class="w-12 px-1 py-1 border border-gray-300 rounded text-xs">
                                                            </div>
                                                            <div class="flex justify-between text-xs">
                                                                <span>Surface molle</span>
                                                                <input type="number" min="0" max="10" name="scat_mbess_foam_single" class="w-12 px-1 py-1 border border-gray-300 rounded text-xs">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mt-3 text-xs">
                                                    <strong>Score d'erreur total mBESS :</strong> <span id="mbess_total_score" class="font-bold text-purple-700">0</span>
                                                </div>
                                            </div>

                                            <!-- Examen de la Colonne Cervicale -->
                                            <div>
                                                <h6 class="text-sm font-medium text-purple-700 mb-2">Examen de la Colonne Cervicale</h6>
                                                <label class="flex items-center space-x-2">
                                                    <input type="checkbox" name="scat_cervical_normal" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                                                    <span class="text-sm text-purple-700">Absence de douleur ou de sensibilit√© cervicale</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 4. D√©cision M√©dicale et Plan de Suivi -->
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-800 mb-3">4. D√©cision M√©dicale et Plan de Suivi</h4>
                                        <div class="space-y-4">
                                            <!-- Diagnostic / D√©cision -->
                                            <div>
                                                <label for="scat_diagnosis" class="block text-sm font-medium text-gray-700 mb-2">
                                                    Diagnostic / D√©cision
                                                </label>
                                                <select 
                                                    id="scat_diagnosis" 
                                                    name="scat_diagnosis" 
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                                >
                                                    <option value="">S√©lectionnez le diagnostic...</option>
                                                    <option value="concussion_diagnosed" {{ old('scat_diagnosis') == 'concussion_diagnosed' ? 'selected' : '' }}>Commotion c√©r√©brale diagnostiqu√©e</option>
                                                    <option value="no_concussion" {{ old('scat_diagnosis') == 'no_concussion' ? 'selected' : '' }}>Pas de commotion c√©r√©brale</option>
                                                    <option value="uncertain_surveillance" {{ old('scat_diagnosis') == 'uncertain_surveillance' ? 'selected' : '' }}>Diagnostic incertain, surveillance requise</option>
                                                </select>
                                            </div>

                                            <!-- R√©sum√© et Plan de Suivi -->
                                            <div>
                                                <label for="scat_follow_up_plan" class="block text-sm font-medium text-gray-700 mb-2">
                                                    R√©sum√© et Plan de Suivi
                                                </label>
                                                <textarea 
                                                    id="scat_follow_up_plan" 
                                                    name="scat_follow_up_plan" 
                                                    rows="6"
                                                    placeholder="Conclusions de l'√©valuation, plan de retour au jeu progressif (Return-to-Play), rendez-vous de suivi, recommandations..."
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                                >{{ old('scat_follow_up_plan') }}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">
                                        <button type="button" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                            üíæ Enregistrer l'√©valuation
                                        </button>
                                        <button type="button" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                            üñ®Ô∏è Imprimer le rapport SCAT officiel
                                        </button>
                                        <button type="button" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                            üìä Comparer avec le bilan de r√©f√©rence
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medical Imaging Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="mri_results" class="block text-sm font-medium text-gray-700 mb-2">
                                    üß† IRM - Imagerie par R√©sonance Magn√©tique (LOINC: 18748-4)
                                </label>
                                <textarea 
                                    id="mri_results" 
                                    name="mri_results" 
                                    rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="R√©sultats IRM, zones anatomiques, pathologies d√©tect√©es..."
                                >{{ old('mri_results') }}</textarea>
                            </div>
                        </div>


                    </div>

                    <!-- Medical Imaging Upload Section -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <h3 class="text-lg font-semibold text-green-900">üì∑ Imagerie M√©dicale</h3>
                        </div>
                        <p class="text-green-700 mb-4">T√©l√©chargez et analysez les images m√©dicales avec l'IA</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- ECG Upload -->
                            <div>
                                <label for="ecg_file" class="block text-sm font-medium text-gray-700 mb-2">
                                    üìà ECG / Cardiogramme
                                </label>
                                <input 
                                    type="file" 
                                    id="ecg_file" 
                                    name="ecg_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.dcm,.bmp,.tiff,.tif"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                >
                                <p class="text-xs text-gray-500 mt-1">Formats: PDF, JPG, PNG, DICOM, BMP, TIFF</p>
                            </div>
                            
                            <!-- MRI Upload -->
                            <div>
                                <label for="mri_files" class="block text-sm font-medium text-gray-700 mb-2">
                                    üß† IRM / Scanner (Multiples)
                                </label>
                                <input 
                                    type="file" 
                                    id="mri_files" 
                                    name="mri_files[]"
                                    multiple
                                    accept=".pdf,.jpg,.jpeg,.png,.dcm,.bmp,.tiff,.tif"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                >
                                <p class="text-xs text-gray-500 mt-1">Formats: PDF, JPG, PNG, DICOM, BMP, TIFF (S√©lectionnez plusieurs fichiers)</p>
                                <div id="mri-files-preview" class="mt-2 space-y-1"></div>
                            </div>
                            
                            <!-- CT Scan Upload -->
                            <div>
                                <label for="ct_files" class="block text-sm font-medium text-gray-700 mb-2">
                                    üè• Scanner CT (Multiples)
                                </label>
                                <input 
                                    type="file" 
                                    id="ct_files" 
                                    name="ct_files[]"
                                    multiple
                                    accept=".pdf,.jpg,.jpeg,.png,.dcm,.bmp,.tiff,.tif"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                >
                                <p class="text-xs text-gray-500 mt-1">Formats: PDF, JPG, PNG, DICOM, BMP, TIFF (S√©lectionnez plusieurs fichiers)</p>
                                <div id="ct-files-preview" class="mt-2 space-y-1"></div>
                            </div>
                            
                            <!-- X-Ray Upload -->
                            <div>
                                <label for="xray_file" class="block text-sm font-medium text-gray-700 mb-2">
                                    ü¶¥ Radiographie
                                </label>
                                <input 
                                    type="file" 
                                    id="xray_file" 
                                    name="xray_file"
                                    accept=".pdf,.jpg,.jpeg,.png,.dcm"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                >
                                <p class="text-xs text-gray-500 mt-1">Formats: PDF, JPG, PNG, DICOM</p>
                            </div>
                        </div>

                        <!-- ECG d'Effort et Scintigraphie Modules -->
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- ECG d'Effort Module -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-green-800 mb-3">üìà ECG d'Effort (LOINC: 11524-6)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label for="ecg_effort_date" class="block text-xs font-medium text-gray-600 mb-1">
                                            Date de l'examen
                                        </label>
                                        <input 
                                            type="date" 
                                            id="ecg_effort_date" 
                                            name="ecg_effort_date" 
                                            value="{{ old('ecg_effort_date', date('Y-m-d')) }}"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                        >
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label for="ecg_effort_max_fc" class="block text-xs font-medium text-gray-600 mb-1">
                                                Fr√©quence Cardiaque Max (bpm)
                                            </label>
                                            <input 
                                                type="number" 
                                                id="ecg_effort_max_fc" 
                                                name="ecg_effort_max_fc" 
                                                value="{{ old('ecg_effort_max_fc') }}"
                                                placeholder="180"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                            >
                                        </div>
                                        <div>
                                            <label for="ecg_effort_duration" class="block text-xs font-medium text-gray-600 mb-1">
                                                Dur√©e du test (minutes)
                                            </label>
                                            <input 
                                                type="number" 
                                                id="ecg_effort_duration" 
                                                name="ecg_effort_duration" 
                                                value="{{ old('ecg_effort_duration') }}"
                                                placeholder="12"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                            >
                                        </div>
                                    </div>
                                    <div>
                                        <label for="ecg_effort_file" class="block text-xs font-medium text-gray-600 mb-1">
                                            üìÅ Choisir un fichier ECG
                                        </label>
                                        <input 
                                            type="file" 
                                            id="ecg_effort_file" 
                                            name="ecg_effort_file"
                                            accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.tif,.dcm,.svg,.webp"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                        >
                                        <p class="text-xs text-gray-500 mt-1">Formats accept√©s: PDF, JPG, PNG, GIF, BMP, TIFF, DICOM, SVG, WEBP</p>
                                    </div>
                                    <div>
                                        <label for="ecg_effort_results" class="block text-xs font-medium text-gray-600 mb-1">
                                            R√©sultats et Anomalies
                                        </label>
                                        <textarea 
                                            id="ecg_effort_results" 
                                            name="ecg_effort_results" 
                                            rows="3"
                                            placeholder="Test d'effort, fr√©quence max, anomalies d√©tect√©es..."
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                        >{{ old('ecg_effort_results') }}</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Scintigraphie Module -->
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-orange-800 mb-3">‚ò¢Ô∏è Scintigraphie (LOINC: 18748-4)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label for="scintigraphy_date" class="block text-xs font-medium text-gray-600 mb-1">
                                            Date de l'examen
                                        </label>
                                        <input 
                                            type="date" 
                                            id="scintigraphy_date" 
                                            name="scintigraphy_date" 
                                            value="{{ old('scintigraphy_date', date('Y-m-d')) }}"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                                        >
                                    </div>
                                    <div>
                                        <label for="scintigraphy_type" class="block text-xs font-medium text-gray-600 mb-1">
                                            Type de Scintigraphie
                                        </label>
                                        <select 
                                            id="scintigraphy_type" 
                                            name="scintigraphy_type" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                                        >
                                            <option value="">S√©lectionnez le type...</option>
                                            <option value="osseuse" {{ old('scintigraphy_type') == 'osseuse' ? 'selected' : '' }}>Scintigraphie osseuse</option>
                                            <option value="myocardique" {{ old('scintigraphy_type') == 'myocardique' ? 'selected' : '' }}>Scintigraphie myocardique</option>
                                            <option value="pulmonaire" {{ old('scintigraphy_type') == 'pulmonaire' ? 'selected' : '' }}>Scintigraphie pulmonaire</option>
                                            <option value="renale" {{ old('scintigraphy_type') == 'renale' ? 'selected' : '' }}>Scintigraphie r√©nale</option>
                                            <option value="thyroidienne" {{ old('scintigraphy_type') == 'thyroidienne' ? 'selected' : '' }}>Scintigraphie thyro√Ødienne</option>
                                            <option value="autre" {{ old('scintigraphy_type') == 'autre' ? 'selected' : '' }}>Autre</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="scintigraphy_file" class="block text-xs font-medium text-gray-600 mb-1">
                                            üìÅ Choisir un fichier Scintigraphie
                                        </label>
                                        <input 
                                            type="file" 
                                            id="scintigraphy_file" 
                                            name="scintigraphy_file"
                                            accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.tif,.dcm,.svg,.webp"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                                        >
                                        <p class="text-xs text-gray-500 mt-1">Formats accept√©s: PDF, JPG, PNG, GIF, BMP, TIFF, DICOM, SVG, WEBP</p>
                                    </div>
                                    <div>
                                        <label for="scintigraphy_results" class="block text-xs font-medium text-gray-600 mb-1">
                                            R√©sultats et Interpr√©tation
                                        </label>
                                        <textarea 
                                            id="scintigraphy_results" 
                                            name="scintigraphy_results" 
                                            rows="3"
                                            placeholder="Scintigraphie osseuse, myocardique, autres explorations..."
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                                        >{{ old('scintigraphy_results') }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis Section -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <h3 class="text-lg font-semibold text-purple-900">ü§ñ Analyse IA M√©dicale</h3>
                        </div>
                        <p class="text-purple-700 mb-4">Analysez automatiquement les images m√©dicales avec l'IA Med-Gemini</p>
                        
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button 
                                type="button" 
                                id="ai-check-ecg-btn"
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center"
                            >
                                üîç Analyser ECG
                            </button>
                            <button 
                                type="button" 
                                id="ai-check-ecg-effort-btn"
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center"
                            >
                                üìà Analyser ECG d'Effort
                            </button>
                            <button 
                                type="button" 
                                id="ai-check-scintigraphy-btn"
                                class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors flex items-center"
                            >
                                ‚ò¢Ô∏è Analyser Scintigraphie
                            </button>
                            <button 
                                type="button" 
                                id="ai-check-scat-btn"
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex items-center"
                            >
                                üß† Analyser SCAT
                            </button>
                            <button 
                                type="button" 
                                id="ai-check-mri-btn"
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center"
                            >
                                üß† Analyser IRM
                            </button>
                            <button 
                                type="button" 
                                id="ai-check-ct-btn"
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center"
                            >
                                üè• Analyser CT
                            </button>
                            <button 
                                type="button" 
                                id="ai-check-xray-btn"
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center"
                            >
                                ü¶¥ Analyser Radiographie
                            </button>
                            <button 
                                type="button" 
                                id="ai-check-all-btn"
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center"
                            >
                                üöÄ Analyse Compl√®te
                            </button>
                        </div>
                        
                        <div id="ai-analysis-status" class="hidden mb-4">
                            <div class="flex items-center">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-2"></div>
                                <span class="text-purple-700">Analyse en cours...</span>
                            </div>
                        </div>
                        
                        <div id="ai-analysis-results" class="hidden bg-white border border-purple-200 rounded-lg p-4">
                            <h4 class="text-md font-semibold text-purple-900 mb-3">R√©sultats de l'Analyse IA</h4>
                            <div id="ai-results-content" class="text-sm text-gray-700"></div>
                            <div id="hl7-cda-status" class="hidden mt-3">
                                <div class="flex items-center">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                                    <span class="text-blue-700">G√©n√©ration du rapport HL7 CDA...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DICOM Viewer Section -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <h3 class="text-lg font-semibold text-green-900">üîç Visualiseur DICOM</h3>
                        </div>
                        <p class="text-green-700 mb-4">Visualisez et analysez les images m√©dicales</p>
                        
                        <div class="mb-4">
                            <label for="dicom-viewer-select" class="block text-sm font-medium text-gray-700 mb-2">
                                S√©lectionner un fichier √† visualiser
                            </label>
                            <select 
                                id="dicom-viewer-select" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            >
                                <option value="">Choisir un fichier...</option>
                                <option value="ecg">ECG / Cardiogramme</option>
                                <option value="mri">IRM / Scanner</option>
                                <option value="xray">Radiographie</option>
                            </select>
                        </div>
                        
                        <!-- Viewer Controls -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button type="button" id="dicom-zoom-in" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                üîç+
                            </button>
                            <button type="button" id="dicom-zoom-out" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                üîç-
                            </button>
                            <button type="button" id="dicom-reset" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">
                                üîÑ Reset
                            </button>
                            <button type="button" id="dicom-fullscreen" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                ‚õ∂ Plein √©cran
                            </button>
                        </div>
                        
                        <!-- Measurement Tools -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button type="button" id="dicom-measure-distance" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                üìè Distance
                            </button>
                            <button type="button" id="dicom-measure-angle" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                üìê Angle
                            </button>
                            <button type="button" id="dicom-measure-surface" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                üìä Surface
                            </button>
                        </div>
                        
                        <!-- Viewer Canvas -->
                        <div class="border border-gray-300 rounded-lg overflow-hidden bg-gray-100" style="height: 400px;">
                            <div id="dicom-loading" class="hidden flex items-center justify-center h-full">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                    <p class="text-gray-600">Chargement de l'image...</p>
                                </div>
                            </div>
                            
                            <div id="dicom-error" class="hidden flex items-center justify-center h-full">
                                <div class="text-center text-red-600">
                                    <p>Erreur lors du chargement de l'image</p>
                                </div>
                            </div>
                            
                            <div id="dicom-placeholder" class="flex items-center justify-center h-full">
                                <div class="text-center text-gray-500">
                                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <p>S√©lectionnez un fichier pour commencer la visualisation</p>
                                </div>
                            </div>
                            
                            <canvas id="dicom-canvas" class="hidden w-full h-full cursor-crosshair"></canvas>
                        </div>
                        
                        <!-- Metadata and Measurements -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div id="dicom-metadata" class="hidden bg-white border border-gray-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-gray-900 mb-2">M√©tadonn√©es</h4>
                                <div class="text-xs text-gray-600 space-y-1">
                                    <div><strong>Type:</strong> <span id="dicom-file-type">-</span></div>
                                    <div><strong>Dimensions:</strong> <span id="dicom-image-dimensions">-</span></div>
                                    <div><strong>Format:</strong> <span id="dicom-format">-</span></div>
                                    <div><strong>Taille:</strong> <span id="dicom-file-size">-</span></div>
                                </div>
                            </div>
                            
                            <div id="dicom-measurements" class="hidden bg-white border border-gray-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-gray-900 mb-2">Mesures</h4>
                                <div id="dicom-measurements-content" class="text-xs text-gray-600">
                                    <p>Aucune mesure effectu√©e</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Diagnosis and Treatment -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="diagnosis" class="block text-sm font-medium text-gray-700 mb-2">
                                Diagnostic
                            </label>
                            <textarea 
                                id="diagnosis" 
                                name="diagnosis" 
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Diagnostic √©tabli..."
                            >{{ old('diagnosis') }}</textarea>
                        </div>
                        
                        <div>
                            <label for="treatment_plan" class="block text-sm font-medium text-gray-700 mb-2">
                                Plan de Traitement
                            </label>
                            <textarea 
                                id="treatment_plan" 
                                name="treatment_plan" 
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Plan de traitement recommand√©..."
                            >{{ old('treatment_plan') }}</textarea>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="record_date" class="block text-sm font-medium text-gray-700 mb-2">
                                Date de Consultation *
                            </label>
                            <input 
                                type="date" 
                                id="record_date" 
                                name="record_date" 
                                value="{{ old('record_date', date('Y-m-d')) }}"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        
                        <div>
                            <label for="next_checkup_date" class="block text-sm font-medium text-gray-700 mb-2">
                                Prochaine Consultation
                            </label>
                            <input 
                                type="date" 
                                id="next_checkup_date" 
                                name="next_checkup_date" 
                                value="{{ old('next_checkup_date') }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional EMR Fields -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">üìã Informations Compl√©mentaires de la Visite</h2>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- Physical Examination -->
                    <div>
                        <label for="physical_examination" class="block text-sm font-medium text-gray-700 mb-2">
                            Examen Physique
                        </label>
                        <textarea 
                            id="physical_examination" 
                            name="physical_examination" 
                            rows="4"
                            placeholder="D√©tails de l'examen physique..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >{{ old('physical_examination') }}</textarea>
                    </div>

                    <!-- Laboratory Results -->
                    <div>
                        <label for="laboratory_results" class="block text-sm font-medium text-gray-700 mb-2">
                            R√©sultats de Laboratoire
                        </label>
                        <textarea 
                            id="laboratory_results" 
                            name="laboratory_results" 
                            rows="4"
                            placeholder="R√©sultats des analyses de laboratoire..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >{{ old('laboratory_results') }}</textarea>
                    </div>

                    <!-- Imaging Results -->
                    <div>
                        <label for="imaging_results" class="block text-sm font-medium text-gray-700 mb-2">
                            R√©sultats d'Imagerie
                        </label>
                        <textarea 
                            id="imaging_results" 
                            name="imaging_results" 
                            rows="4"
                            placeholder="R√©sultats des examens d'imagerie (radiographie, √©chographie, etc.)..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >{{ old('imaging_results') }}</textarea>
                    </div>

                    <!-- Prescriptions -->
                    <div>
                        <label for="prescriptions" class="block text-sm font-medium text-gray-700 mb-2">
                            Prescriptions
                        </label>
                        <textarea 
                            id="prescriptions" 
                            name="prescriptions" 
                            rows="4"
                            placeholder="M√©dicaments prescrits et posologie..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >{{ old('prescriptions') }}</textarea>
                    </div>

                    <!-- Follow-up Instructions -->
                    <div>
                        <label for="follow_up_instructions" class="block text-sm font-medium text-gray-700 mb-2">
                            Instructions de Suivi
                        </label>
                        <textarea 
                            id="follow_up_instructions" 
                            name="follow_up_instructions" 
                            rows="4"
                            placeholder="Instructions pour le suivi et les prochaines √©tapes..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >{{ old('follow_up_instructions') }}</textarea>
                    </div>

                    <!-- Visit Notes -->
                    <div>
                        <label for="visit_notes" class="block text-sm font-medium text-gray-700 mb-2">
                            Notes de la Visite
                        </label>
                        <textarea 
                            id="visit_notes" 
                            name="visit_notes" 
                            rows="4"
                            placeholder="Notes suppl√©mentaires de la visite..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >{{ old('visit_notes') }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-between items-center">
                <a href="{{ route('health-records.index') }}" 
                   class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    ‚Üê Retour √† la liste
                </a>
                
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                    üíæ Enregistrer la Visite M√©dicale
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('First DOMContentLoaded event listener starting...');
        const aiAnalyzeBtn = document.getElementById('ai-analyze-btn');
        const clearNotesBtn = document.getElementById('clear-notes-btn');
        const clinicalNotes = document.getElementById('clinical_notes');
        const aiResults = document.getElementById('ai-results');
        const aiContent = document.getElementById('ai-content');
        
        console.log('AI elements found:', {
            aiAnalyzeBtn: !!aiAnalyzeBtn,
            clearNotesBtn: !!clearNotesBtn,
            clinicalNotes: !!clinicalNotes,
            aiResults: !!aiResults,
            aiContent: !!aiContent
        });

    // AI Analysis for Clinical Notes
    aiAnalyzeBtn.addEventListener('click', async function() {
        const notes = clinicalNotes.value.trim();
        if (!notes) {
            alert('Veuillez saisir des notes cliniques pour l\'analyse IA');
            return;
        }

        aiAnalyzeBtn.disabled = true;
        aiAnalyzeBtn.textContent = 'üîç Analyse en cours...';

        try {
            const response = await fetch('/api/v1/pcmas/prefill-from-transcript', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    transcript: notes,
                    athlete_id: document.getElementById('player_id').value || 1,
                    pcma_type: 'general'
                })
            });

            const data = await response.json();
            
            if (data.success) {
                aiContent.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <span class="text-green-600 font-semibold">‚úì Analyse IA termin√©e</span>
                            <span class="ml-2 text-sm text-gray-500">Confiance: ${Math.round((data.confidence_score || 0.7) * 100)}%</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <h4 class="font-semibold text-gray-900 mb-2">Donn√©es extraites:</h4>
                            <ul class="text-sm text-gray-700 space-y-1">
                                ${Object.entries(data.data || {}).map(([key, value]) => 
                                    `<li><strong>${key}:</strong> ${value || 'Non d√©tect√©'}</li>`
                                ).join('')}
                            </ul>
                        </div>
                        <button type="button" id="apply-ai-data" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Appliquer les donn√©es IA aux champs
                        </button>
                    </div>
                `;
                aiResults.classList.remove('hidden');
            } else {
                aiContent.innerHTML = `
                    <div class="text-red-600">
                        <p>Erreur lors de l'analyse IA: ${data.message || 'Erreur inconnue'}</p>
                    </div>
                `;
                aiResults.classList.remove('hidden');
            }
        } catch (error) {
            aiContent.innerHTML = `
                <div class="text-red-600">
                    <p>Erreur de connexion: ${error.message}</p>
                </div>
            `;
            aiResults.classList.remove('hidden');
        } finally {
            aiAnalyzeBtn.disabled = false;
            aiAnalyzeBtn.textContent = 'üîç Analyser avec l\'IA';
        }
    });

    // Clear Notes
    clearNotesBtn.addEventListener('click', function() {
        clinicalNotes.value = '';
        aiResults.classList.add('hidden');
    });

    // Apply AI Data
    document.addEventListener('click', function(e) {
        if (e.target.id === 'apply-ai-data') {
            // This would populate form fields with AI-extracted data
            alert('Fonctionnalit√© d\'application des donn√©es IA en cours de d√©veloppement');
        }
    });

    // Medical Imaging AI Analysis
    const aiCheckEcgBtn = document.getElementById('ai-check-ecg-btn');
    const aiCheckMriBtn = document.getElementById('ai-check-mri-btn');
    const aiCheckXrayBtn = document.getElementById('ai-check-xray-btn');
    const aiCheckAllBtn = document.getElementById('ai-check-all-btn');
    const aiAnalysisStatus = document.getElementById('ai-analysis-status');
    const aiAnalysisResults = document.getElementById('ai-analysis-results');
    const aiResultsContent = document.getElementById('ai-results-content');

    // AI Analysis for ECG
    aiCheckEcgBtn.addEventListener('click', async function() {
        const ecgFile = document.getElementById('ecg_file').files[0];
        if (!ecgFile) {
            alert('Veuillez s√©lectionner un fichier ECG pour l\'analyse');
            return;
        }

        const formData = new FormData();
        formData.append('ecg_file', ecgFile);

        aiCheckEcgBtn.disabled = true;
        aiCheckEcgBtn.textContent = 'üîç Analyse ECG...';
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-ecg") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
                               if (data.success) {
                       // Handle nested response structure from AI service
                       const analysisData = data.analysis || data;
                       displayAIResults(analysisData, 'ECG');
                   } else {
                       displayAIError(data.message || 'Erreur lors de l\'analyse ECG');
                   }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckEcgBtn.disabled = false;
            aiCheckEcgBtn.textContent = 'üîç Analyser ECG';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    // AI Analysis for MRI
    aiCheckMriBtn.addEventListener('click', async function() {
        const mriFiles = document.getElementById('mri_files').files;
        if (!mriFiles || mriFiles.length === 0) {
            alert('Veuillez s√©lectionner au moins un fichier IRM pour l\'analyse');
            return;
        }

        const formData = new FormData();
        // Add all MRI files
        for (let i = 0; i < mriFiles.length; i++) {
            formData.append('mri_files[]', mriFiles[i]);
        }

        aiCheckMriBtn.disabled = true;
        aiCheckMriBtn.textContent = `üß† Analyse IRM (${mriFiles.length} fichier${mriFiles.length > 1 ? 's' : ''})...`;
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-mri") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                // Handle nested response structure from AI service
                const analysisData = data.analysis || data;
                displayAIResults(analysisData, 'IRM');
            } else {
                displayAIError(data.message || 'Erreur lors de l\'analyse IRM');
            }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckMriBtn.disabled = false;
            aiCheckMriBtn.textContent = 'üß† Analyser IRM';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    // AI Analysis for X-Ray
    aiCheckXrayBtn.addEventListener('click', async function() {
        const xrayFile = document.getElementById('xray_file').files[0];
        if (!xrayFile) {
            alert('Veuillez s√©lectionner un fichier radiographie pour l\'analyse');
            return;
        }

        const formData = new FormData();
        formData.append('xray_file', xrayFile);

        aiCheckXrayBtn.disabled = true;
        aiCheckXrayBtn.textContent = 'ü¶¥ Analyse Radiographie...';
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-xray") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
                                           if (data.success) {
                // Handle nested response structure from AI service
                const analysisData = data.analysis || data;
                console.log('X-ray analysis data before displayAIResults:', analysisData);
                displayAIResults(analysisData, 'Radiographie');
            } else {
                displayAIError(data.message || 'Erreur lors de l\'analyse radiographie');
            }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckXrayBtn.disabled = false;
            aiCheckXrayBtn.textContent = 'ü¶¥ Analyser Radiographie';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    // AI Analysis for CT
    const aiCheckCtBtn = document.getElementById('ai-check-ct-btn');
    aiCheckCtBtn.addEventListener('click', async function() {
        const ctFiles = document.getElementById('ct_files').files;
        if (!ctFiles || ctFiles.length === 0) {
            alert('Veuillez s√©lectionner au moins un fichier CT pour l\'analyse');
            return;
        }

        const formData = new FormData();
        // Add all CT files
        for (let i = 0; i < ctFiles.length; i++) {
            formData.append('ct_files[]', ctFiles[i]);
        }

        aiCheckCtBtn.disabled = true;
        aiCheckCtBtn.textContent = `üè• Analyse CT (${ctFiles.length} fichier${ctFiles.length > 1 ? 's' : ''})...`;
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-xray") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                // Handle nested response structure from AI service
                const analysisData = data.analysis || data;
                displayAIResults(analysisData, 'CT');
            } else {
                displayAIError(data.message || 'Erreur lors de l\'analyse CT');
            }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckCtBtn.disabled = false;
            aiCheckCtBtn.textContent = 'üè• Analyser CT';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    // AI Analysis for ECG d'Effort
    const aiCheckEcgEffortBtn = document.getElementById('ai-check-ecg-effort-btn');
    aiCheckEcgEffortBtn.addEventListener('click', async function() {
        const ecgEffortFile = document.getElementById('ecg_effort_file').files[0];
        if (!ecgEffortFile) {
            alert('Veuillez s√©lectionner un fichier ECG d\'Effort pour l\'analyse');
            return;
        }

        const formData = new FormData();
        formData.append('ecg_effort_file', ecgEffortFile);

        aiCheckEcgEffortBtn.disabled = true;
        aiCheckEcgEffortBtn.textContent = 'üìà Analyse ECG d\'Effort...';
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-ecg-effort") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                const analysisData = data.analysis || data;
                displayAIResults(analysisData, 'ECG d\'Effort');
            } else {
                displayAIError(data.message || 'Erreur lors de l\'analyse ECG d\'Effort');
            }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckEcgEffortBtn.disabled = false;
            aiCheckEcgEffortBtn.textContent = 'üìà Analyser ECG d\'Effort';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    // AI Analysis for Scintigraphie
    const aiCheckScintigraphyBtn = document.getElementById('ai-check-scintigraphy-btn');
    aiCheckScintigraphyBtn.addEventListener('click', async function() {
        const scintigraphyFile = document.getElementById('scintigraphy_file').files[0];
        if (!scintigraphyFile) {
            alert('Veuillez s√©lectionner un fichier Scintigraphie pour l\'analyse');
            return;
        }

        const formData = new FormData();
        formData.append('scintigraphy_file', scintigraphyFile);

        aiCheckScintigraphyBtn.disabled = true;
        aiCheckScintigraphyBtn.textContent = '‚ò¢Ô∏è Analyse Scintigraphie...';
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-scintigraphy") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                const analysisData = data.analysis || data;
                displayAIResults(analysisData, 'Scintigraphie');
            } else {
                displayAIError(data.message || 'Erreur lors de l\'analyse Scintigraphie');
            }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckScintigraphyBtn.disabled = false;
            aiCheckScintigraphyBtn.textContent = '‚ò¢Ô∏è Analyser Scintigraphie';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    // AI Analysis for SCAT
    const aiCheckScatBtn = document.getElementById('ai-check-scat-btn');
    aiCheckScatBtn.addEventListener('click', async function() {
        // Collect SCAT form data
        const scatData = {
            evaluation_date: document.getElementById('scat_evaluation_date').value,
            context: document.getElementById('scat_context').value,
            evaluator_name: document.getElementById('scat_evaluator_name').value,
            red_flags: Array.from(document.querySelectorAll('input[name="scat_red_flags[]"]:checked')).map(cb => cb.value),
            observable_signs: Array.from(document.querySelectorAll('input[name="scat_observable_signs[]"]:checked')).map(cb => cb.value),
            symptoms: {}
        };

        // Collect symptom severity scores
        const symptomSliders = document.querySelectorAll('input[name^="scat_symptom_"]');
        symptomSliders.forEach(slider => {
            const symptomName = slider.name.replace('scat_symptom_', '');
            scatData.symptoms[symptomName] = slider.value;
        });

        // Collect SAC scores
        scatData.sac = {
            orientation: document.getElementById('scat_sac_orientation').value,
            immediate_memory: document.getElementById('scat_sac_immediate_memory').value,
            concentration: document.getElementById('scat_sac_concentration').value,
            delayed_recall: document.getElementById('scat_sac_delayed_recall').value
        };

        // Collect mBESS scores
        scatData.mbess = {
            firm_surface_errors: document.getElementById('scat_mbess_firm_errors').value,
            foam_surface_errors: document.getElementById('scat_mbess_foam_errors').value
        };

        // Collect medical decision
        scatData.medical_decision = document.getElementById('scat_medical_decision').value;
        scatData.follow_up_plan = document.getElementById('scat_follow_up_plan').value;

        aiCheckScatBtn.disabled = true;
        aiCheckScatBtn.textContent = 'üß† Analyse SCAT...';
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-scat") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify(scatData)
            });

            const data = await response.json();
            
            if (data.success) {
                const analysisData = data.analysis || data;
                displayAIResults(analysisData, 'SCAT');
                
                // Insert SCAT analysis into the follow-up plan textarea
                if (analysisData.text && document.getElementById('scat_follow_up_plan')) {
                    const currentPlan = document.getElementById('scat_follow_up_plan').value;
                    const aiAnalysis = `\n\n--- ANALYSE IA SCAT ---\n${analysisData.text}\n--- FIN ANALYSE IA ---\n`;
                    document.getElementById('scat_follow_up_plan').value = currentPlan + aiAnalysis;
                }
            } else {
                displayAIError(data.message || 'Erreur lors de l\'analyse SCAT');
            }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckScatBtn.disabled = false;
            aiCheckScatBtn.textContent = 'üß† Analyser SCAT';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    // AI Analysis for All Files
    aiCheckAllBtn.addEventListener('click', async function() {
        const ecgFile = document.getElementById('ecg_file').files[0];
        const mriFiles = document.getElementById('mri_files').files;
        const ctFiles = document.getElementById('ct_files').files;
        const xrayFile = document.getElementById('xray_file').files[0];

        if (!ecgFile && (!mriFiles || mriFiles.length === 0) && (!ctFiles || ctFiles.length === 0) && !xrayFile) {
            alert('Veuillez s√©lectionner au moins un fichier m√©dical pour l\'analyse');
            return;
        }

        const formData = new FormData();
        if (ecgFile) formData.append('ecg_file', ecgFile);
        
        // Add all MRI files
        if (mriFiles && mriFiles.length > 0) {
            for (let i = 0; i < mriFiles.length; i++) {
                formData.append('mri_files[]', mriFiles[i]);
            }
        }
        
        // Add all CT files
        if (ctFiles && ctFiles.length > 0) {
            for (let i = 0; i < ctFiles.length; i++) {
                formData.append('ct_files[]', ctFiles[i]);
            }
        }
        
        if (xrayFile) formData.append('xray_file', xrayFile);

        aiCheckAllBtn.disabled = true;
        aiCheckAllBtn.textContent = 'üöÄ Analyse compl√®te...';
        aiAnalysisStatus.classList.remove('hidden');
        aiAnalysisResults.classList.add('hidden');

        try {
            const response = await fetch('{{ route("pcma.ai-analyze-complete") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                displayAIResults(data.analysis, 'Compl√®te');
            } else {
                displayAIError(data.message || 'Erreur lors de l\'analyse compl√®te');
            }
        } catch (error) {
            if (error.message.includes('<!DOCTYPE')) {
                displayAIError('Erreur d\'authentification: Veuillez vous reconnecter et r√©essayer.');
            } else {
                displayAIError('Erreur de connexion: ' + error.message);
            }
        } finally {
            aiCheckAllBtn.disabled = false;
            aiCheckAllBtn.textContent = 'üöÄ Analyse Compl√®te';
            aiAnalysisStatus.classList.add('hidden');
        }
    });

    function displayAIResults(analysis, type) {
        console.log('displayAIResults called with:', { analysis, type });
        
        // Check if this is an error response from the API
        if (analysis.success === false && analysis.error) {
            aiResultsContent.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-red-600 font-semibold">‚ùå Erreur API Med-Gemini</span>
                    </div>
                    <div class="bg-red-50 p-3 rounded border border-red-200">
                        <h4 class="font-semibold text-red-900 mb-2">Erreur de l'API:</h4>
                        <div class="text-sm text-red-700">
                            <p><strong>Message d'erreur:</strong> ${analysis.error}</p>
                            <p><strong>Type d'analyse:</strong> ${type}</p>
                            <p><strong>Mod√®le:</strong> ${analysis.model || 'N/A'}</p>
                            <p><strong>Timestamp:</strong> ${analysis.timestamp || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
            aiAnalysisResults.classList.remove('hidden');
            return;
        }

        // Check if this is a successful API response with text
        if (analysis.text) {
            // Try to parse JSON from the text response for better formatting
            let formattedContent = analysis.text;
            let isJsonResponse = false;
            
            try {
                // Check if the text contains JSON
                if (analysis.text.includes('{') && analysis.text.includes('}')) {
                    // Try to extract JSON from the text
                    const jsonMatch = analysis.text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const jsonData = JSON.parse(jsonMatch[0]);
                        isJsonResponse = true;
                        
                        // Format the JSON data nicely with medical report styling
                        let formattedHtml = '';
                        let hasAbnormalities = false;
                        
                        for (const [key, value] of Object.entries(jsonData)) {
                            const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            
                            // Handle different value types
                            let displayValue = '';
                            let isAbnormal = false;
                            
                            if (typeof value === 'object' && value !== null) {
                                // Check if it's a nested object with bone/medical structure or joint alignment
                                if (Object.keys(value).length > 0 && 
                                    (Object.keys(value).some(key => 
                                        ['tibia', 'fibula', 'femur', 'humerus', 'radius', 'ulna', 'scapula', 'clavicle', 
                                         'pelvis', 'spine', 'skull', 'ribs', 'other_bones', 'joints', 'ligaments', 
                                         'muscles', 'tendons', 'cartilage', 'knee', 'ankle', 'hip', 'shoulder', 'elbow',
                                         'wrist', 'spine_joints', 'other_joints'].includes(key.toLowerCase())
                                    ))) {
                                    // Format as medical bone structure or joint alignment report
                                    let medicalReport = '';
                                    for (const [itemName, itemDescription] of Object.entries(value)) {
                                        const formattedItemName = itemName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                        
                                        // Check for abnormal keywords in both bone and joint contexts
                                        const abnormalKeywords = [
                                            'fracture', 'broken', 'damage', 'disruption', 'injury', 'pathological',
                                            'malalignment', 'difficult', 'potential', 'requires', 'abnormal', 'dislocation',
                                            'instability', 'degenerative', 'narrowing', 'impingement', 'impingement'
                                        ];
                                        
                                        const hasAbnormalKeywords = abnormalKeywords.some(keyword => 
                                            itemDescription.toLowerCase().includes(keyword)
                                        );
                                        
                                        if (hasAbnormalKeywords) isAbnormal = true;
                                        
                                        // Determine if this is a joint or bone based on the key
                                        const isJoint = ['knee', 'ankle', 'hip', 'shoulder', 'elbow', 'wrist', 'spine_joints', 'other_joints'].includes(itemName.toLowerCase());
                                        const icon = isJoint ? 'ü¶¥' : 'ü¶¥';
                                        const bgColor = hasAbnormalKeywords ? 'bg-orange-50 border-l-2 border-orange-400' : 'bg-blue-50 border-l-2 border-blue-400';
                                        const textColor = hasAbnormalKeywords ? 'text-orange-800' : 'text-blue-700';
                                        
                                        medicalReport += `
                                            <div class="mb-2 p-2 ${bgColor}">
                                                <div class="flex items-center mb-1">
                                                    <span class="font-semibold text-sm ${textColor}">
                                                        ${hasAbnormalKeywords ? '‚ö†Ô∏è' : '‚úÖ'} ${icon} ${formattedItemName}
                                                    </span>
                                                </div>
                                                <p class="text-xs text-gray-600 leading-relaxed">${itemDescription}</p>
                                            </div>
                                        `;
                                    }
                                    displayValue = medicalReport;
                                } else if (value.text) {
                                    displayValue = value.text;
                                } else if (value.description) {
                                    displayValue = value.description;
                                } else if (value.value) {
                                    displayValue = value.value;
                                } else if (value.content) {
                                    displayValue = value.content;
                                } else {
                                    // If no specific field, try to stringify the object
                                    try {
                                        displayValue = JSON.stringify(value, null, 2);
                                    } catch (e) {
                                        displayValue = 'Donn√©es complexes - voir les d√©tails techniques';
                                    }
                                }
                            } else {
                                // If it's a string, number, or other primitive
                                displayValue = String(value);
                            }
                            
                            // Check for abnormal findings
                            const abnormalKeywords = ['fracture', 'broken', 'damage', 'abnormal', 'pathological', 'disease', 'injury', 'lesion'];
                            isAbnormal = abnormalKeywords.some(keyword => 
                                displayValue.toLowerCase().includes(keyword)
                            );
                            
                            if (isAbnormal) hasAbnormalities = true;
                            
                            // Determine card styling based on content
                            const cardClass = isAbnormal 
                                ? 'mb-4 p-4 bg-red-50 rounded-lg border-l-4 border-red-500 shadow-sm'
                                : 'mb-4 p-4 bg-green-50 rounded-lg border-l-4 border-green-500 shadow-sm';
                            
                            const titleClass = isAbnormal 
                                ? 'font-semibold text-red-900 mb-2 flex items-center'
                                : 'font-semibold text-green-900 mb-2 flex items-center';
                            
                            const icon = isAbnormal ? '‚ö†Ô∏è' : '‚úÖ';
                            
                            formattedHtml += `
                                <div class="${cardClass}">
                                    <h5 class="${titleClass}">
                                        <span class="mr-2">${icon}</span>
                                        ${formattedKey}
                                    </h5>
                                    <div class="text-gray-700 text-sm leading-relaxed bg-white p-3 rounded border">
                                        ${displayValue}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Add summary section
                        const summaryClass = hasAbnormalities 
                            ? 'bg-red-100 border-red-300 text-red-800'
                            : 'bg-green-100 border-green-300 text-green-800';
                        
                        const summaryIcon = hasAbnormalities ? 'üö®' : '‚úÖ';
                        const summaryText = hasAbnormalities 
                            ? 'Anomalies d√©tect√©es - Consultation m√©dicale recommand√©e'
                            : 'Examen normal - Aucune anomalie d√©tect√©e';
                        
                        formattedHtml = `
                            <div class="mb-4 p-4 ${summaryClass} rounded-lg border-2">
                                <div class="flex items-center">
                                    <span class="text-xl mr-3">${summaryIcon}</span>
                                    <div>
                                        <h4 class="font-bold">R√©sum√© de l'analyse</h4>
                                        <p class="text-sm">${summaryText}</p>
                                    </div>
                                </div>
                            </div>
                            ${formattedHtml}
                        `;
                        
                        formattedContent = formattedHtml;
                    }
                }
            } catch (e) {
                // If JSON parsing fails, use the original text
                formattedContent = analysis.text;
            }
            
            aiResultsContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between bg-green-50 p-3 rounded-lg border border-green-200">
                        <div class="flex items-center space-x-2">
                            <span class="text-green-600 text-xl">‚úì</span>
                            <span class="text-green-800 font-semibold">Analyse ${type} termin√©e</span>
                        </div>
                        <div class="text-sm text-green-600">
                            <span class="font-medium">Mod√®le:</span> ${analysis.model || 'N/A'}
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 rounded-t-lg">
                            <h4 class="font-semibold text-gray-900">R√©sultats de l'analyse Med-Gemini</h4>
                        </div>
                        <div class="p-4">
                            ${isJsonResponse ? formattedContent : `
                                <div class="text-gray-700 whitespace-pre-wrap leading-relaxed">
                                    ${analysis.text}
                                </div>
                            `}
                        </div>
                        <div class="bg-gray-50 px-4 py-2 border-t border-gray-200 rounded-b-lg">
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <div>
                                    <span>Temps de traitement: <span class="font-medium">${analysis.processingTime || 'N/A'}ms</span></span>
                                    <span class="ml-4">Timestamp: <span class="font-medium">${analysis.timestamp || 'N/A'}</span></span>
                                </div>
                                                                        <button 
                            type="button" 
                            id="generate-hl7-cda-btn"
                            class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors flex items-center"
                        >
                            üìã G√©n√©rer HL7 CDA
                        </button>

                            </div>
                        </div>
                    </div>
                </div>
            `;
            aiAnalysisResults.classList.remove('hidden');
            return;
        }

        // Fallback for other response formats
        const fileType = analysis.file_type || 'Image';
        const fileExtension = analysis.file_extension || 'N/A';
        const dicomMetadata = analysis.dicom_metadata ? `<div class="mt-2 p-2 bg-blue-50 rounded"><strong>M√©tadonn√©es DICOM:</strong> ${JSON.stringify(analysis.dicom_metadata, null, 2)}</div>` : '';

        // Handle different analysis types
        let resultsHtml = '';
        
        if (type === 'Radiographie' || type === 'X-Ray') {
            // X-ray specific fields
            resultsHtml = `
                <p><strong>Structure osseuse:</strong> ${analysis.bone_structure || 'Non disponible'}</p>
                <p><strong>Alignement articulaire:</strong> ${analysis.joint_alignment || 'Non disponible'}</p>
                <p><strong>Fractures:</strong> ${analysis.fractures || 'Non disponible'}</p>
                <p><strong>Luxations:</strong> ${analysis.dislocations || 'Non disponible'}</p>
                <p><strong>Arthrite:</strong> ${analysis.arthritis || 'Non disponible'}</p>
                <p><strong>Densit√© osseuse:</strong> ${analysis.bone_density || 'Non disponible'}</p>
                <p><strong>Anomalies d√©tect√©es:</strong> ${analysis.abnormalities || 'Aucune'}</p>
                <p><strong>Recommandations:</strong> ${analysis.recommendations || 'Non disponible'}</p>
            `;
        } else if (type === 'ECG') {
            // ECG specific fields
            resultsHtml = `
                <p><strong>Rythme:</strong> ${analysis.rhythm || 'Non disponible'}</p>
                <p><strong>Fr√©quence cardiaque:</strong> ${analysis.heart_rate || 'Non disponible'}</p>
                <p><strong>Anomalies d√©tect√©es:</strong> ${analysis.abnormalities || 'Aucune'}</p>
                <p><strong>Recommandations:</strong> ${analysis.recommendations || 'Non disponible'}</p>
            `;
        } else if (type === 'IRM' || type === 'MRI') {
            // MRI specific fields
            resultsHtml = `
                <p><strong>√Çge osseux:</strong> ${analysis.bone_age || 'Non disponible'}</p>
                <p><strong>√Çge chronologique:</strong> ${analysis.chronological_age || 'Non disponible'}</p>
                <p><strong>Diff√©rence d'√¢ge:</strong> ${analysis.age_difference || 'Non disponible'}</p>
                <p><strong>Maturit√© squelettique:</strong> ${analysis.skeletal_maturity || 'Non disponible'}</p>
                <p><strong>Anomalies d√©tect√©es:</strong> ${analysis.abnormalities || 'Aucune'}</p>
                <p><strong>Recommandations:</strong> ${analysis.recommendations || 'Non disponible'}</p>
            `;
        } else {
            // Generic fields
            resultsHtml = `
                <p><strong>Diagnostic:</strong> ${analysis.diagnosis || 'Non disponible'}</p>
                <p><strong>Anomalies d√©tect√©es:</strong> ${analysis.abnormalities || 'Aucune'}</p>
                <p><strong>Recommandations:</strong> ${analysis.recommendations || 'Non disponible'}</p>
                <p><strong>Confiance:</strong> ${analysis.confidence || 'Non disponible'}</p>
            `;
        }

        aiResultsContent.innerHTML = `
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-green-600 font-semibold">‚úì Analyse ${type} termin√©e</span>
                    <span class="text-sm text-gray-500">Type: ${fileType} (${fileExtension})</span>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold text-gray-900 mb-2">R√©sultats de l'analyse:</h4>
                    <div class="text-sm text-gray-700">
                        ${resultsHtml}
                        ${dicomMetadata}
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-2 border-t border-gray-200 rounded-b-lg">
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <div>
                            <span>Temps de traitement: <span class="font-medium">${analysis.processingTime || 'N/A'}ms</span></span>
                            <span class="ml-4">Timestamp: <span class="font-medium">${analysis.timestamp || 'N/A'}</span></span>
                        </div>
                        <button 
                            type="button" 
                            id="generate-hl7-cda-btn"
                            class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors flex items-center"
                        >
                            üìã G√©n√©rer HL7 CDA
                        </button>

                    </div>
                </div>
            </div>
        `;
        aiAnalysisResults.classList.remove('hidden');
        
        // Store current analysis data for HL7 CDA generation
        const newAnalysisData = {
            type: type,
            analysis: analysis,
            timestamp: new Date().toISOString()
        };
        
        // Track the change
        window.analysisDataHistory.push({
            action: 'STORING_REAL_DATA',
            timestamp: new Date().toISOString(),
            oldData: window.currentAnalysisData,
            newData: newAnalysisData
        });
        
        window.currentAnalysisData = newAnalysisData;
        
        // Debug: Log the stored data
        console.log('=== STORING REAL ANALYSIS DATA ===');
        console.log('Analysis type:', type);
        console.log('Analysis data:', analysis);
        console.log('Stored analysis data:', window.currentAnalysisData);
        console.log('Stored analysis data type:', typeof window.currentAnalysisData.analysis);
        console.log('Analysis content:', JSON.stringify(analysis, null, 2));
        console.log('Window object before storing:', Object.keys(window).filter(key => key.includes('analysis')));
        
        // Test if data persists after a short delay
        setTimeout(() => {
            console.log('=== CHECKING DATA PERSISTENCE ===');
            console.log('Data after 1 second:', window.currentAnalysisData);
            console.log('Data still exists:', !!window.currentAnalysisData);
            console.log('Window object after 1 second:', Object.keys(window).filter(key => key.includes('analysis')));
        }, 1000);
    }

    function displayAIError(message) {
        aiResultsContent.innerHTML = `
            <div class="text-red-600">
                <p>${message}</p>
            </div>
        `;
        aiAnalysisResults.classList.remove('hidden');
    }

    // File Preview Functionality
    const mriFilesInput = document.getElementById('mri_files');
    const ctFilesInput = document.getElementById('ct_files');
    const mriFilesPreview = document.getElementById('mri-files-preview');
    const ctFilesPreview = document.getElementById('ct-files-preview');

    // MRI Files Preview
    mriFilesInput.addEventListener('change', function() {
        mriFilesPreview.innerHTML = '';
        if (this.files.length > 0) {
            for (let i = 0; i < this.files.length; i++) {
                const file = this.files[i];
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between p-2 bg-blue-50 rounded border border-blue-200';
                fileDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-blue-600 mr-2">üìÑ</span>
                        <span class="text-sm text-gray-700">${file.name}</span>
                        <span class="text-xs text-gray-500 ml-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeFile(this, 'mri_files')">
                        ‚úï
                    </button>
                `;
                mriFilesPreview.appendChild(fileDiv);
            }
        }
    });

    // CT Files Preview
    ctFilesInput.addEventListener('change', function() {
        ctFilesPreview.innerHTML = '';
        if (this.files.length > 0) {
            for (let i = 0; i < this.files.length; i++) {
                const file = this.files[i];
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between p-2 bg-green-50 rounded border border-green-200';
                fileDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-green-600 mr-2">üìÑ</span>
                        <span class="text-sm text-gray-700">${file.name}</span>
                        <span class="text-xs text-gray-500 ml-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeFile(this, 'ct_files')">
                        ‚úï
                    </button>
                `;
                ctFilesPreview.appendChild(fileDiv);
            }
        }
    });

    // Remove file function
    window.removeFile = function(button, inputId) {
        const fileDiv = button.parentElement.parentElement;
        fileDiv.remove();
        // Note: We can't directly remove files from FileList, but we can clear and re-add
        // This is a simplified approach - in a real app you'd need more complex handling
    };

    // HL7 CDA Generation
    const hl7CdaStatus = document.getElementById('hl7-cda-status');
    
    // Global tracking for analysis data changes
    window.analysisDataHistory = [];

        // Use event delegation for the dynamically created button
    document.addEventListener('click', async function(event) {
        if (event.target && event.target.id === 'generate-hl7-cda-btn') {
            console.log('=== HL7 CDA BUTTON CLICKED ===');
            console.log('Current analysis data:', window.currentAnalysisData);
            console.log('Window object keys:', Object.keys(window).filter(key => key.includes('analysis')));
            console.log('Analysis data type:', typeof window.currentAnalysisData);
            console.log('Analysis data content:', JSON.stringify(window.currentAnalysisData, null, 2));
            console.log('Analysis data exists:', !!window.currentAnalysisData);
            console.log('Analysis data type property:', typeof window.currentAnalysisData?.type);
            console.log('Analysis data analysis property:', typeof window.currentAnalysisData?.analysis);
            console.log('Data exists:', !!window.currentAnalysisData);
            console.log('Data has analysis property:', !!(window.currentAnalysisData && window.currentAnalysisData.analysis));
            console.log('Analysis data history:', window.analysisDataHistory);
            
            if (!window.currentAnalysisData) {
                console.log('No analysis data found. Please run an AI analysis first.');
                alert('Aucune analyse disponible. Veuillez d\'abord ex√©cuter une analyse IA (ECG, IRM, ou Radiographie).');
                return;
            }

        event.target.disabled = true;
        event.target.textContent = 'üìã G√©n√©ration...';
        hl7CdaStatus.classList.remove('hidden');

                    try {
                const requestData = {
                    analysis_data: window.currentAnalysisData,
                    player_id: document.getElementById('player_id').value || 1,
                    record_date: document.getElementById('record_date').value,
                    diagnosis: document.getElementById('diagnosis').value,
                    treatment_plan: document.getElementById('treatment_plan').value
                };
                
                console.log('Sending request data:', requestData);
                console.log('Request URL:', '{{ route("health-records.generate-hl7-cda") }}');
                
                const response = await fetch('{{ route("health-records.generate-hl7-cda") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: JSON.stringify(requestData)
                });

            const data = await response.json();
            console.log('HL7 CDA response:', data);
            console.log('Response status:', response.status);
            
            if (data.success) {
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'mt-3 p-3 bg-green-50 border border-green-200 rounded-lg';
                successDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-green-600 mr-2">‚úì</span>
                        <span class="text-green-800 font-semibold">Rapport HL7 CDA g√©n√©r√© avec succ√®s</span>
                    </div>
                    <div class="mt-2 text-sm text-green-700">
                        <p><strong>ID du rapport:</strong> ${data.report_id}</p>
                        <p><strong>Type:</strong> ${data.report_type}</p>
                        <p><strong>Date:</strong> ${data.generated_at}</p>
                        <p><strong>Statut:</strong> Enregistr√© dans le dossier m√©dical du joueur</p>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <a href="/health-records/view-hl7-cda/${data.report_id}" target="_blank" class="inline-flex items-center px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                            üëÅÔ∏è Voir le rapport
                        </a>
                        <a href="${data.download_url}" class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            üì• T√©l√©charger XML
                        </a>
                    </div>
                `;
                
                // Insert after the results content
                const resultsContainer = document.getElementById('ai-results-content');
                resultsContainer.appendChild(successDiv);
                
                // Hide the generate button
                event.target.style.display = 'none';
            } else {
                throw new Error(data.message || 'Erreur lors de la g√©n√©ration du rapport HL7 CDA');
            }
        } catch (error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mt-3 p-3 bg-red-50 border border-red-200 rounded-lg';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="text-red-600 mr-2">‚úó</span>
                    <span class="text-red-800 font-semibold">Erreur lors de la g√©n√©ration</span>
                </div>
                <div class="mt-2 text-sm text-red-700">
                    <p>${error.message}</p>
                </div>
            `;
            
            const resultsContainer = document.getElementById('ai-results-content');
            resultsContainer.appendChild(errorDiv);
        } finally {
            event.target.disabled = false;
            event.target.textContent = 'üìã G√©n√©rer HL7 CDA';
            hl7CdaStatus.classList.add('hidden');
        }
    }
    });

    // DICOM Viewer Functionality
    const dicomViewerSelect = document.getElementById('dicom-viewer-select');
    const dicomCanvas = document.getElementById('dicom-canvas');
    const dicomLoading = document.getElementById('dicom-loading');
    const dicomError = document.getElementById('dicom-error');
    const dicomPlaceholder = document.getElementById('dicom-placeholder');
    const dicomMetadata = document.getElementById('dicom-metadata');
    const dicomMeasurements = document.getElementById('dicom-measurements');
    const dicomZoomIn = document.getElementById('dicom-zoom-in');
    const dicomZoomOut = document.getElementById('dicom-zoom-out');
    const dicomReset = document.getElementById('dicom-reset');
    const dicomFullscreen = document.getElementById('dicom-fullscreen');

    // File input mapping
    const fileInputs = {
        'ecg': 'ecg_file',
        'mri': 'mri_file',
        'xray': 'xray_file'
    };

    // DicomViewer class
    class DicomViewer {
        constructor(canvas) {
            this.canvas = canvas;
            this.ctx = canvas.getContext('2d');
            this.image = null;
            this.zoom = 1.0;
            this.offset = { x: 0, y: 0 };
            this.isDragging = false;
            this.lastMousePos = { x: 0, y: 0 };
            
            this.setupEventListeners();
        }

        setupEventListeners() {
            // Mouse events
            this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
            this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
            this.canvas.addEventListener('mouseup', (e) => this.onMouseUp(e));
            this.canvas.addEventListener('wheel', (e) => this.onWheel(e));

            // Touch events for mobile
            this.canvas.addEventListener('touchstart', (e) => this.onTouchStart(e));
            this.canvas.addEventListener('touchmove', (e) => this.onTouchMove(e));
            this.canvas.addEventListener('touchend', (e) => this.onTouchEnd(e));
            
            // Resize handler
            window.addEventListener('resize', () => {
                if (this.image) {
                    this.render();
                }
            });
        }

        onMouseDown(e) {
            this.isDragging = true;
            this.lastMousePos = { x: e.clientX, y: e.clientY };
            this.canvas.style.cursor = 'grabbing';
        }

        onMouseMove(e) {
            if (!this.isDragging) return;
            
            const deltaX = e.clientX - this.lastMousePos.x;
            const deltaY = e.clientY - this.lastMousePos.y;
            
            this.offset.x += deltaX;
            this.offset.y += deltaY;
            
            this.lastMousePos = { x: e.clientX, y: e.clientY };
            this.render();
        }

        onMouseUp(e) {
            this.isDragging = false;
            this.canvas.style.cursor = 'crosshair';
        }

        onWheel(e) {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            this.zoom = Math.max(0.1, Math.min(5.0, this.zoom * zoomFactor));
            this.render();
        }

        onTouchStart(e) {
            if (e.touches.length === 1) {
                this.isDragging = true;
                this.lastMousePos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        }

        onTouchMove(e) {
            if (!this.isDragging || e.touches.length !== 1) return;
            
            const deltaX = e.touches[0].clientX - this.lastMousePos.x;
            const deltaY = e.touches[0].clientY - this.lastMousePos.y;
            
            this.offset.x += deltaX;
            this.offset.y += deltaY;
            
            this.lastMousePos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            this.render();
        }

        onTouchEnd(e) {
            this.isDragging = false;
        }

        async loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        console.log('Image loaded successfully:', img.width, 'x', img.height);
                        this.image = img;
                        this.resetView();
                        this.render();
                        
                        // Update dimensions in metadata
                        const dimensionsElement = document.getElementById('dicom-image-dimensions');
                        if (dimensionsElement) {
                            dimensionsElement.textContent = `${img.width} √ó ${img.height} pixels`;
                        }
                        
                        resolve(img);
                    };
                    img.onerror = (error) => {
                        console.error('Image loading error:', error);
                        reject(error);
                    };
                    img.src = e.target.result;
                };
                
                reader.onerror = (error) => {
                    console.error('File reading error:', error);
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        resetView() {
            this.zoom = 1.0;
            this.offset = { x: 0, y: 0 };
            
            // Force a render to ensure proper sizing
            if (this.image) {
                setTimeout(() => {
                    this.render();
                }, 50);
            }
        }

        render() {
            if (!this.image) {
                console.log('No image to render');
                return;
            }

            const canvas = this.canvas;
            const ctx = this.ctx;
            
            // Get container dimensions
            const container = canvas.parentElement;
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            
            // Set canvas size to match container
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            console.log('Container size:', containerWidth, 'x', containerHeight);
            console.log('Canvas size:', canvas.width, 'x', canvas.height);
            console.log('Image size:', this.image.width, 'x', this.image.height);
            console.log('Zoom level:', this.zoom);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate image dimensions to fit container while maintaining aspect ratio
            const imageAspectRatio = this.image.width / this.image.height;
            const containerAspectRatio = containerWidth / containerHeight;
            
            let displayWidth, displayHeight;
            
            // Determine if image is portrait or landscape
            const isPortrait = this.image.height > this.image.width;
            const isLandscape = this.image.width > this.image.height;
            
            console.log('Image orientation:', isPortrait ? 'Portrait' : isLandscape ? 'Landscape' : 'Square');
            
            if (imageAspectRatio > containerAspectRatio) {
                // Image is wider than container - fit to width
                displayWidth = containerWidth * 0.85; // 85% of container width for better fit
                displayHeight = displayWidth / imageAspectRatio;
            } else {
                // Image is taller than container - fit to height
                displayHeight = containerHeight * 0.85; // 85% of container height for better fit
                displayWidth = displayHeight * imageAspectRatio;
            }
            
            // Apply zoom
            const scaledWidth = displayWidth * this.zoom;
            const scaledHeight = displayHeight * this.zoom;
            
            // Center the image
            const x = (canvas.width - scaledWidth) / 2 + this.offset.x;
            const y = (canvas.height - scaledHeight) / 2 + this.offset.y;
            
            console.log('Display size:', displayWidth, 'x', displayHeight);
            console.log('Scaled size:', scaledWidth, 'x', scaledHeight);
            console.log('Drawing image at:', x, y);
            
            // Draw image
            ctx.drawImage(this.image, x, y, scaledWidth, scaledHeight);
            
            // Update info
            const dimensionsElement = document.getElementById('dicom-image-dimensions');
            if (dimensionsElement) {
                dimensionsElement.textContent = `${this.image.width} √ó ${this.image.height}`;
            }
        }
    }

    // Initialize DICOM viewer
    console.log('Initializing DICOM viewer with canvas:', dicomCanvas);
    const dicomViewer = new DicomViewer(dicomCanvas);

    // File selection handler
    dicomViewerSelect.addEventListener('change', async function() {
        const selectedType = this.value;
        console.log('File type selected:', selectedType);
        
        if (!selectedType) {
            showPlaceholder();
            return;
        }

        const fileInputId = fileInputs[selectedType];
        const fileInput = document.getElementById(fileInputId);
        
        console.log('File input ID:', fileInputId);
        console.log('File input found:', !!fileInput);
        
        if (!fileInput || !fileInput.files[0]) {
            alert('Veuillez d\'abord s√©lectionner un fichier ' + selectedType);
            return;
        }

        const file = fileInput.files[0];
        const extension = file.name.toLowerCase().split('.').pop();
        const isDicom = extension === 'dcm';
        const isImage = ['jpg', 'jpeg', 'png', 'bmp', 'tiff', 'tif'].includes(extension);
        const isPdf = extension === 'pdf';

        console.log('File:', file.name, 'Extension:', extension);
        console.log('Is DICOM:', isDicom, 'Is Image:', isImage, 'Is PDF:', isPdf);

        showLoading();

        try {
            if (isDicom) {
                console.log('Loading DICOM file...');
                await dicomViewer.loadImage(file);
                showViewer();
                updateMetadata(file, selectedType, 'DICOM');
            } else if (isImage) {
                console.log('Loading image file...');
                await dicomViewer.loadImage(file);
                showViewer();
                updateMetadata(file, selectedType, 'Image');
            } else if (isPdf) {
                console.log('Loading PDF file...');
                showPdfViewer(file);
                updateMetadata(file, selectedType, 'PDF');
            } else {
                throw new Error('Format de fichier non support√©');
            }
        } catch (error) {
            console.error('Error loading file:', error);
            showError(error.message);
        }
    });

    function showLoading() {
        dicomLoading.classList.remove('hidden');
        dicomError.classList.add('hidden');
        dicomPlaceholder.classList.add('hidden');
        dicomCanvas.classList.add('hidden');
        dicomMetadata.classList.add('hidden');
        dicomMeasurements.classList.add('hidden');
    }

    function showViewer() {
        console.log('Showing viewer...');
        dicomLoading.classList.add('hidden');
        dicomError.classList.add('hidden');
        dicomPlaceholder.classList.add('hidden');
        dicomCanvas.classList.remove('hidden');
        dicomMetadata.classList.remove('hidden');
        dicomMeasurements.classList.remove('hidden');
        
        // Force a re-render after showing the canvas
        setTimeout(() => {
            if (dicomViewer.image) {
                console.log('Re-rendering after show...');
                dicomViewer.render();
            }
        }, 100);
    }

    function showError(message) {
        dicomLoading.classList.add('hidden');
        dicomError.classList.remove('hidden');
        dicomPlaceholder.classList.add('hidden');
        dicomCanvas.classList.add('hidden');
        dicomMetadata.classList.add('hidden');
        dicomMeasurements.classList.add('hidden');
        
        const errorElement = dicomError.querySelector('p');
        if (errorElement) {
            errorElement.textContent = message;
        }
    }

    function showPlaceholder() {
        dicomLoading.classList.add('hidden');
        dicomError.classList.add('hidden');
        dicomPlaceholder.classList.remove('hidden');
        dicomCanvas.classList.add('hidden');
        dicomMetadata.classList.add('hidden');
        dicomMeasurements.classList.add('hidden');
    }

    function updateMetadata(file, type, format) {
        document.getElementById('dicom-file-type').textContent = type.toUpperCase();
        document.getElementById('dicom-format').textContent = format;
        document.getElementById('dicom-file-size').textContent = formatFileSize(file.size);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showPdfViewer(file) {
        // For PDF files, we'll show a placeholder for now
        showError('Visualisation PDF en cours de d√©veloppement');
    }

    // Viewer controls
    dicomZoomIn.addEventListener('click', () => {
        if (dicomViewer.image) {
            dicomViewer.zoom = Math.min(5.0, dicomViewer.zoom * 1.2);
            dicomViewer.render();
        }
    });

    dicomZoomOut.addEventListener('click', () => {
        if (dicomViewer.image) {
            dicomViewer.zoom = Math.max(0.1, dicomViewer.zoom / 1.2);
            dicomViewer.render();
        }
    });

    dicomReset.addEventListener('click', () => {
        if (dicomViewer.image) {
            dicomViewer.resetView();
        }
    });

    dicomFullscreen.addEventListener('click', () => {
        if (dicomCanvas.requestFullscreen) {
            dicomCanvas.requestFullscreen();
        }
    });

    // Measurement Tools Implementation
    const dicomMeasureDistance = document.getElementById('dicom-measure-distance');
    const dicomMeasureAngle = document.getElementById('dicom-measure-angle');
    const dicomMeasureSurface = document.getElementById('dicom-measure-surface');
    const dicomMeasurementsContent = document.getElementById('dicom-measurements-content');

    console.log('Measurement buttons found:', {
        distance: !!dicomMeasureDistance,
        angle: !!dicomMeasureAngle,
        surface: !!dicomMeasureSurface,
        content: !!dicomMeasurementsContent
    });

    let measurementMode = null;
    let measurementPoints = [];
    let measurementResults = [];

    // Distance measurement
    dicomMeasureDistance.addEventListener('click', () => {
        console.log('Distance measurement button clicked');
        if (!dicomViewer.image) {
            alert('Veuillez d\'abord charger une image');
            return;
        }
        
        measurementMode = 'distance';
        measurementPoints = [];
        dicomCanvas.style.cursor = 'crosshair';
        
        // Update button states
        dicomMeasureDistance.classList.add('bg-green-600');
        dicomMeasureAngle.classList.remove('bg-green-600');
        dicomMeasureSurface.classList.remove('bg-green-600');
        
        alert('Cliquez sur deux points pour mesurer la distance');
    });

    // Angle measurement
    dicomMeasureAngle.addEventListener('click', () => {
        if (!dicomViewer.image) {
            alert('Veuillez d\'abord charger une image');
            return;
        }
        
        measurementMode = 'angle';
        measurementPoints = [];
        dicomCanvas.style.cursor = 'crosshair';
        
        // Update button states
        dicomMeasureDistance.classList.remove('bg-green-600');
        dicomMeasureAngle.classList.add('bg-green-600');
        dicomMeasureSurface.classList.remove('bg-green-600');
        
        alert('Cliquez sur trois points pour mesurer l\'angle');
    });

    // Surface measurement
    dicomMeasureSurface.addEventListener('click', () => {
        if (!dicomViewer.image) {
            alert('Veuillez d\'abord charger une image');
            return;
        }
        
        measurementMode = 'surface';
        measurementPoints = [];
        dicomCanvas.style.cursor = 'crosshair';
        
        // Update button states
        dicomMeasureDistance.classList.remove('bg-green-600');
        dicomMeasureAngle.classList.remove('bg-green-600');
        dicomMeasureSurface.classList.add('bg-green-600');
        
        alert('Cliquez sur plusieurs points pour dessiner une forme et mesurer sa surface');
    });

    // Enhanced mouse click handler for measurements
    dicomCanvas.addEventListener('mousedown', function(e) {
        if (measurementMode && dicomViewer.image) {
            handleMeasurementClick(e);
        }
    });

    function handleMeasurementClick(e) {
        console.log('Measurement click detected, mode:', measurementMode);
        const rect = dicomCanvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - dicomViewer.offset.x) / dicomViewer.zoom;
        const y = (e.clientY - rect.top - dicomViewer.offset.y) / dicomViewer.zoom;
        
        console.log('Click coordinates:', { x, y, clientX: e.clientX, clientY: e.clientY });
        
        measurementPoints.push({ x, y });
        console.log('Measurement points:', measurementPoints.length);
        
        // Draw measurement point
        dicomViewer.ctx.save();
        dicomViewer.ctx.fillStyle = 'red';
        dicomViewer.ctx.beginPath();
        dicomViewer.ctx.arc(x * dicomViewer.zoom + dicomViewer.offset.x, y * dicomViewer.zoom + dicomViewer.offset.y, 3, 0, 2 * Math.PI);
        dicomViewer.ctx.fill();
        dicomViewer.ctx.restore();
        
        if (measurementMode === 'distance' && measurementPoints.length === 2) {
            console.log('Calculating distance...');
            calculateDistance();
        } else if (measurementMode === 'angle' && measurementPoints.length === 3) {
            console.log('Calculating angle...');
            calculateAngle();
        } else if (measurementMode === 'surface' && measurementPoints.length >= 3) {
            // Allow more points for surface measurement
            if (e.ctrlKey || e.metaKey) {
                console.log('Calculating surface...');
                calculateSurface();
            }
        }
    }

    function calculateDistance() {
        const p1 = measurementPoints[0];
        const p2 = measurementPoints[1];
        
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // Convert to pixels and estimate real-world units
        const pixelSize = 0.1; // Assume 0.1mm per pixel (adjust based on DICOM metadata)
        const realDistance = distance * pixelSize;
        
        const result = {
            type: 'Distance',
            value: realDistance.toFixed(2),
            unit: 'mm',
            points: measurementPoints
        };
        
        measurementResults.push(result);
        updateMeasurementsDisplay();
        resetMeasurementMode();
    }

    function calculateAngle() {
        const p1 = measurementPoints[0];
        const p2 = measurementPoints[1];
        const p3 = measurementPoints[2];
        
        // Calculate vectors
        const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
        const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
        
        // Calculate angle
        const dot = v1.x * v2.x + v1.y * v2.y;
        const det = v1.x * v2.y - v1.y * v2.x;
        const angle = Math.atan2(det, dot) * 180 / Math.PI;
        
        const result = {
            type: 'Angle',
            value: Math.abs(angle).toFixed(1),
            unit: '¬∞',
            points: measurementPoints
        };
        
        measurementResults.push(result);
        updateMeasurementsDisplay();
        resetMeasurementMode();
    }

    function calculateSurface() {
        if (measurementPoints.length < 3) return;
        
        // Calculate area using shoelace formula
        let area = 0;
        for (let i = 0; i < measurementPoints.length; i++) {
            const j = (i + 1) % measurementPoints.length;
            area += measurementPoints[i].x * measurementPoints[j].y;
            area -= measurementPoints[j].x * measurementPoints[i].y;
        }
        area = Math.abs(area) / 2;
        
        // Convert to real-world units
        const pixelSize = 0.1; // Assume 0.1mm per pixel
        const realArea = area * pixelSize * pixelSize;
        
        const result = {
            type: 'Surface',
            value: realArea.toFixed(2),
            unit: 'mm¬≤',
            points: measurementPoints
        };
        
        measurementResults.push(result);
        updateMeasurementsDisplay();
        resetMeasurementMode();
    }

    function updateMeasurementsDisplay() {
        let html = '<h4 class="font-semibold mb-2">Mesures:</h4>';
        
        measurementResults.forEach((result, index) => {
            html += `
                <div class="mb-2 p-2 bg-gray-50 rounded">
                    <div class="font-medium">${result.type}: ${result.value} ${result.unit}</div>
                    <button onclick="removeMeasurement(${index})" class="text-xs text-red-600 hover:text-red-800">Supprimer</button>
                </div>
            `;
        });
        
        dicomMeasurementsContent.innerHTML = html;
    }

    function removeMeasurement(index) {
        measurementResults.splice(index, 1);
        updateMeasurementsDisplay();
        // Re-render to remove the measurement lines
        if (dicomViewer.image) {
            dicomViewer.render();
            drawAllMeasurements();
        }
    }

    function resetMeasurementMode() {
        measurementMode = null;
        measurementPoints = [];
        dicomCanvas.style.cursor = 'crosshair';
        
        // Reset button states
        dicomMeasureDistance.classList.remove('bg-green-600');
        dicomMeasureAngle.classList.remove('bg-green-600');
        dicomMeasureSurface.classList.remove('bg-green-600');
    }

    function drawAllMeasurements() {
        measurementResults.forEach(result => {
            if (result.type === 'Distance' && result.points.length === 2) {
                drawDistanceLine(result.points[0], result.points[1]);
            } else if (result.type === 'Angle' && result.points.length === 3) {
                drawAngleLines(result.points[0], result.points[1], result.points[2]);
            } else if (result.type === 'Surface' && result.points.length >= 3) {
                drawSurfacePolygon(result.points);
            }
        });
    }

    function drawDistanceLine(p1, p2) {
        dicomViewer.ctx.save();
        dicomViewer.ctx.strokeStyle = 'red';
        dicomViewer.ctx.lineWidth = 2;
        dicomViewer.ctx.beginPath();
        dicomViewer.ctx.moveTo(p1.x * dicomViewer.zoom + dicomViewer.offset.x, p1.y * dicomViewer.zoom + dicomViewer.offset.y);
        dicomViewer.ctx.lineTo(p2.x * dicomViewer.zoom + dicomViewer.offset.x, p2.y * dicomViewer.zoom + dicomViewer.offset.y);
        dicomViewer.ctx.stroke();
        dicomViewer.ctx.restore();
    }

    function drawAngleLines(p1, p2, p3) {
        dicomViewer.ctx.save();
        dicomViewer.ctx.strokeStyle = 'blue';
        dicomViewer.ctx.lineWidth = 2;
        dicomViewer.ctx.beginPath();
        dicomViewer.ctx.moveTo(p1.x * dicomViewer.zoom + dicomViewer.offset.x, p1.y * dicomViewer.zoom + dicomViewer.offset.y);
        dicomViewer.ctx.lineTo(p2.x * dicomViewer.zoom + dicomViewer.offset.x, p2.y * dicomViewer.zoom + dicomViewer.offset.y);
        dicomViewer.ctx.lineTo(p3.x * dicomViewer.zoom + dicomViewer.offset.x, p3.y * dicomViewer.zoom + dicomViewer.offset.y);
        dicomViewer.ctx.stroke();
        dicomViewer.ctx.restore();
    }

    function drawSurfacePolygon(points) {
        dicomViewer.ctx.save();
        dicomViewer.ctx.strokeStyle = 'green';
        dicomViewer.ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
        dicomViewer.ctx.lineWidth = 2;
        dicomViewer.ctx.beginPath();
        dicomViewer.ctx.moveTo(points[0].x * dicomViewer.zoom + dicomViewer.offset.x, points[0].y * dicomViewer.zoom + dicomViewer.offset.y);
        for (let i = 1; i < points.length; i++) {
            dicomViewer.ctx.lineTo(points[i].x * dicomViewer.zoom + dicomViewer.offset.x, points[i].y * dicomViewer.zoom + dicomViewer.offset.y);
        }
        dicomViewer.ctx.closePath();
        dicomViewer.ctx.fill();
        dicomViewer.ctx.stroke();
        dicomViewer.ctx.restore();
    }

    // Override the render method to include measurements
    const originalRender = dicomViewer.render;
    dicomViewer.render = function() {
        originalRender.call(this);
        drawAllMeasurements();
    };

    // Global function for removing measurements
    window.removeMeasurement = removeMeasurement;

    // Doping Control Result Fields Management
    function updateDopingResultFields() {
        const dopingSelect = document.getElementById('loinc_doping_panel');
        const resultFields = document.getElementById('doping-result-fields');
        const unitField = document.getElementById('doping_result_unit');
        const normalRangeField = document.getElementById('doping_normal_range');
        const thresholdField = document.getElementById('doping_threshold');

        if (dopingSelect.value) {
            resultFields.style.display = 'block';
            
            // Define doping test configurations
            const dopingConfigs = {
                // St√©ro√Ødes anabolisants
                'LOINC_11559-2_TEST': {
                    unit: 'Ratio',
                    normalRange: '0.5 - 4.0',
                    threshold: '4.0 (WADA)'
                },
                'LOINC_11559-2_NAND': {
                    unit: 'ng/mL',
                    normalRange: '< 2.0',
                    threshold: '2.0 ng/mL'
                },
                'LOINC_11559-2_STAN': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '1.0 ng/mL'
                },
                'LOINC_11559-2_METH': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '1.0 ng/mL'
                },
                'LOINC_11559-2_DECA': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '2.0 ng/mL'
                },
                'LOINC_11559-2_BOLD': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '1.0 ng/mL'
                },
                'LOINC_11559-2_TREN': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '1.0 ng/mL'
                },
                'LOINC_11559-2_OXAN': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '1.0 ng/mL'
                },
                
                // Hormones peptidiques
                'LOINC_11560-0_GH': {
                    unit: 'ng/mL',
                    normalRange: '0.1 - 10.0',
                    threshold: 'Variable selon m√©thode'
                },
                'LOINC_11560-0_IGF': {
                    unit: 'ng/mL',
                    normalRange: '100 - 300',
                    threshold: 'Variable selon m√©thode'
                },
                'LOINC_11560-0_EPO': {
                    unit: 'mIU/mL',
                    normalRange: '3.7 - 16.9',
                    threshold: 'Variable selon m√©thode'
                },
                'LOINC_11560-0_HCG': {
                    unit: 'mIU/mL',
                    normalRange: '< 5.0',
                    threshold: '5.0 mIU/mL'
                },
                'LOINC_11560-0_LH': {
                    unit: 'mIU/mL',
                    normalRange: '1.7 - 8.6',
                    threshold: 'Variable selon m√©thode'
                },
                'LOINC_11560-0_FSH': {
                    unit: 'mIU/mL',
                    normalRange: '1.5 - 12.4',
                    threshold: 'Variable selon m√©thode'
                },
                'LOINC_11560-0_ACTH': {
                    unit: 'pg/mL',
                    normalRange: '7.2 - 63.3',
                    threshold: 'Variable selon m√©thode'
                },
                'LOINC_11560-0_TSH': {
                    unit: 'ŒºIU/mL',
                    normalRange: '0.4 - 4.0',
                    threshold: 'Variable selon m√©thode'
                },
                
                // B√™ta-2 agonistes
                'LOINC_11561-8_SALB': {
                    unit: 'ng/mL',
                    normalRange: '< 100',
                    threshold: '1000 ng/mL'
                },
                'LOINC_11561-8_TERB': {
                    unit: 'ng/mL',
                    normalRange: '< 50',
                    threshold: '500 ng/mL'
                },
                'LOINC_11561-8_FORM': {
                    unit: 'ng/mL',
                    normalRange: '< 20',
                    threshold: '200 ng/mL'
                },
                'LOINC_11561-8_SALM': {
                    unit: 'ng/mL',
                    normalRange: '< 10',
                    threshold: '100 ng/mL'
                },
                'LOINC_11561-8_CLEN': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '2.0 ng/mL'
                },
                'LOINC_11561-8_FENO': {
                    unit: 'ng/mL',
                    normalRange: '< 30',
                    threshold: '300 ng/mL'
                },
                
                // Diur√©tiques
                'LOINC_11562-6_FURO': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '50 ng/mL'
                },
                'LOINC_11562-6_HCTZ': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '50 ng/mL'
                },
                'LOINC_11562-6_SPIR': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '50 ng/mL'
                },
                'LOINC_11562-6_AMIL': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '50 ng/mL'
                },
                'LOINC_11562-6_TRIAM': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '50 ng/mL'
                },
                'LOINC_11562-6_CHLOR': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '50 ng/mL'
                },
                
                // Stimulants
                'LOINC_11564-2_AMPH': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '500 ng/mL'
                },
                'LOINC_11564-2_METH': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '500 ng/mL'
                },
                'LOINC_11564-2_EPHE': {
                    unit: 'ng/mL',
                    normalRange: '< 100',
                    threshold: '1000 ng/mL'
                },
                'LOINC_11564-2_PSEU': {
                    unit: 'ng/mL',
                    normalRange: '< 100',
                    threshold: '1000 ng/mL'
                },
                'LOINC_11564-2_COCA': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '150 ng/mL'
                },
                'LOINC_11564-2_METHY': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '500 ng/mL'
                },
                'LOINC_11564-2_MODAF': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '500 ng/mL'
                },
                
                // Cannabino√Ødes
                'LOINC_11566-7_THC': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '150 ng/mL'
                },
                'LOINC_11566-7_CBD': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '150 ng/mL'
                },
                'LOINC_11566-7_CBN': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '150 ng/mL'
                },
                'LOINC_11566-7_METAB': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '150 ng/mL'
                },
                
                // Glucocortico√Ødes
                'LOINC_11567-5_PRED': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '30 ng/mL'
                },
                'LOINC_11567-5_DEXA': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '30 ng/mL'
                },
                'LOINC_11567-5_HYDRO': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '30 ng/mL'
                },
                'LOINC_11567-5_METHY': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '30 ng/mL'
                },
                'LOINC_11567-5_TRIAM': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '30 ng/mL'
                },
                'LOINC_11567-5_BETAM': {
                    unit: 'ng/mL',
                    normalRange: 'Non d√©tectable',
                    threshold: '30 ng/mL'
                }
            };

            const selectedValue = dopingSelect.value;
            const config = dopingConfigs[selectedValue];

            if (config) {
                unitField.value = config.unit;
                normalRangeField.value = config.normalRange;
                thresholdField.value = config.threshold;
            } else {
                // For general panels and methods
                unitField.value = 'Variable';
                normalRangeField.value = 'Selon substance';
                thresholdField.value = 'Selon substance';
            }
        } else {
            resultFields.style.display = 'none';
        }
    }

    // Global function for doping control
    window.updateDopingResultFields = updateDopingResultFields;

    // Blood Test Result Fields Management
    function updateBloodTestResultFields() {
        console.log('updateBloodTestResultFields called');
        const bloodTestSelect = document.getElementById('blood_test_panel');
        const resultFields = document.getElementById('blood-test-result-fields');
        const unitField = document.getElementById('blood_test_result_unit');
        const normalRangeField = document.getElementById('blood_test_normal_range');
        const referenceField = document.getElementById('blood_test_reference');
        
        console.log('Selected value:', bloodTestSelect.value);

        if (bloodTestSelect.value) {
            resultFields.style.display = 'block';
            
            // Define blood test configurations
            const bloodTestConfigs = {
                // H√©matologie
                'LOINC_58410-2_CBC': {
                    unit: 'K/ŒºL',
                    normalRange: '4.5 - 11.0',
                    reference: 'CBC complet'
                },
                'LOINC_58410-2_HGB': {
                    unit: 'g/dL',
                    normalRange: '12.0 - 16.0 (F), 14.0 - 18.0 (M)',
                    reference: 'H√©moglobine'
                },
                'LOINC_58410-2_HCT': {
                    unit: '%',
                    normalRange: '36.0 - 46.0 (F), 41.0 - 50.0 (M)',
                    reference: 'H√©matocrite'
                },
                'LOINC_58410-2_RBC': {
                    unit: 'M/ŒºL',
                    normalRange: '4.2 - 5.4 (F), 4.7 - 6.1 (M)',
                    reference: 'Globules rouges'
                },
                'LOINC_58410-2_WBC': {
                    unit: 'K/ŒºL',
                    normalRange: '4.5 - 11.0',
                    reference: 'Globules blancs'
                },
                'LOINC_58410-2_PLT': {
                    unit: 'K/ŒºL',
                    normalRange: '150 - 450',
                    reference: 'Plaquettes'
                },
                'LOINC_58410-2_MCV': {
                    unit: 'fL',
                    normalRange: '80 - 100',
                    reference: 'Volume corpusculaire moyen'
                },
                'LOINC_58410-2_MCH': {
                    unit: 'pg',
                    normalRange: '27 - 33',
                    reference: 'H√©moglobine corpusculaire moyenne'
                },
                'LOINC_58410-2_MCHC': {
                    unit: 'g/dL',
                    normalRange: '32 - 36',
                    reference: 'Concentration corpusculaire moyenne en h√©moglobine'
                },
                'LOINC_58410-2_RDW': {
                    unit: '%',
                    normalRange: '11.5 - 14.5',
                    reference: 'Largeur de distribution des globules rouges'
                },
                'LOINC_58410-2_MPV': {
                    unit: 'fL',
                    normalRange: '7.5 - 11.5',
                    reference: 'Volume plaquettaire moyen'
                },
                'LOINC_58410-2_NEUT': {
                    unit: '%',
                    normalRange: '40 - 70',
                    reference: 'Neutrophiles'
                },
                'LOINC_58410-2_LYMPH': {
                    unit: '%',
                    normalRange: '20 - 40',
                    reference: 'Lymphocytes'
                },
                'LOINC_58410-2_MONO': {
                    unit: '%',
                    normalRange: '2 - 8',
                    reference: 'Monocytes'
                },
                'LOINC_58410-2_EOS': {
                    unit: '%',
                    normalRange: '1 - 4',
                    reference: '√âosinophiles'
                },
                'LOINC_58410-2_BASO': {
                    unit: '%',
                    normalRange: '0.5 - 1',
                    reference: 'Basophiles'
                },
                
                // Biochimie
                'LOINC_58409-4_GLU': {
                    unit: 'mg/dL',
                    normalRange: '70 - 100 (√† jeun)',
                    reference: 'Glucose'
                },
                'LOINC_58409-4_CREA': {
                    unit: 'mg/dL',
                    normalRange: '0.6 - 1.2 (F), 0.8 - 1.3 (M)',
                    reference: 'Cr√©atinine'
                },
                'LOINC_58409-4_BUN': {
                    unit: 'mg/dL',
                    normalRange: '7 - 20',
                    reference: 'Azote ur√©ique sanguin'
                },
                'LOINC_58409-4_NA': {
                    unit: 'mEq/L',
                    normalRange: '135 - 145',
                    reference: 'Sodium'
                },
                'LOINC_58409-4_K': {
                    unit: 'mEq/L',
                    normalRange: '3.5 - 5.0',
                    reference: 'Potassium'
                },
                'LOINC_58409-4_CL': {
                    unit: 'mEq/L',
                    normalRange: '96 - 106',
                    reference: 'Chlore'
                },
                'LOINC_58409-4_CO2': {
                    unit: 'mEq/L',
                    normalRange: '22 - 28',
                    reference: 'CO2 total'
                },
                'LOINC_58409-4_CA': {
                    unit: 'mg/dL',
                    normalRange: '8.5 - 10.5',
                    reference: 'Calcium'
                },
                'LOINC_58409-4_PHOS': {
                    unit: 'mg/dL',
                    normalRange: '2.5 - 4.5',
                    reference: 'Phosphore'
                },
                'LOINC_58409-4_MG': {
                    unit: 'mg/dL',
                    normalRange: '1.5 - 2.5',
                    reference: 'Magn√©sium'
                },
                'LOINC_58409-4_UA': {
                    unit: 'mg/dL',
                    normalRange: '2.4 - 6.0 (F), 3.4 - 7.0 (M)',
                    reference: 'Acide urique'
                },
                'LOINC_58409-4_LDH': {
                    unit: 'U/L',
                    normalRange: '140 - 280',
                    reference: 'Lactate d√©shydrog√©nase'
                },
                'LOINC_58409-4_CPK': {
                    unit: 'U/L',
                    normalRange: '30 - 200',
                    reference: 'Cr√©atine phosphokinase'
                },
                
                // Lipides
                'LOINC_58408-6_CHOL': {
                    unit: 'mg/dL',
                    normalRange: '< 200',
                    reference: 'Cholest√©rol total'
                },
                'LOINC_58408-6_HDL': {
                    unit: 'mg/dL',
                    normalRange: '> 40 (M), > 50 (F)',
                    reference: 'HDL-cholest√©rol'
                },
                'LOINC_58408-6_LDL': {
                    unit: 'mg/dL',
                    normalRange: '< 100 (optimal)',
                    reference: 'LDL-cholest√©rol'
                },
                'LOINC_58408-6_TRIG': {
                    unit: 'mg/dL',
                    normalRange: '< 150',
                    reference: 'Triglyc√©rides'
                },
                'LOINC_58408-6_APOA': {
                    unit: 'mg/dL',
                    normalRange: '110 - 200',
                    reference: 'Apolipoprot√©ine A'
                },
                'LOINC_58408-6_APOB': {
                    unit: 'mg/dL',
                    normalRange: '60 - 130',
                    reference: 'Apolipoprot√©ine B'
                },
                'LOINC_58408-6_LP': {
                    unit: 'mg/dL',
                    normalRange: '< 30',
                    reference: 'Lipoprot√©ine (a)'
                },
                'LOINC_58408-6_NONHDL': {
                    unit: 'mg/dL',
                    normalRange: '< 130',
                    reference: 'Cholest√©rol non-HDL'
                },
                'LOINC_58408-6_RATIO': {
                    unit: 'Ratio',
                    normalRange: '< 5.0',
                    reference: 'Ratio cholest√©rol total/HDL'
                },
                
                // Enzymes h√©patiques
                'LOINC_58408-6_ALT': {
                    unit: 'U/L',
                    normalRange: '7 - 55',
                    reference: 'Alanine aminotransf√©rase'
                },
                'LOINC_58408-6_AST': {
                    unit: 'U/L',
                    normalRange: '8 - 48',
                    reference: 'Aspartate aminotransf√©rase'
                },
                'LOINC_58408-6_ALP': {
                    unit: 'U/L',
                    normalRange: '44 - 147',
                    reference: 'Phosphatase alcaline'
                },
                'LOINC_58408-6_GGT': {
                    unit: 'U/L',
                    normalRange: '9 - 48 (F), 12 - 64 (M)',
                    reference: 'Gamma-glutamyl transf√©rase'
                },
                'LOINC_58408-6_TBIL': {
                    unit: 'mg/dL',
                    normalRange: '0.3 - 1.2',
                    reference: 'Bilirubine totale'
                },
                'LOINC_58408-6_DBIL': {
                    unit: 'mg/dL',
                    normalRange: '0.1 - 0.3',
                    reference: 'Bilirubine directe'
                },
                'LOINC_58408-6_IBIL': {
                    unit: 'mg/dL',
                    normalRange: '0.2 - 0.9',
                    reference: 'Bilirubine indirecte'
                },
                'LOINC_58408-6_ALB': {
                    unit: 'g/dL',
                    normalRange: '3.4 - 5.4',
                    reference: 'Albumine'
                },
                'LOINC_58408-6_TP': {
                    unit: 'g/dL',
                    normalRange: '6.0 - 8.3',
                    reference: 'Prot√©ines totales'
                },
                'LOINC_58408-6_GLOB': {
                    unit: 'g/dL',
                    normalRange: '2.0 - 3.5',
                    reference: 'Globulines'
                },
                'LOINC_58408-6_AG': {
                    unit: 'Ratio',
                    normalRange: '1.1 - 2.2',
                    reference: 'Ratio albumine/globuline'
                },
                
                // Marqueurs cardiaques
                'LOINC_58408-6_TROP': {
                    unit: 'ng/mL',
                    normalRange: '< 0.04',
                    reference: 'Troponine'
                },
                'LOINC_58408-6_CK': {
                    unit: 'U/L',
                    normalRange: '30 - 200',
                    reference: 'Cr√©atine kinase'
                },
                'LOINC_58408-6_CKMB': {
                    unit: 'ng/mL',
                    normalRange: '< 5.0',
                    reference: 'Cr√©atine kinase MB'
                },
                'LOINC_58408-6_BNP': {
                    unit: 'pg/mL',
                    normalRange: '< 100',
                    reference: 'Peptide natriur√©tique de type B'
                },
                'LOINC_58408-6_NT': {
                    unit: 'pg/mL',
                    normalRange: '< 125',
                    reference: 'NT-proBNP'
                },
                'LOINC_58408-6_CRP': {
                    unit: 'mg/L',
                    normalRange: '< 3.0',
                    reference: 'Prot√©ine C r√©active'
                },
                'LOINC_58408-6_ESR': {
                    unit: 'mm/h',
                    normalRange: '0 - 20 (F), 0 - 15 (M)',
                    reference: 'Vitesse de s√©dimentation'
                },
                'LOINC_58408-6_HSCRP': {
                    unit: 'mg/L',
                    normalRange: '< 1.0',
                    reference: 'CRP ultrasensible'
                },
                'LOINC_58408-6_LPA': {
                    unit: 'mg/dL',
                    normalRange: '< 30',
                    reference: 'Lipoprot√©ine (a)'
                },
                'LOINC_58408-6_HOMOC': {
                    unit: 'Œºmol/L',
                    normalRange: '5 - 15',
                    reference: 'Homocyst√©ine'
                },
                
                // Hormones
                'LOINC_58408-6_TSH': {
                    unit: 'ŒºIU/mL',
                    normalRange: '0.4 - 4.0',
                    reference: 'TSH'
                },
                'LOINC_58408-6_T4': {
                    unit: 'ng/dL',
                    normalRange: '0.8 - 1.8',
                    reference: 'T4 libre'
                },
                'LOINC_58408-6_T3': {
                    unit: 'pg/mL',
                    normalRange: '2.3 - 4.2',
                    reference: 'T3 libre'
                },
                'LOINC_58408-6_CORT': {
                    unit: 'Œºg/dL',
                    normalRange: '6.2 - 19.4',
                    reference: 'Cortisol'
                },
                'LOINC_58408-6_INSU': {
                    unit: 'ŒºIU/mL',
                    normalRange: '3 - 25',
                    reference: 'Insuline'
                },
                'LOINC_58408-6_HBA1C': {
                    unit: '%',
                    normalRange: '4.0 - 5.6',
                    reference: 'H√©moglobine glyqu√©e'
                },
                'LOINC_58408-6_VITD': {
                    unit: 'ng/mL',
                    normalRange: '30 - 100',
                    reference: 'Vitamine D'
                },
                'LOINC_58408-6_FOL': {
                    unit: 'ng/mL',
                    normalRange: '2.0 - 20.0',
                    reference: 'Acide folique'
                },
                'LOINC_58408-6_B12': {
                    unit: 'pg/mL',
                    normalRange: '200 - 900',
                    reference: 'Vitamine B12'
                },
                'LOINC_58408-6_TEST': {
                    unit: 'ng/dL',
                    normalRange: '300 - 1000',
                    reference: 'Testost√©rone'
                },
                'LOINC_58408-6_EST': {
                    unit: 'pg/mL',
                    normalRange: '12.5 - 166 (F)',
                    reference: 'Estradiol'
                },
                'LOINC_58408-6_PROG': {
                    unit: 'ng/mL',
                    normalRange: '0.1 - 0.8 (F)',
                    reference: 'Progest√©rone'
                },
                'LOINC_58408-6_FSH': {
                    unit: 'mIU/mL',
                    normalRange: '1.5 - 12.4',
                    reference: 'FSH'
                },
                'LOINC_58408-6_LH': {
                    unit: 'mIU/mL',
                    normalRange: '1.7 - 8.6',
                    reference: 'LH'
                },
                'LOINC_58408-6_PROL': {
                    unit: 'ng/mL',
                    normalRange: '4.8 - 23.3',
                    reference: 'Prolactine'
                },
                'LOINC_58408-6_GH': {
                    unit: 'ng/mL',
                    normalRange: '0.1 - 10.0',
                    reference: 'Hormone de croissance'
                },
                'LOINC_58408-6_IGF': {
                    unit: 'ng/mL',
                    normalRange: '100 - 300',
                    reference: 'IGF-1'
                },
                
                // Marqueurs inflammatoires
                'LOINC_58408-6_IL6': {
                    unit: 'pg/mL',
                    normalRange: '< 5.0',
                    reference: 'Interleukine-6'
                },
                'LOINC_58408-6_TNF': {
                    unit: 'pg/mL',
                    normalRange: '< 8.1',
                    reference: 'TNF-Œ±'
                },
                'LOINC_58408-6_FER': {
                    unit: 'ng/mL',
                    normalRange: '13 - 150 (F), 30 - 400 (M)',
                    reference: 'Ferritine'
                },
                'LOINC_58408-6_IRON': {
                    unit: 'Œºg/dL',
                    normalRange: '60 - 170',
                    reference: 'Fer s√©rique'
                },
                'LOINC_58408-6_TIBC': {
                    unit: 'Œºg/dL',
                    normalRange: '240 - 450',
                    reference: 'Capacit√© totale de fixation du fer'
                },
                'LOINC_58408-6_UIBC': {
                    unit: 'Œºg/dL',
                    normalRange: '111 - 343',
                    reference: 'Capacit√© de fixation du fer non satur√©e'
                },
                'LOINC_58408-6_SAT': {
                    unit: '%',
                    normalRange: '20 - 50',
                    reference: 'Saturation en fer'
                },
                'LOINC_58408-6_TRANS': {
                    unit: 'mg/dL',
                    normalRange: '200 - 400',
                    reference: 'Transferrine'
                },
                'LOINC_58408-6_CERUL': {
                    unit: 'mg/dL',
                    normalRange: '20 - 60',
                    reference: 'C√©ruloplasmine'
                },
                'LOINC_58408-6_COPPER': {
                    unit: 'Œºg/dL',
                    normalRange: '70 - 140',
                    reference: 'Cuivre'
                },
                'LOINC_58408-6_ZINC': {
                    unit: 'Œºg/dL',
                    normalRange: '60 - 120',
                    reference: 'Zinc'
                },
                'LOINC_58408-6_SELEN': {
                    unit: 'Œºg/L',
                    normalRange: '70 - 150',
                    reference: 'S√©l√©nium'
                },
                
                // Marqueurs tumoraux
                'LOINC_58408-6_PSA': {
                    unit: 'ng/mL',
                    normalRange: '< 4.0',
                    reference: 'PSA'
                },
                'LOINC_58408-6_CEA': {
                    unit: 'ng/mL',
                    normalRange: '< 3.0',
                    reference: 'CEA'
                },
                'LOINC_58408-6_AFP': {
                    unit: 'ng/mL',
                    normalRange: '< 10.0',
                    reference: 'AFP'
                },
                'LOINC_58408-6_CA125': {
                    unit: 'U/mL',
                    normalRange: '< 35.0',
                    reference: 'CA 125'
                },
                'LOINC_58408-6_CA199': {
                    unit: 'U/mL',
                    normalRange: '< 37.0',
                    reference: 'CA 19-9'
                },
                'LOINC_58408-6_CA153': {
                    unit: 'U/mL',
                    normalRange: '< 30.0',
                    reference: 'CA 15-3'
                },
                'LOINC_58408-6_CA724': {
                    unit: 'U/mL',
                    normalRange: '< 6.9',
                    reference: 'CA 72-4'
                },
                'LOINC_58408-6_SCC': {
                    unit: 'ng/mL',
                    normalRange: '< 1.5',
                    reference: 'SCC'
                },
                'LOINC_58408-6_NSE': {
                    unit: 'ng/mL',
                    normalRange: '< 16.3',
                    reference: 'NSE'
                },
                'LOINC_58408-6_CYFRA': {
                    unit: 'ng/mL',
                    normalRange: '< 3.3',
                    reference: 'CYFRA 21-1'
                },
                
                // Marqueurs d'auto-immunit√©
                'LOINC_58408-6_ANA': {
                    unit: 'Titre',
                    normalRange: '< 1:40',
                    reference: 'Anticorps antinucl√©aires'
                },
                'LOINC_58408-6_RF': {
                    unit: 'IU/mL',
                    normalRange: '< 14',
                    reference: 'Facteur rhumato√Øde'
                },
                'LOINC_58408-6_CCP': {
                    unit: 'U/mL',
                    normalRange: '< 17',
                    reference: 'Peptide citrullin√© cyclique'
                },
                'LOINC_58408-6_DSDNA': {
                    unit: 'IU/mL',
                    normalRange: '< 30',
                    reference: 'Anticorps anti-ADN double brin'
                },
                'LOINC_58408-6_SM': {
                    unit: 'U/mL',
                    normalRange: '< 20',
                    reference: 'Anticorps anti-Sm'
                },
                'LOINC_58408-6_RO': {
                    unit: 'U/mL',
                    normalRange: '< 20',
                    reference: 'Anticorps anti-Ro/SSA'
                },
                'LOINC_58408-6_LA': {
                    unit: 'U/mL',
                    normalRange: '< 20',
                    reference: 'Anticorps anti-La/SSB'
                },
                'LOINC_58408-6_ANCA': {
                    unit: 'Titre',
                    normalRange: '< 1:20',
                    reference: 'ANCA'
                },
                'LOINC_58408-6_ASMA': {
                    unit: 'Titre',
                    normalRange: '< 1:20',
                    reference: 'Anticorps anti-muscle lisse'
                },
                'LOINC_58408-6_AMA': {
                    unit: 'Titre',
                    normalRange: '< 1:20',
                    reference: 'Anticorps anti-mitochondries'
                }
            };

            const selectedValue = bloodTestSelect.value;
            const config = bloodTestConfigs[selectedValue];

            if (config) {
                unitField.value = config.unit;
                normalRangeField.value = config.normalRange;
                referenceField.value = config.reference;
            } else if (selectedValue === '58410-2' || selectedValue === '58409-4' || selectedValue === '58408-6') {
                console.log('Panel detected:', selectedValue);
                // Handle panel selections
                const panelConfigs = {
                    '58410-2': {
                        unit: 'Multiple',
                        normalRange: 'Panel complet - Voir d√©tails ci-dessous',
                        reference: 'Panel m√©tabolique complet (LOINC 58410-2)',
                        description: 'Inclut: CBC, Biochimie, Lipides, Enzymes h√©patiques',
                        tests: [
                            'H√©moglobine: 12.0-16.0 g/dL (F), 14.0-18.0 g/dL (M)',
                            'Glucose: 70-100 mg/dL (√† jeun)',
                            'Cr√©atinine: 0.6-1.2 mg/dL (F), 0.8-1.3 mg/dL (M)',
                            'Sodium: 135-145 mEq/L',
                            'Potassium: 3.5-5.0 mEq/L',
                            'Cholest√©rol total: < 200 mg/dL',
                            'HDL: > 40 mg/dL (M), > 50 mg/dL (F)',
                            'LDL: < 100 mg/dL (optimal)',
                            'Triglyc√©rides: < 150 mg/dL',
                            'ALT: 7-55 U/L',
                            'AST: 8-48 U/L',
                            'ALP: 44-147 U/L',
                            'Bilirubine totale: 0.3-1.2 mg/dL'
                        ]
                    },
                    '58409-4': {
                        unit: 'Multiple',
                        normalRange: 'Panel de base - Voir d√©tails ci-dessous',
                        reference: 'Panel m√©tabolique de base (LOINC 58409-4)',
                        description: 'Inclut: Biochimie + √âlectrolytes',
                        tests: [
                            'Glucose: 70-100 mg/dL (√† jeun)',
                            'Cr√©atinine: 0.6-1.2 mg/dL (F), 0.8-1.3 mg/dL (M)',
                            'Azote ur√©ique sanguin: 7-20 mg/dL',
                            'Sodium: 135-145 mEq/L',
                            'Potassium: 3.5-5.0 mEq/L',
                            'Chlore: 96-106 mEq/L',
                            'CO2 total: 22-28 mEq/L',
                            'Calcium: 8.5-10.5 mg/dL',
                            'Phosphore: 2.5-4.5 mg/dL',
                            'Magn√©sium: 1.5-2.5 mg/dL',
                            'Acide urique: 2.4-6.0 mg/dL (F), 3.4-7.0 mg/dL (M)',
                            'Lactate d√©shydrog√©nase: 140-280 U/L',
                            'Cr√©atine phosphokinase: 30-200 U/L'
                        ]
                    },
                    '58408-6': {
                        unit: 'Multiple',
                        normalRange: 'Panel √©tendu - Voir d√©tails ci-dessous',
                        reference: 'Panel m√©tabolique √©tendu (LOINC 58408-6)',
                        description: 'Inclut: Complet + Marqueurs cardiaques + Hormones + Marqueurs inflammatoires',
                        tests: [
                            'Tous les tests du panel complet (58410-2)',
                            'Troponine: < 0.04 ng/mL',
                            'CPK-MB: < 5.0 ng/mL',
                            'BNP: < 100 pg/mL',
                            'NT-proBNP: < 125 pg/mL',
                            'CRP: < 3.0 mg/L',
                            'CRP ultrasensible: < 1.0 mg/L',
                            'TSH: 0.4-4.0 ŒºIU/mL',
                            'T4 libre: 0.8-1.8 ng/dL',
                            'T3 libre: 2.3-4.2 pg/mL',
                            'Cortisol: 6.2-19.4 Œºg/dL',
                            'Insuline: 3-25 ŒºIU/mL',
                            'HbA1c: 4.0-5.6%',
                            'Vitamine D: 30-100 ng/mL',
                            'Testost√©rone: 300-1000 ng/dL',
                            'Ferritine: 13-150 ng/mL (F), 30-400 ng/mL (M)',
                            'Fer s√©rique: 60-170 Œºg/dL',
                            'Transferrine: 200-400 mg/dL',
                            'PSA: < 4.0 ng/mL',
                            'CEA: < 3.0 ng/mL',
                            'AFP: < 10.0 ng/mL'
                        ]
                    }
                };

                const panelConfig = panelConfigs[selectedValue];
                if (panelConfig) {
                    unitField.value = panelConfig.unit;
                    normalRangeField.value = panelConfig.normalRange;
                    referenceField.value = panelConfig.reference;
                    
                    // Show panel tests container and create dynamic test cards
                    const panelContainer = document.getElementById('panel-tests-container');
                    const panelGrid = document.getElementById('panel-tests-grid');
                    
                    console.log('Panel container found:', !!panelContainer);
                    console.log('Panel grid found:', !!panelGrid);
                    
                    if (panelContainer && panelGrid) {
                        panelContainer.style.display = 'block';
                        panelGrid.innerHTML = ''; // Clear existing cards
                        
                        // Create detailed test configurations for each panel
                        const detailedPanelTests = {
                            '58410-2': [
                                { name: 'H√©moglobine', unit: 'g/dL', normalRange: '12.0-16.0 (F), 14.0-18.0 (M)', reference: 'HGB' },
                                { name: 'H√©matocrite', unit: '%', normalRange: '36.0-46.0 (F), 41.0-50.0 (M)', reference: 'HCT' },
                                { name: 'Globules rouges', unit: 'M/ŒºL', normalRange: '4.2-5.4 (F), 4.7-6.1 (M)', reference: 'RBC' },
                                { name: 'Globules blancs', unit: 'K/ŒºL', normalRange: '4.5-11.0', reference: 'WBC' },
                                { name: 'Plaquettes', unit: 'K/ŒºL', normalRange: '150-450', reference: 'PLT' },
                                { name: 'Glucose', unit: 'mg/dL', normalRange: '70-100 (√† jeun)', reference: 'GLU' },
                                { name: 'Cr√©atinine', unit: 'mg/dL', normalRange: '0.6-1.2 (F), 0.8-1.3 (M)', reference: 'CREA' },
                                { name: 'Azote ur√©ique', unit: 'mg/dL', normalRange: '7-20', reference: 'BUN' },
                                { name: 'Sodium', unit: 'mEq/L', normalRange: '135-145', reference: 'NA' },
                                { name: 'Potassium', unit: 'mEq/L', normalRange: '3.5-5.0', reference: 'K' },
                                { name: 'Chlore', unit: 'mEq/L', normalRange: '96-106', reference: 'CL' },
                                { name: 'CO2 total', unit: 'mEq/L', normalRange: '22-28', reference: 'CO2' },
                                { name: 'Calcium', unit: 'mg/dL', normalRange: '8.5-10.5', reference: 'CA' },
                                { name: 'Phosphore', unit: 'mg/dL', normalRange: '2.5-4.5', reference: 'PHOS' },
                                { name: 'Magn√©sium', unit: 'mg/dL', normalRange: '1.5-2.5', reference: 'MG' },
                                { name: 'Cholest√©rol total', unit: 'mg/dL', normalRange: '< 200', reference: 'CHOL' },
                                { name: 'HDL', unit: 'mg/dL', normalRange: '> 40 (M), > 50 (F)', reference: 'HDL' },
                                { name: 'LDL', unit: 'mg/dL', normalRange: '< 100 (optimal)', reference: 'LDL' },
                                { name: 'Triglyc√©rides', unit: 'mg/dL', normalRange: '< 150', reference: 'TRIG' },
                                { name: 'ALT', unit: 'U/L', normalRange: '7-55', reference: 'ALT' },
                                { name: 'AST', unit: 'U/L', normalRange: '8-48', reference: 'AST' },
                                { name: 'ALP', unit: 'U/L', normalRange: '44-147', reference: 'ALP' },
                                { name: 'Bilirubine totale', unit: 'mg/dL', normalRange: '0.3-1.2', reference: 'TBIL' },
                                { name: 'Prot√©ines totales', unit: 'g/dL', normalRange: '6.0-8.3', reference: 'TP' },
                                { name: 'Albumine', unit: 'g/dL', normalRange: '3.4-5.0', reference: 'ALB' },
                                { name: 'Globulines', unit: 'g/dL', normalRange: '2.0-3.5', reference: 'GLOB' },
                                { name: 'Ratio A/G', unit: 'Ratio', normalRange: '1.1-2.2', reference: 'A/G' }
                            ],
                            '58409-4': [
                                { name: 'Glucose', unit: 'mg/dL', normalRange: '70-100 (√† jeun)', reference: 'GLU' },
                                { name: 'Cr√©atinine', unit: 'mg/dL', normalRange: '0.6-1.2 (F), 0.8-1.3 (M)', reference: 'CREA' },
                                { name: 'Azote ur√©ique', unit: 'mg/dL', normalRange: '7-20', reference: 'BUN' },
                                { name: 'Sodium', unit: 'mEq/L', normalRange: '135-145', reference: 'NA' },
                                { name: 'Potassium', unit: 'mEq/L', normalRange: '3.5-5.0', reference: 'K' },
                                { name: 'Chlore', unit: 'mEq/L', normalRange: '96-106', reference: 'CL' },
                                { name: 'CO2 total', unit: 'mEq/L', normalRange: '22-28', reference: 'CO2' },
                                { name: 'Calcium', unit: 'mg/dL', normalRange: '8.5-10.5', reference: 'CA' },
                                { name: 'Phosphore', unit: 'mg/dL', normalRange: '2.5-4.5', reference: 'PHOS' },
                                { name: 'Magn√©sium', unit: 'mg/dL', normalRange: '1.5-2.5', reference: 'MG' },
                                { name: 'Acide urique', unit: 'mg/dL', normalRange: '2.4-6.0 (F), 3.4-7.0 (M)', reference: 'UA' },
                                { name: 'Lactate d√©shydrog√©nase', unit: 'U/L', normalRange: '140-280', reference: 'LDH' },
                                { name: 'Cr√©atine phosphokinase', unit: 'U/L', normalRange: '30-200', reference: 'CPK' }
                            ],
                            '58408-6': [
                                // Include all tests from 58410-2
                                { name: 'H√©moglobine', unit: 'g/dL', normalRange: '12.0-16.0 (F), 14.0-18.0 (M)', reference: 'HGB' },
                                { name: 'Glucose', unit: 'mg/dL', normalRange: '70-100 (√† jeun)', reference: 'GLU' },
                                { name: 'Cr√©atinine', unit: 'mg/dL', normalRange: '0.6-1.2 (F), 0.8-1.3 (M)', reference: 'CREA' },
                                { name: 'Cholest√©rol total', unit: 'mg/dL', normalRange: '< 200', reference: 'CHOL' },
                                { name: 'HDL', unit: 'mg/dL', normalRange: '> 40 (M), > 50 (F)', reference: 'HDL' },
                                { name: 'LDL', unit: 'mg/dL', normalRange: '< 100 (optimal)', reference: 'LDL' },
                                { name: 'Triglyc√©rides', unit: 'mg/dL', normalRange: '< 150', reference: 'TRIG' },
                                { name: 'ALT', unit: 'U/L', normalRange: '7-55', reference: 'ALT' },
                                { name: 'AST', unit: 'U/L', normalRange: '8-48', reference: 'AST' },
                                { name: 'ALP', unit: 'U/L', normalRange: '44-147', reference: 'ALP' },
                                { name: 'Bilirubine totale', unit: 'mg/dL', normalRange: '0.3-1.2', reference: 'TBIL' },
                                // Extended tests
                                { name: 'Troponine', unit: 'ng/mL', normalRange: '< 0.04', reference: 'TROP' },
                                { name: 'CPK-MB', unit: 'ng/mL', normalRange: '< 5.0', reference: 'CPKMB' },
                                { name: 'BNP', unit: 'pg/mL', normalRange: '< 100', reference: 'BNP' },
                                { name: 'NT-proBNP', unit: 'pg/mL', normalRange: '< 125', reference: 'NTBNP' },
                                { name: 'CRP', unit: 'mg/L', normalRange: '< 3.0', reference: 'CRP' },
                                { name: 'CRP ultrasensible', unit: 'mg/L', normalRange: '< 1.0', reference: 'HSCRP' },
                                { name: 'TSH', unit: 'ŒºIU/mL', normalRange: '0.4-4.0', reference: 'TSH' },
                                { name: 'T4 libre', unit: 'ng/dL', normalRange: '0.8-1.8', reference: 'T4' },
                                { name: 'T3 libre', unit: 'pg/mL', normalRange: '2.3-4.2', reference: 'T3' },
                                { name: 'Cortisol', unit: 'Œºg/dL', normalRange: '6.2-19.4', reference: 'CORT' },
                                { name: 'Insuline', unit: 'ŒºIU/mL', normalRange: '3-25', reference: 'INSU' },
                                { name: 'HbA1c', unit: '%', normalRange: '4.0-5.6', reference: 'HBA1C' },
                                { name: 'Vitamine D', unit: 'ng/mL', normalRange: '30-100', reference: 'VITD' },
                                { name: 'Testost√©rone', unit: 'ng/dL', normalRange: '300-1000', reference: 'TEST' },
                                { name: 'Ferritine', unit: 'ng/mL', normalRange: '13-150 (F), 30-400 (M)', reference: 'FERR' },
                                { name: 'Fer s√©rique', unit: 'Œºg/dL', normalRange: '60-170', reference: 'FE' },
                                { name: 'Transferrine', unit: 'mg/dL', normalRange: '200-400', reference: 'TRANS' },
                                { name: 'PSA', unit: 'ng/mL', normalRange: '< 4.0', reference: 'PSA' },
                                { name: 'CEA', unit: 'ng/mL', normalRange: '< 3.0', reference: 'CEA' },
                                { name: 'AFP', unit: 'ng/mL', normalRange: '< 10.0', reference: 'AFP' }
                            ]
                        };
                        
                        const tests = detailedPanelTests[selectedValue] || [];
                        console.log('Tests for panel:', tests.length);
                        
                        tests.forEach((test, index) => {
                            console.log('Creating test card for:', test.name);
                            const testCard = createTestCard(test, index);
                            panelGrid.appendChild(testCard);
                        });
                    }
                    
                    // Update interpretation field with panel details
                    const interpretationField = document.getElementById('blood_test_interpretation');
                    if (interpretationField) {
                        interpretationField.value = `${panelConfig.description}\n\nTests inclus:\n${panelConfig.tests.join('\n')}`;
                    }
                }
            } else {
                // For general panels
                unitField.value = 'Variable';
                normalRangeField.value = 'Selon test';
                referenceField.value = 'Selon test';
                
                // Hide panel tests container
                const panelContainer = document.getElementById('panel-tests-container');
                if (panelContainer) {
                    panelContainer.style.display = 'none';
                }
            }
        } else {
            // Hide both result fields and panel container
            resultFields.style.display = 'none';
            const panelContainer = document.getElementById('panel-tests-container');
            if (panelContainer) {
                panelContainer.style.display = 'none';
            }
        }
    }

    // Function to create individual test cards
    function createTestCard(test, index) {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <h5 class="text-sm font-semibold text-gray-800">${test.name}</h5>
                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${test.reference}</span>
            </div>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Valeur mesur√©e</label>
                        <input 
                            type="text" 
                            name="panel_test_${index}_value" 
                            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                            placeholder="Valeur..."
                        >
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Unit√©</label>
                        <input 
                            type="text" 
                            value="${test.unit}" 
                            readonly 
                            class="w-full px-2 py-1 text-sm border border-gray-300 rounded bg-gray-50"
                        >
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Plage normale</label>
                        <input 
                            type="text" 
                            value="${test.normalRange}" 
                            readonly 
                            class="w-full px-2 py-1 text-sm border border-gray-300 rounded bg-gray-50"
                        >
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Statut</label>
                        <select 
                            name="panel_test_${index}_status" 
                            class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                        >
                            <option value="">S√©lectionner...</option>
                            <option value="normal">Normal</option>
                            <option value="high">√âlev√©</option>
                            <option value="low">Faible</option>
                            <option value="critical_high">Critiquement √©lev√©</option>
                            <option value="critical_low">Critiquement faible</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Notes</label>
                    <textarea 
                        name="panel_test_${index}_notes" 
                        rows="2" 
                        class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                        placeholder="Notes cliniques..."
                    ></textarea>
                </div>
            </div>
        `;
        return card;
    }

    // Global function for blood test control
    window.updateBloodTestResultFields = updateBloodTestResultFields;

    // AUT Fields Management
    function updateAUTFields() {
        const autSelect = document.getElementById('snomed_ct_aut');
        const autDetailsSection = document.getElementById('aut-details-section');
        
        console.log('updateAUTFields called');
        console.log('Selected AUT value:', autSelect.value);
        
        if (autSelect.value) {
            autDetailsSection.style.display = 'block';
            console.log('AUT details section shown');
        } else {
            autDetailsSection.style.display = 'none';
            console.log('AUT details section hidden');
        }
    }

    // Function to download IAAF Therapeutic Use Exemptions Application Form
    function downloadIAAFForm() {
        // Create a simple IAAF form template
        const formContent = `
IAAF THERAPEUTIC USE EXEMPTIONS APPLICATION FORM

SECTION 1: ATHLETE INFORMATION
Name: _________________________________
Date of Birth: _________________________
Nationality: ___________________________
Sport/Event: ___________________________
Federation: ____________________________

SECTION 2: MEDICAL INFORMATION
Diagnosis: ____________________________
Substance Requested: __________________
Dosage: ______________________________
Duration of Treatment: ________________

SECTION 3: MEDICAL JUSTIFICATION
Please provide detailed medical justification for the use of the prohibited substance:

_________________________________________________________________
_________________________________________________________________
_________________________________________________________________

SECTION 4: SUPPORTING DOCUMENTATION
- Medical reports
- Laboratory results
- Specialist consultations
- Previous treatment history

SECTION 5: DECLARATION
I declare that the information provided is accurate and complete.

Signature: ___________________________ Date: ________________
        `;
        
        // Create a blob and download
        const blob = new Blob([formContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'IAAF_Therapeutic_Use_Exemptions_Form.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('IAAF form download initiated');
    }

    } catch (error) {
        console.error('Error in first JavaScript section:', error);
    }

    // Global functions
    window.updateAUTFields = updateAUTFields;
    window.downloadIAAFForm = downloadIAAFForm;

    // Dental Chart Functionality
    let teethStatus = {};
    let dentalTooltip = {
        visible: false,
        x: 0,
        y: 0,
        toothNumber: '',
        status: '',
        condition: ''
    };

    // Initialize dental chart
    function initializeDentalChart() {
        // Initialize teeth status for all 32 teeth
        for (let i = 1; i <= 32; i++) {
            teethStatus[i] = {
                status: 'healthy',
                condition: 'Normal',
                surfaces: {
                    mesial: { condition: 'healthy', status: 'healthy' },
                    distal: { condition: 'healthy', status: 'healthy' },
                    occlusal: { condition: 'healthy', status: 'healthy' },
                    lingual: { condition: 'healthy', status: 'healthy' },
                    buccal: { condition: 'healthy', status: 'healthy' }
                },
                notes: ''
            };
        }
        
        // Load dental chart SVG
        loadDentalChart();
        updateDentalSummary();
    }

    // Load dental chart SVG
    function loadDentalChart() {
        console.log('Looking for dental chart container...');
        const chartContainer = document.getElementById('dental-svg-container');
        console.log('Chart container found:', !!chartContainer);
        
        if (!chartContainer) {
            console.error('Dental chart container not found');
            console.log('Available elements with dental in ID:', document.querySelectorAll('[id*="dental"]').length);
            return;
        }

        console.log('Loading dental chart SVG...');
        // Generate dental chart SVG
        const dentalChartSvg = generateDentalChartSvg();
        chartContainer.innerHTML = dentalChartSvg;
        console.log('Dental chart SVG loaded');
    }

    // Generate dental chart SVG
    function generateDentalChartSvg() {
        return `
            <svg width="800" height="400" viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <style>
                        .tooth { cursor: pointer; transition: fill 0.2s ease; }
                        .tooth-surface { cursor: pointer; transition: fill 0.2s ease; }
                        .status-healthy { fill: #ffffff; stroke: #cccccc; }
                        .status-caries { fill: #ff4d4d; }
                        .status-restoration { fill: #4d94ff; }
                        .status-crown { stroke: #4d94ff; stroke-width: 3px; fill-opacity: 0.1; }
                        .status-missing { fill: #808080; opacity: 0.5; }
                    </style>
                </defs>
                
                <!-- Upper teeth (1-16) -->
                <g id="upper-teeth">
                    ${generateTeethRow(1, 16, 50, 100, 'upper')}
                </g>
                
                <!-- Lower teeth (17-32) -->
                <g id="lower-teeth">
                    ${generateTeethRow(17, 32, 50, 300, 'lower')}
                </g>
                
                <!-- Labels -->
                <text x="400" y="30" text-anchor="middle" font-size="16" font-weight="bold">Dentition Sup√©rieure</text>
                <text x="400" y="370" text-anchor="middle" font-size="16" font-weight="bold">Dentition Inf√©rieure</text>
            </svg>
        `;
    }

    // Generate teeth row
    function generateTeethRow(start, end, y, baseY, position) {
        let svg = '';
        const teeth = end - start + 1;
        const spacing = 700 / teeth;
        
        for (let i = 0; i < teeth; i++) {
            const toothNumber = start + i;
            const x = 50 + (i * spacing);
            
            // Main tooth
            svg += `
                <g id="tooth-${toothNumber}" class="tooth">
                    <rect 
                        id="tooth-${toothNumber}-main"
                        x="${x}" y="${baseY}" 
                        width="40" height="60" 
                        rx="5" 
                        class="tooth-surface status-healthy"
                        data-tooth="${toothNumber}"
                    />
                    <text 
                        x="${x + 20}" y="${baseY + 35}" 
                        text-anchor="middle" 
                        font-size="12" 
                        font-weight="bold"
                    >${toothNumber}</text>
                </g>
            `;
        }
        
        return svg;
    }



    // Hide dental tooltip
    function hideDentalTooltip() {
        dentalTooltip.visible = false;
        hideDentalTooltipElement();
    }

    // Show dental tooltip
    function showDentalTooltip() {
        const tooltip = document.getElementById('dental-tooltip');
        if (tooltip && dentalTooltip.visible) {
            tooltip.style.left = dentalTooltip.x + 'px';
            tooltip.style.top = dentalTooltip.y + 'px';
            tooltip.style.display = 'block';
            
            const toothNumberElement = document.getElementById('tooltip-tooth-number');
            const statusElement = document.getElementById('tooltip-status');
            const conditionElement = document.getElementById('tooltip-condition');
            
            if (toothNumberElement) toothNumberElement.textContent = `Dent ${dentalTooltip.toothNumber}`;
            if (statusElement) statusElement.textContent = dentalTooltip.status;
            if (conditionElement) conditionElement.textContent = dentalTooltip.condition;
        }
    }

    // Hide dental tooltip element
    function hideDentalTooltipElement() {
        const tooltip = document.getElementById('dental-tooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }

    // Cycle tooth status
    function cycleToothStatus(toothNumber) {
        const statuses = ['healthy', 'caries', 'restoration', 'missing'];
        const currentStatus = teethStatus[toothNumber].status;
        const currentIndex = statuses.indexOf(currentStatus);
        const nextIndex = (currentIndex + 1) % statuses.length;
        const newStatus = statuses[nextIndex];
        
        teethStatus[toothNumber].status = newStatus;
        teethStatus[toothNumber].condition = getDentalConditionLabel(newStatus);
    }

    // Get dental condition label
    function getDentalConditionLabel(status) {
        const labels = {
            'healthy': 'Normal',
            'caries': 'Carie',
            'restoration': 'Restauration',
            'missing': 'Manquante'
        };
        return labels[status] || 'Normal';
    }

    // Update dental chart styles
    function updateDentalChartStyles() {
        Object.keys(teethStatus).forEach(toothNumber => {
            const tooth = teethStatus[toothNumber];
            const mainElement = document.getElementById(`tooth-${toothNumber}-main`);
            
            if (mainElement) {
                mainElement.className = `tooth-surface status-${tooth.status}`;
            }
        });
    }

    // Update dental summary
    function updateDentalSummary() {
        const healthyCount = Object.values(teethStatus).filter(tooth => tooth.status === 'healthy').length;
        const cariesCount = Object.values(teethStatus).filter(tooth => tooth.status === 'caries').length;
        const restorationCount = Object.values(teethStatus).filter(tooth => tooth.status === 'restoration').length;
        const missingCount = Object.values(teethStatus).filter(tooth => tooth.status === 'missing').length;

        const healthyElement = document.getElementById('healthy-teeth-count');
        const cariesElement = document.getElementById('caries-count');
        const restorationElement = document.getElementById('restoration-count');
        const missingElement = document.getElementById('missing-teeth-count');

        if (healthyElement) healthyElement.textContent = healthyCount;
        if (cariesElement) cariesElement.textContent = cariesCount;
        if (restorationElement) restorationElement.textContent = restorationCount;
        if (missingElement) missingElement.textContent = missingCount;
    }

    // Add dental chart event listeners
    function addDentalChartEventListeners() {
        console.log('Looking for dental chart container for event listeners...');
        const chartContainer = document.getElementById('dental-svg-container');
        console.log('Chart container found for event listeners:', !!chartContainer);
        
        if (!chartContainer) {
            console.error('Dental chart container not found for event listeners');
            console.log('Available elements with dental in ID:', document.querySelectorAll('[id*="dental"]').length);
            return;
        }

        // Add click event listener for tooth status cycling
        chartContainer.addEventListener('click', function(event) {
            const target = event.target;
            const toothId = target.getAttribute('data-tooth');
            
            if (toothId) {
                const toothNumber = parseInt(toothId);
                cycleToothStatus(toothNumber);
                updateDentalChartStyles();
                updateDentalSummary();
            }
        });

        // Add mouseover event listener for tooltips
        chartContainer.addEventListener('mouseover', function(event) {
            const target = event.target;
            const toothId = target.getAttribute('data-tooth');
            
            if (toothId) {
                const toothNumber = parseInt(toothId);
                const tooth = teethStatus[toothNumber];
                
                dentalTooltip = {
                    visible: true,
                    x: event.clientX + 10,
                    y: event.clientY - 10,
                    toothNumber: toothNumber,
                    status: tooth.status,
                    condition: tooth.condition
                };
                
                showDentalTooltip();
            }
        });

        // Add mouseleave event listener to hide tooltip
        chartContainer.addEventListener('mouseleave', function() {
            hideDentalTooltip();
        });
    }

    // Initialize dental chart when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing dental chart...');
        setTimeout(function() {
            console.log('Initializing dental chart with delay...');
            initializeDentalChart();
            addDentalChartEventListeners();
            console.log('Dental chart initialization complete');
        }, 500);
    });

    // Fallback initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Fallback DOM loaded, initializing dental chart...');
            setTimeout(function() {
                initializeDentalChart();
                addDentalChartEventListeners();
            }, 1000);
        });
    } else {
        console.log('Document already loaded, initializing dental chart immediately...');
        setTimeout(function() {
            initializeDentalChart();
            addDentalChartEventListeners();
        }, 1000);
    }

    // Global dental functions
    window.hideDentalTooltip = hideDentalTooltip;

    // =============================================================================
    // POSTURAL ASSESSMENT MODULE INTEGRATION
    // =============================================================================
    
    // Initialize postural assessment component
    function initializePosturalAssessment() {
        console.log('Initializing postural assessment component...');
        
        // Postural assessment state
        const posturalState = {
            currentView: 'anterior',
            currentTool: 'marker',
            selectedColor: '#ff0000',
            showPlumbLine: false,
            markers: [],
            angles: [],
            anglePoints: [],
            markerColors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff']
        };
        
        // Initialize UI elements
        const viewSelector = document.getElementById('postural-view-selector');
        const markerTool = document.getElementById('postural-marker-tool');
        const angleTool = document.getElementById('postural-angle-tool');
        const plumbTool = document.getElementById('postural-plumb-tool');
        const clearBtn = document.getElementById('postural-clear-btn');
        const exportBtn = document.getElementById('postural-export-btn');
        const colorPalette = document.getElementById('postural-color-palette');
        const svgContent = document.getElementById('postural-svg-content');
        const annotationsSvg = document.getElementById('postural-annotations');
        
        // Load initial SVG content
        loadSvgContent();
        
        // Event listeners
        if (viewSelector) {
            viewSelector.addEventListener('change', (e) => {
                posturalState.currentView = e.target.value;
                loadSvgContent();
                updatePosturalSummary();
            });
        }
        
        if (markerTool) {
            markerTool.addEventListener('click', () => {
                setCurrentTool('marker');
            });
        }
        
        if (angleTool) {
            angleTool.addEventListener('click', () => {
                setCurrentTool('angle');
            });
        }
        
        if (plumbTool) {
            plumbTool.addEventListener('click', () => {
                togglePlumbLine();
            });
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', clearAnnotations);
        }
        
        if (exportBtn) {
            exportBtn.addEventListener('click', exportData);
        }
        
        // Color palette event listeners
        const colorButtons = colorPalette?.querySelectorAll('[data-color]');
        if (colorButtons) {
            colorButtons.forEach(button => {
                button.addEventListener('click', () => {
                    posturalState.selectedColor = button.dataset.color;
                    updateColorPalette();
                });
            });
        }
        
        // SVG click handler
        if (svgContent) {
            svgContent.addEventListener('click', handleCanvasClick);
        }
        
        // Functions
        function setCurrentTool(tool) {
            posturalState.currentTool = tool;
            
            // Update button styles
            [markerTool, angleTool, plumbTool].forEach(btn => {
                if (btn) btn.classList.remove('bg-blue-500', 'text-white');
                if (btn) btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            const activeButton = tool === 'marker' ? markerTool : 
                               tool === 'angle' ? angleTool : 
                               tool === 'plumb' ? plumbTool : null;
            
            if (activeButton) {
                activeButton.classList.remove('bg-gray-200', 'text-gray-700');
                activeButton.classList.add('bg-blue-500', 'text-white');
            }
            
            // Show/hide color palette
            if (colorPalette) {
                colorPalette.style.display = tool === 'marker' ? 'flex' : 'none';
            }
        }
        
        function togglePlumbLine() {
            posturalState.showPlumbLine = !posturalState.showPlumbLine;
            updateAnnotations();
            updatePosturalSummary();
        }
        
        function clearAnnotations() {
            posturalState.markers = [];
            posturalState.angles = [];
            posturalState.anglePoints = [];
            updateAnnotations();
            updatePosturalSummary();
            updateFormData();
        }
        
        function handleCanvasClick(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            if (posturalState.currentTool === 'marker') {
                addMarker(x, y);
            } else if (posturalState.currentTool === 'angle') {
                addAnglePoint(x, y);
            }
        }
        
        function addMarker(x, y) {
            posturalState.markers.push({
                x: x,
                y: y,
                color: posturalState.selectedColor
            });
            updateAnnotations();
            updatePosturalSummary();
            updateFormData();
        }
        
        function addAnglePoint(x, y) {
            posturalState.anglePoints.push({ x, y });
            
            if (posturalState.anglePoints.length === 3) {
                calculateAngle();
                posturalState.anglePoints = [];
            }
        }
        
        function calculateAngle() {
            const [p1, p2, p3] = posturalState.anglePoints;
            
            // Calculate vectors
            const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
            const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
            
            // Calculate angle
            const dot = v1.x * v2.x + v1.y * v2.y;
            const mag1 = Math.sqrt(v1.x * v1.x + v1.y * v1.y);
            const mag2 = Math.sqrt(v2.x * v2.x + v2.y * v2.y);
            const angle = Math.acos(dot / (mag1 * mag2)) * (180 / Math.PI);
            
            posturalState.angles.push({
                points: [...posturalState.anglePoints],
                degrees: Math.round(angle)
            });
            
            updateAnnotations();
            updatePosturalSummary();
            updateFormData();
        }
        
        function updateAnnotations() {
            if (!annotationsSvg) return;
            
            // Clear existing annotations
            annotationsSvg.innerHTML = '';
            
            // Add markers
            posturalState.markers.forEach((marker, index) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', marker.x);
                circle.setAttribute('cy', marker.y);
                circle.setAttribute('r', '8');
                circle.setAttribute('fill', marker.color);
                circle.setAttribute('stroke', '#000');
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('opacity', '0.8');
                annotationsSvg.appendChild(circle);
            });
            
            // Add angles
            posturalState.angles.forEach((angle, index) => {
                const [p1, p2, p3] = angle.points;
                
                // Lines
                const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line1.setAttribute('x1', p1.x);
                line1.setAttribute('y1', p1.y);
                line1.setAttribute('x2', p2.x);
                line1.setAttribute('y2', p2.y);
                line1.setAttribute('stroke', '#000');
                line1.setAttribute('stroke-width', '2');
                annotationsSvg.appendChild(line1);
                
                const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line2.setAttribute('x1', p2.x);
                line2.setAttribute('y1', p2.y);
                line2.setAttribute('x2', p3.x);
                line2.setAttribute('y2', p3.y);
                line2.setAttribute('stroke', '#000');
                line2.setAttribute('stroke-width', '2');
                annotationsSvg.appendChild(line2);
                
                // Angle text
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', p2.x);
                text.setAttribute('y', p2.y - 10);
                text.setAttribute('class', 'text-sm font-bold');
                text.setAttribute('fill', '#000');
                text.textContent = angle.degrees + '¬∞';
                annotationsSvg.appendChild(text);
            });
            
            // Add plumb line
            if (posturalState.showPlumbLine) {
                const plumbLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                plumbLine.setAttribute('x1', '300');
                plumbLine.setAttribute('y1', '0');
                plumbLine.setAttribute('x2', '300');
                plumbLine.setAttribute('y2', '800');
                plumbLine.setAttribute('stroke', '#000');
                plumbLine.setAttribute('stroke-width', '2');
                plumbLine.setAttribute('stroke-dasharray', '5,5');
                annotationsSvg.appendChild(plumbLine);
            }
        }
        
        function updateColorPalette() {
            const colorButtons = colorPalette?.querySelectorAll('[data-color]');
            if (colorButtons) {
                colorButtons.forEach(button => {
                    if (button.dataset.color === posturalState.selectedColor) {
                        button.classList.remove('border-gray-300');
                        button.classList.add('border-gray-800');
                    } else {
                        button.classList.remove('border-gray-800');
                        button.classList.add('border-gray-300');
                    }
                });
            }
        }
        
        function updatePosturalSummary() {
            const markersCount = document.getElementById('postural-markers-count');
            const anglesCount = document.getElementById('postural-angles-count');
            
            if (markersCount) markersCount.textContent = posturalState.markers.length;
            if (anglesCount) anglesCount.textContent = posturalState.angles.length;
            
            updateMarkersList();
            updateAnglesList();
            updateExportData();
        }
        
        function updateMarkersList() {
            const markersList = document.getElementById('postural-markers-list');
            if (!markersList) return;
            
            markersList.innerHTML = '';
            posturalState.markers.forEach((marker, index) => {
                const markerDiv = document.createElement('div');
                markerDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                markerDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${marker.color}"></div>
                        <span class="text-sm">Point ${index + 1}</span>
                    </div>
                    <button onclick="removeMarker(${index})" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
                `;
                markersList.appendChild(markerDiv);
            });
        }
        
        function updateAnglesList() {
            const anglesList = document.getElementById('postural-angles-list');
            if (!anglesList) return;
            
            anglesList.innerHTML = '';
            posturalState.angles.forEach((angle, index) => {
                const angleDiv = document.createElement('div');
                angleDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                angleDiv.innerHTML = `
                    <span class="text-sm">${angle.degrees}¬∞</span>
                    <button onclick="removeAngle(${index})" class="text-red-500 hover:text-red-700 text-sm">√ó</button>
                `;
                anglesList.appendChild(angleDiv);
            });
        }
        
        function updateExportData() {
            const exportData = document.getElementById('postural-export-data');
            if (!exportData) return;
            
            const data = {
                view: posturalState.currentView,
                markers: posturalState.markers,
                angles: posturalState.angles,
                plumbLine: posturalState.showPlumbLine
            };
            
            exportData.value = JSON.stringify(data, null, 2);
        }
        
        function updateFormData() {
            const hiddenField = document.getElementById('postural_assessment_data');
            if (hiddenField) {
                const formData = {
                    view: posturalState.currentView,
                    markers: posturalState.markers,
                    angles: posturalState.angles,
                    plumbLine: posturalState.showPlumbLine
                };
                hiddenField.value = JSON.stringify(formData);
            }
        }
        
        function loadSvgContent() {
            if (!svgContent) return;
            
            const content = {
                anterior: '<div class="text-center p-8 bg-white border-2 border-dashed border-gray-300 rounded-lg" style="width: 600px; height: 800px;"><div class="flex flex-col items-center justify-center h-full"><div class="text-6xl mb-4">üë§</div><h3 class="text-xl font-semibold text-gray-700 mb-2">Vue Ant√©rieure</h3><p class="text-gray-500 text-sm">Cliquez sur l\'image pour ajouter des marqueurs</p><p class="text-gray-500 text-sm mt-2">Utilisez les outils de la barre sup√©rieure</p></div></div>',
                posterior: '<div class="text-center p-8 bg-white border-2 border-dashed border-gray-300 rounded-lg" style="width: 600px; height: 800px;"><div class="flex flex-col items-center justify-center h-full"><div class="text-6xl mb-4">üë§</div><h3 class="text-xl font-semibold text-gray-700 mb-2">Vue Post√©rieure</h3><p class="text-gray-500 text-sm">Cliquez sur l\'image pour ajouter des marqueurs</p><p class="text-gray-500 text-sm mt-2">Utilisez les outils de la barre sup√©rieure</p></div></div>',
                lateral: '<div class="text-center p-8 bg-white border-2 border-dashed border-gray-300 rounded-lg" style="width: 600px; height: 800px;"><div class="flex flex-col items-center justify-center h-full"><div class="text-6xl mb-4">üë§</div><h3 class="text-xl font-semibold text-gray-700 mb-2">Vue Lat√©rale</h3><p class="text-gray-500 text-sm">Cliquez sur l\'image pour ajouter des marqueurs</p><p class="text-gray-500 text-sm mt-2">Utilisez les outils de la barre sup√©rieure</p></div></div>'
            };
            
            svgContent.innerHTML = content[posturalState.currentView] || '';
        }
        
        function exportData() {
            const data = {
                view: posturalState.currentView,
                markers: posturalState.markers,
                angles: posturalState.angles,
                plumbLine: posturalState.showPlumbLine
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'postural-assessment-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Global functions for remove buttons
        window.removeMarker = function(index) {
            posturalState.markers.splice(index, 1);
            updateAnnotations();
            updatePosturalSummary();
            updateFormData();
        };
        
        window.removeAngle = function(index) {
            posturalState.angles.splice(index, 1);
            updateAnnotations();
            updatePosturalSummary();
            updateFormData();
        };
        
        // Initialize
        setCurrentTool('marker');
        updatePosturalSummary();
        updateFormData();
    }

    // Initialize postural assessment when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing postural assessment...');
        setTimeout(function() {
            initializePosturalAssessment();
        }, 1000);
    });

    // Fallback initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                initializePosturalAssessment();
            }, 1500);
        });
    } else {
        setTimeout(function() {
            initializePosturalAssessment();
        }, 1500);
    }
});
</script>
@endsection 